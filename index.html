
                <!DOCTYPE html>
                <html lang="zh">
                <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>Page 1</title>
                  <style>
                    *,
                    *::before,
                    *::after {
                      box-sizing: border-box;
                      margin: 0;
                    }
                    .iframe-outer {
                      position: fixed;
                      top: 0;
                      left: 0;
                      bottom: 0;
                      right: 0;
                      display: flex;
                      justify-content: center;
                      background-color: #E0E0E0;
                    }
                    .iframe-wrapper {
                      width: 100%;
                      height: 100%;
                      margin: 0 auto;
                      transform-origin: center top;
                      flex-shrink: 0;
                    }
                    #dynamicIframe {
                      border: none;
                      width: 100%;
                      height: 100%;
                    }
                  </style>
                  <script>
                const width = 440
                const height = 956
                const resolutionRatio = width && height ? width / height : 1
                const pageNameMap = {
                  'page_1': 'Page 1'
                }
                function setIframeSize(w, h) {
                  const currentContainerRadio = w / h
                  let widthValue = w
                  let heightValue = h
                  let zoom = 1
                  if (currentContainerRadio > resolutionRatio) {
                    widthValue = h * resolutionRatio
                    heightValue = h
                  } else {
                    widthValue = w
                    heightValue = w / resolutionRatio
                  }
                  zoom = width ? widthValue / width : 1
                  return {
                    width: widthValue / zoom + 'px',
                    height: heightValue / zoom + 'px',
                    zoom,
                  }
                }
                function adjustIframeSize() {
                  const iframeWrapper = document.querySelector(".iframe-wrapper")
                  const { width, height, zoom } = setIframeSize(window.innerWidth, window.innerHeight)
                  iframeWrapper.style.height = height
                  iframeWrapper.style.width = width
                  iframeWrapper.style.transform = 'scale(' + zoom + ')'
                }
                function sanitizeFilename(name) {
                  return name.replace(/[\/:*?"<>|]/g, '_')
                }
                function handlePostMessage(event) {
                  if (!event.data) {
                    return
                  }
                  const { type, targetPageId } = event.data
                  const targetPageName = pageNameMap[targetPageId]
                  if (type === "iframeNavigation" && targetPageId && targetPageName) {
                    window.location.href = targetPageName + '.html'
                  }
                }
                window.addEventListener('message', handlePostMessage)
                window.onload = adjustIframeSize
                window.onresize = adjustIframeSize
                window.onunload = () => {
                  window.removeEventListener('message', handlePostMessage)
                }
              </script>
                </head>
                <body>
                  <div class="iframe-outer">
                    <div class="iframe-wrapper">
                      <iframe id="dynamicIframe" srcdoc='<html lang="zh" data-theme="corporate"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D Woody Home 专业安装服务管理系统</title>
    <link href="./assets/static/uxbot/daisyui@5.css" rel="stylesheet" type="text/css">
    <script src="./assets/static/uxbot/tailwind-browser@4.js"></script>
    <link href="./assets/static/uxbot/daisyui-themes.css" rel="stylesheet" type="text/css">
    <script src="./assets/3/3.1.1/iconify.min.js"></script>
     <style>
/* Apple风格简约设计 - 移动端优化 */

/* 基础字体和间距 */
body {
    font-family: -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto, &#39;Helvetica Neue&#39;, sans-serif;
    line-height: 1.6;
    letter-spacing: 0.01em;
}

/* 确保所有文字在屏幕内显示 */
* {
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    box-sizing: border-box;
}

/* 标题层级 */
h1 {
    font-size: 1.125rem;
    font-weight: 600;
    line-height: 1.4;
    letter-spacing: 0.02em;
}

h2 {
    font-size: 1rem;
    font-weight: 500;
    line-height: 1.5;
}

h3 {
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.5;
}

/* 卡片设计 */
.card {
    border-radius: 12px;
    border: 1px solid var(--color-base-300);
    background: var(--color-base-100);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.card-body {
    padding: 1.5rem;
}

/* 按钮设计 */
.btn {
    border-radius: 8px;
    font-weight: 500;
    letter-spacing: 0.01em;
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.btn-primary {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
    color: var(--color-primary-content);
}

.btn-outline {
    border: 1px solid var(--color-primary);
    color: var(--color-primary);
    background-color: transparent;
}

.btn-outline:hover {
    background-color: var(--color-primary);
    color: var(--color-primary-content);
}

/* 表单元素 */
.input, .select {
    border-radius: 8px;
    border: 1px solid var(--color-base-300);
    transition: all 0.2s ease;
    font-size: 0.875rem;
    line-height: 1.5;
}

.input:focus, .select:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

.label-text {
    font-weight: 500;
    color: var(--color-base-content);
    margin-bottom: 0.5rem;
}

/* 表格优化 */
.table {
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.875rem;
}

.table th {
    background-color: var(--color-base-200);
    font-weight: 500;
    font-size: 0.875rem;
    padding: 0.75rem 0.5rem;
    border-bottom: 1px solid var(--color-base-300);
    text-align: left;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.table td {
    padding: 0.75rem 0.5rem;
    border-bottom: 1px solid var(--color-base-300);
    vertical-align: top;
}

.table tbody tr:hover {
    background-color: var(--color-base-200);
    transition: background-color 0.2s ease;
}

.table .input {
    border: none;
    background: transparent;
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.4;
    min-height: 2rem;
    width: 100%;
    box-sizing: border-box;
}

.table .input:focus {
    background-color: var(--color-base-100);
    border: 1px solid var(--color-primary);
    border-radius: 6px;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

/* 日历样式 */
#calendarGrid > div {
    min-height: 3rem;
    padding: 0.5rem;
    font-size: 0.875rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    background-color: var(--color-base-300);
}

#calendarGrid > div:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* 假期样式 */
.calendar-holiday {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.25) 0%, rgba(239, 68, 68, 0.15) 100%);
    color: var(--color-error);
    font-weight: 500;
    border: 1px solid rgba(239, 68, 68, 0.4);
    box-shadow: 0 2px 4px rgba(239, 68, 68, 0.1);
}

/* 农历新年特殊样式 */
.calendar-holiday:has-text("农历新年") {
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.3) 0%, rgba(239, 68, 68, 0.2) 100%);
    border: 2px solid rgba(220, 38, 38, 0.5);
}

/* 今天且是假期的特殊样式 */
.calendar-today.calendar-holiday {
    background: linear-gradient(135deg, var(--color-accent) 0%, rgba(239, 68, 68, 0.4) 100%);
    color: white;
    font-weight: 700;
    border: 2px solid var(--color-accent);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* 今天样式 */
.calendar-today {
    background-color: var(--color-accent) !important;
    color: var(--color-accent-content);
    font-weight: 600;
    border: 2px solid var(--color-accent);
}

/* 有安装的日期 */
.calendar-has-installation {
    background-color: var(--color-primary) !important;
    color: var(--color-primary-content);
    font-weight: 500;
}

/* 安装地址显示 */
.installation-addresses {
    width: 100%;
    text-align: center;
    margin-top: 0.25rem;
}

.installation-addresses > div {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    padding: 0.125rem 0.25rem;
    margin: 0.125rem 0;
    font-size: 0.75rem;
    line-height: 1.2;
    word-break: break-all;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* 安装数量指示器 */
.installation-count {
    position: absolute;
    top: -0.25rem;
    right: -0.25rem;
    background-color: var(--color-error);
    color: white;
    border-radius: 50%;
    width: 1rem;
    height: 1rem;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
}

/* 密码列显示控制 */
.password-column {
    display: table-cell !important;
}

.password-field {
    color: var(--color-base-content);
    font-weight: normal;
    text-align: left;
    display: block !important;
    font-size: 0.5rem; /* 进一步缩小密码字段字体 */
}

.password-field.unlocked {
    color: var(--color-base-content);
    font-weight: normal;
    text-align: left;
    display: block !important;
    font-size: 0.5rem; /* 进一步缩小解锁状态密码字段字体 */
}

.admin-mode .password-field {
    color: var(--color-base-content);
    font-weight: normal;
    text-align: left;
    display: block !important;
    background-color: transparent !important;
    border: 1px solid rgba(59, 130, 246, 0.3) !important;
    border-radius: 6px;
    font-size: 0.5rem; /* 进一步缩小管理员模式密码字段字体 */
}

.admin-mode .password-field:focus {
    background-color: var(--color-base-100) !important;
    border-color: var(--color-primary) !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.contractor-mode .password-field {
    color: var(--color-base-content);
    opacity: 0.5;
    background-color: var(--color-base-200);
    font-size: 0.5rem; /* 进一步缩小包工模式密码字段字体 */
}

.contractor-mode .password-field.show-for-contractor {
    color: var(--color-base-content);
    opacity: 1;
    background-color: transparent;
    font-size: 0.5rem; /* 进一步缩小包工模式显示密码字段字体 */
}

/* 隐藏密码样式 */
.password-field[readonly] {
    cursor: not-allowed;
    color: var(--color-base-content);
    opacity: 0.5;
    background-color: var(--color-base-200);
    font-size: 0.5rem; /* 进一步缩小只读密码字段字体 */
}

/* 操作按钮优化 */
.copy-row-btn,
.delete-row-btn {
    border-radius: 6px;
    min-width: 2rem; /* 确保按钮最小宽度 */
}

/* 操作按钮容器优化 */
.table td .flex.gap-2.justify-center {
    gap: 0.25rem; /* 减少按钮间距 */
    justify-content: flex-start; /* 左对齐避免重叠 */
    padding-left: 0.25rem; /* 增加左边距 */
}

/* 禁用按钮样式 */
.btn-disabled {
    cursor: not-allowed !important;
    pointer-events: none;
    opacity: 0.5;
}

.btn-disabled:hover {
    transform: none !important;
    box-shadow: none !important;
}

/* 动画效果 */
.animate-shake {
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
}

/* 选中日期信息动画 */
#selectedDateInfo {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 移动端模态框优化 */
.fixed.inset-0 {
    z-index: 1000;
}

.fixed .bg-base-100 {
    max-height: 90vh;
    overflow-y: auto;
    border-radius: 12px;
    margin: 1rem;
}

/* 移动端文本区域优化 */
.textarea {
    font-family: &#39;SF Mono&#39;, &#39;Monaco&#39;, &#39;Inconsolata&#39;, &#39;Roboto Mono&#39;, monospace;
    line-height: 1.4;
    border-radius: 8px;
}

/* 滚动条优化 */
.overflow-x-auto::-webkit-scrollbar {
    height: 4px;
}

.overflow-x-auto::-webkit-scrollbar-track {
    background: var(--color-base-200);
    border-radius: 2px;
}

.overflow-x-auto::-webkit-scrollbar-thumb {
    background: var(--color-base-300);
    border-radius: 2px;
}

.overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: var(--color-base-content);
}

/* 状态指示器 */
.status-indicator {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.status-success {
    background-color: var(--color-success);
}

.status-warning {
    background-color: var(--color-warning);
}

.status-error {
    background-color: var(--color-error);
}

.status-info {
    background-color: var(--color-info);
}

/* 导入导出状态指示 */
.import-export-status {
    transition: all 0.3s ease;
    border-radius: 8px;
    padding: 0.75rem;
    margin: 0.5rem 0;
}

.import-export-status.success {
    background-color: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    color: rgb(34, 197, 94);
}

.import-export-status.error {
    background-color: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: rgb(239, 68, 68);
}

.import-export-status.warning {
    background-color: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: rgb(245, 158, 11);
}

/* 文件拖拽区域样式 */
.file-drop-zone {
    border: 2px dashed var(--color-base-300);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-drop-zone:hover {
    border-color: var(--color-primary);
    background-color: rgba(59, 130, 246, 0.05);
}

.file-drop-zone.dragover {
    border-color: var(--color-primary);
    background-color: rgba(59, 130, 246, 0.1);
    transform: scale(1.02);
}

/* 响应式优化 */
@media (max-width: 440px) {
    .card-body {
        padding: 1rem;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
    
    .table th,
    .table td {
        padding: 0.5rem;
        font-size: 0.875rem;
    }
    
    .table .input {
        font-size: 0.875rem;
        padding: 0.25rem;
    }
    
    #calendarGrid > div {
        min-height: 2.5rem;
        padding: 0.25rem;
        font-size: 0.75rem;
    }
    
    .installation-addresses > div {
        font-size: 0.625rem;
        padding: 0.125rem;
    }
    
    .installation-count {
        width: 0.875rem;
        height: 0.875rem;
        font-size: 0.625rem;
    }
}

/* 确保表格在小屏幕上完全可见 */
.table {
    min-width: 100%;
    table-layout: fixed; /* 使用固定表格布局确保列宽一致 */
    width: 100%;
}

.table th,
.table td {
    min-width: 0;
    overflow: visible; /* 允许内容显示 */
    text-overflow: clip;
    white-space: normal; /* 允许文字换行 */
    word-wrap: break-word;
    vertical-align: top; /* 顶部对齐 */
    padding: 0.75rem 0.5rem; /* 优化内边距 */
}

.table .input {
    min-width: 0;
    width: 100%;
    height: auto;
    min-height: 2rem; /* 确保最小高度 */
    padding: 0.375rem 0.5rem; /* 增加内边距 */
    line-height: 1.4;
    word-wrap: break-word;
    white-space: normal; /* 允许输入框内容换行 */
    resize: none;
}

/* 地址列宽度优化 - 占更多空间 */
.table tbody tr td:first-child,
.table thead tr th:first-child {
    width: 35%; /* 地址列占35%宽度 */
}

/* 密码列 */
.table tbody tr td:nth-child(2),
.table thead tr th:nth-child(2) {
    width: 15%; /* 密码列占15%宽度 */
}

/* 密码列表头字体 */
.table thead tr th:nth-child(2) {
    font-size: 0.75rem; /* 缩小密码列表头字体 */
}

/* 安装日期列 */
.table tbody tr td:nth-child(3),
.table thead tr th:nth-child(3) {
    width: 20%; /* 安装日期列占20%宽度 */
}

/* 安装日期列字体优化 */
.table tbody tr td:nth-child(3) .input {
    font-size: 0.625rem; /* 缩小安装日期字体 */
    line-height: 1.2;
}

.table thead tr th:nth-child(3) {
    font-size: 0.875rem; /* 放大安装日期表头字体 */
}

/* 包工列 */
.table tbody tr td:nth-child(4),
.table thead tr th:nth-child(4) {
    width: 12%; /* 包工列占12%宽度 */
}

/* 收工列 */
.table tbody tr td:nth-child(5),
.table thead tr th:nth-child(5) {
    width: 12%; /* 收工列占12%宽度 */
}

/* 操作列 */
.table tbody tr td:nth-child(6),
.table thead tr th:nth-child(6) {
    width: 11%; /* 操作列占11%宽度 */
    padding-left: 0.75rem; /* 增加左边距，避免与收工列重叠 */
}

/* 地址列字体优化 */
.table tbody tr td:first-child .input {
    font-size: 0.75rem;
    line-height: 1.3;
}

.table thead tr th:first-child {
    font-size: 0.75rem;
}

/* 移动端优化 */
@media (max-width: 440px) {
    .table th,
    .table td {
        padding: 0.5rem 0.25rem; /* 减少移动端内边距 */
        font-size: 0.75rem;
    }
    
.table .input {
        font-size: 0.75rem;
        padding: 0.25rem 0.375rem;
        min-height: 1.75rem;
    }
    
    /* 移动端地址列字体进一步缩小 */
    .table tbody tr td:first-child .input {
        font-size: 0.625rem;
        line-height: 1.2;
    }
    
    .table thead tr th:first-child {
        font-size: 0.625rem;
    }
    
    /* 移动端列宽重新分配 */
    .table tbody tr td:first-child,
    .table thead tr th:first-child {
        width: 40%; /* 移动端地址列占更多空间 */
    }
    
.table tbody tr td:nth-child(2),
    .table thead tr th:nth-child(2) {
        width: 12%; /* 密码列 */
    }
    
    /* 移动端密码列表头字体进一步缩小 */
    .table thead tr th:nth-child(2) {
        font-size: 0.625rem; /* 移动端密码列表头字体更小 */
    }
    
.table tbody tr td:nth-child(3),
    .table thead tr th:nth-child(3) {
        width: 18%; /* 安装日期列 */
    }
    
/* 移动端安装日期列字体优化 */
    .table tbody tr td:nth-child(3) .input {
        font-size: 0.5rem; /* 移动端安装日期字体进一步缩小 */
        line-height: 1.1;
    }
    
    .table thead tr th:nth-child(3) {
        font-size: 0.75rem; /* 移动端安装日期表头字体放大 */
    }
    
.table tbody tr td:nth-child(4),
    .table thead tr th:nth-child(4) {
        width: 12%; /* 包工列 */
    }
    
    .table tbody tr td:nth-child(5),
    .table thead tr th:nth-child(5) {
        width: 12%; /* 收工列 */
    }
    
    /* 移动端操作列优化 */
    .table tbody tr td:nth-child(6),
    .table thead tr th:nth-child(6) {
        width: 13%; /* 移动端操作列占更多空间 */
        padding-left: 0.5rem; /* 移动端减少左边距 */
        padding-right: 0.25rem; /* 减少右边距 */
    }
}

/* 表格行高度优化 */
.table tbody tr {
    min-height: 3rem;
}

/* 输入框焦点状态优化 */
.table .input:focus {
    background-color: var(--color-base-100);
    border: 1px solid var(--color-primary);
    border-radius: 6px;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    z-index: 10;
    position: relative;
}

/* 防止文本溢出 */
h1, h2, h3, p, span, div {
    word-break: break-word;
    overflow-wrap: break-word;
}

/* 间距系统 - 8px网格 */
.space-y-4 > * + * {
    margin-top: 1rem;
}

.space-y-3 > * + * {
    margin-top: 0.75rem;
}

.gap-4 {
    gap: 1rem;
}

.gap-3 {
    gap: 0.75rem;
}

.gap-2 {
    gap: 0.5rem;
}

/* 表格行交替背景 */
.table tbody tr:nth-child(even) {
    background-color: var(--color-base-200);
}

/* Join组件优化 */
.join .join-item {
    border-radius: 0;
}

.join .join-item:first-child {
    border-top-left-radius: 8px;
    border-bottom-left-radius: 8px;
}

.join .join-item:last-child {
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
}

/* 地址输入框样式优化 */
.address-input {
    cursor: pointer;
    transition: all 0.2s ease;
}

.address-input:hover {
    background-color: rgba(59, 130, 246, 0.05) !important;
    border-color: rgba(59, 130, 246, 0.2) !important;
}

.address-input:focus {
    cursor: text;
}

/* 密码输入框样式优化 */
.password-field {
    cursor: pointer;
    transition: all 0.2s ease;
}

.password-field:hover {
    background-color: rgba(245, 158, 11, 0.05) !important;
    border-color: rgba(245, 158, 11, 0.2) !important;
}

.password-field:focus {
    cursor: text;
}

/* 包工输入框样式优化 */
.subcontractor-input {
    cursor: pointer;
    transition: all 0.2s ease;
}

.subcontractor-input:hover {
    background-color: rgba(59, 130, 246, 0.05) !important;
    border-color: rgba(59, 130, 246, 0.2) !important;
}

.subcontractor-input:focus {
    cursor: text;
}

/* 收工输入框样式优化 */
.designer-input {
    cursor: pointer;
    transition: all 0.2s ease;
}

.designer-input:hover {
    background-color: rgba(168, 85, 247, 0.05) !important;
    border-color: rgba(168, 85, 247, 0.2) !important;
}

.designer-input:focus {
    cursor: text;
}

/* 地址详情模态框样式 */
.address-detail-modal {
    backdrop-filter: blur(4px);
}

.address-detail-modal .bg-base-100 {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* 地址显示区域样式 */
#addressDisplay {
    line-height: 1.6;
    font-family: -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto, sans-serif;
}

/* 地址编辑器样式 */
#addressEditor {
    font-family: -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto, sans-serif;
    line-height: 1.5;
    resize: vertical;
    min-height: 6rem;
}

#addressEditor:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* 模态框动画 */
.fixed.inset-0 {
    animation: modalFadeIn 0.2s ease-out;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        backdrop-filter: blur(4px);
    }
}

.fixed .bg-base-100 {
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
</style>
  <script src="./assets/static/uxbot/25_6/holder.js"></script></head>
  <body class="bg-base-100 min-h-screen">
    <div class="px-4 py-6">
      <div class="card bg-base-100 shadow-sm border border-base-300/50">
        <div class="card-body p-6 text-center">
          <h1 class="text-lg font-semibold text-base-content mb-2 tracking-wide">
            D WOODY HOME SDN BHD
          </h1>
          <p class="text-sm text-base-content/70 tracking-wide">
            专业安装服务管理系统
          </p>
        </div>
      </div>
    </div>
    <!-- 认证与筛选面板 -->
    <div class="px-4 pb-4">
      <div class="card bg-base-100 shadow-sm border border-base-300/50">
        <div id="ivzfh" class="card-body p-6 space-y-4 ivzfh spark-custom-ivzfh">
          <!-- 密码输入 -->
          <div class="form-control">
            <label class="label"><span class="label-text text-sm font-medium">密码解锁</span></label>
            <div class="flex gap-3">
              <input type="password" id="passwordInput" placeholder="输入密码解锁编辑" maxlength="8" class="input input-bordered flex-1 text-sm passwordInput spark-custom-passwordInput"><button id="unlockBtn" class="btn btn-primary px-6" onclick="checkPassword()">
                解锁
              </button>
            </div>
          </div>
          <!-- 状态信息 -->
          <div id="passwordStatus" class="text-sm text-center py-2">
            <span class="text-info">表格可查看，需密码编辑</span>
          </div>
          <!-- 预填写功能 (仅管理员解锁后可见) -->
          <div id="preFillSection" class="form-control hidden">
            <label class="label"><span class="label-text text-sm font-medium flex items-center gap-2"><span class="iconify text-primary" data-icon="heroicons:document-plus" data-width="16"></span>
                预填写项目信息
              </span></label>
            <div class="bg-primary/5 border border-primary/20 rounded-lg p-4 space-y-3">
              <div class="text-xs text-primary/80 mb-3">
                在这里预先填写项目信息，确认无误后一键添加到表格
              </div>
              <!-- 地址预填写 -->
              <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-medium">项目地址</span></label><textarea id="preFillAddress" placeholder="输入完整的项目地址..." maxlength="200" class="textarea textarea-bordered textarea-sm w-full h-20 text-sm resize-none preFillAddress spark-custom-preFillAddress"></textarea>
              </div>
              <!-- 密码预填写 -->
              <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-medium">锁具密码</span></label><input type="text" id="preFillPassword" placeholder="输入锁具密码..." maxlength="20" class="input input-bordered input-sm w-full text-sm preFillPassword spark-custom-preFillPassword">
              </div>
              <!-- 安装日期预填写 -->
              <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-medium">安装日期</span></label><input type="date" id="preFillDate" class="input input-bordered input-sm w-full text-sm">
              </div>
              <!-- 包工预填写 -->
              <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-medium">负责包工</span></label>
                <div class="flex gap-2">
                  <select id="preFillContractorSelect" class="select select-bordered select-sm flex-1 text-sm preFillContractorSelect spark-custom-preFillContractorSelect" onchange="updatePreFillContractor()">
                    <option value="">选择包工</option></select><input type="text" id="preFillContractor" placeholder="或输入包工名字" maxlength="20" class="input input-bordered input-sm flex-1 text-sm">
                </div>
              </div>
              <!-- 收工预填写 -->
              <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs font-medium">负责收工</span></label><input type="text" id="preFillDesigner" placeholder="输入收工人员名字..." maxlength="20" class="input input-bordered input-sm w-full text-sm">
              </div>
              <!-- 预设模板管理 -->
              <div class="bg-accent/10 border border-accent/30 rounded-lg p-3 mb-3">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <span class="iconify text-accent" data-icon="heroicons:bookmark-square" data-width="16"></span><span class="text-sm font-medium">预设模板管理</span>
                  </div>
                  <button id="manageTemplatesBtn" title="管理所有模板" class="btn btn-accent btn-xs" onclick="showTemplateManagementModal()">
                    <span class="iconify" data-icon="heroicons:cog-6-tooth" data-width="12"></span><span class="text-xs">管理</span>
                  </button>
                </div>
                <div class="space-y-3">
                  <!-- 模板选择和快速操作 -->
                  <div class="flex gap-2">
                    <select id="preFillTemplateSelect" class="select select-bordered select-sm flex-1 text-sm" onchange="loadPreFillTemplate()">
                      <option value="">选择预设模板</option></select><button id="loadTemplateBtn" title="加载选中的模板" class="btn btn-info btn-sm px-3" onclick="loadSelectedTemplate()">
                      <span class="iconify" data-icon="heroicons:arrow-down-tray" data-width="14"></span></button><button id="deleteTemplateBtn" title="删除选中的模板" class="btn btn-error btn-sm px-3" onclick="deletePreFillTemplate()">
                      <span class="iconify" data-icon="heroicons:trash" data-width="14"></span>
                    </button>
                  </div>
                  <!-- 保存新模板 -->
                  <div class="flex gap-2">
                    <input type="text" id="templateNameInput" placeholder="输入模板名称（如：标准安装、紧急维修等）" maxlength="30" class="input input-bordered input-sm flex-1 text-sm"><button id="saveTemplateBtn" title="将当前预填写内容保存为新模板" class="btn btn-accent btn-sm px-3" onclick="savePreFillTemplate()">
                      <span class="iconify" data-icon="heroicons:bookmark-square" data-width="14"></span><span class="text-sm">保存模板</span>
                    </button>
                  </div>
                  <!-- 模板统计信息 -->
                  <div id="templateStats" class="text-xs text-accent bg-accent/5 rounded p-2">
                    <div class="font-medium mb-1">模板说明：</div>
                    <div>• 可自由添加和删除预设模板</div>
                    <div>• 快速选择模板自动填入表单</div>
                    <div>• 适用于重复性项目或标准流程</div>
                    <div id="templateCount" class="mt-2 font-medium">
                      当前模板数量：0
                    </div>
                  </div>
                </div>
              </div>
              <!-- 操作按钮 -->
              <div class="flex gap-2 pt-2">
                <button id="addPreFilledBtn" title="将预填写的信息添加到表格" class="btn btn-primary btn-sm flex-1" onclick="addPreFilledProject()">
                  <span class="iconify" data-icon="heroicons:plus-circle" data-width="16"></span><span id="igclp" class="text-sm igclp spark-custom-igclp">添加到表格</span></button><button id="savePreFillBtn" title="保存当前预填写内容到后台" class="btn btn-success btn-sm" onclick="manualSavePreFillData()">
                  <span class="iconify" data-icon="heroicons:bookmark" data-width="16"></span><span class="text-sm">保存</span></button><button id="clearPreFillBtn" title="清空预填写内容" class="btn btn-outline btn-sm" onclick="clearPreFillForm()">
                  <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span><span class="text-sm">清空</span>
                </button>
              </div>
              <!-- 预览区域 -->
              <div id="preFillPreview" class="bg-base-200 rounded-lg p-3 mt-3 hidden">
                <div id="i279v" class="text-xs font-medium text-base-content/70 mb-2 i279v spark-custom-i279v">
                  预览信息：
                </div>
                <div id="preFillPreviewContent" class="text-sm space-y-1"></div>
              </div>
            </div>
          </div>
          <!-- 快速筛选 -->
          <div class="form-control">
            <label class="label"><span class="label-text text-sm font-medium">快速筛选</span></label>
            <div class="flex gap-3">
              <select id="quickFilter" class="select select-bordered flex-1 text-sm" onchange="applyQuickFilter()">
                <option value="">显示全部</option>
                <option value="家庆">家庆</option>
                <option value="大安">大安</option>
                <option value="啊俊">啊俊</option>
                <option value="empty">未填写包工</option></select><button id="clearFilter" title="清除筛选" class="btn btn-outline px-4" onclick="clearQuickFilter()">
                <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
              </button>
            </div>
          </div>
          <!-- 包工管理 (仅管理员可见) -->
          <div id="contractorManagement" class="form-control hidden">
            <label class="label"><span class="label-text text-sm font-medium">包工管理</span></label>
            <div class="space-y-3">
              <div class="flex gap-3">
                <input type="text" id="newContractorInput" placeholder="输入新包工名字" maxlength="10" class="input input-bordered flex-1 text-sm"><button id="addContractorBtn" title="添加新包工" class="btn btn-success px-4" onclick="addNewContractor()">
                  <span class="iconify" data-icon="heroicons:plus" data-width="16"></span>
                  添加
                </button>
              </div>
              <div class="bg-base-200 rounded-lg p-3">
                <div class="text-sm font-medium mb-2">当前包工名单：</div>
                <div id="contractorList" class="space-y-2">
                  <!-- 包工列表将在这里动态生成 -->
                </div>
              </div>
              <!-- 包工密码管理 -->
              <div class="bg-warning/10 border border-warning/30 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-3">
                  <span class="iconify text-warning" data-icon="heroicons:key" data-width="16"></span><span class="text-sm font-medium">包工密码管理</span>
                </div>
                <div class="space-y-3">
                  <div class="flex gap-3">
                    <select id="contractorPasswordSelect" class="select select-bordered flex-1 text-sm">
                      <option value="">选择要修改密码的包工</option>
                    </select>
                  </div>
                  <div class="flex gap-3">
                    <input type="text" id="newPasswordInput" placeholder="输入新密码（6-8位数字）" maxlength="8" pattern="[0-9]*" inputmode="numeric" class="input input-bordered flex-1 text-sm"><button id="changePasswordBtn" title="更改包工密码" class="btn btn-warning px-4" onclick="changeContractorPassword()">
                      <span class="iconify" data-icon="heroicons:key" data-width="16"></span>
                      更改
                    </button>
                  </div>
                  <div class="text-xs text-warning bg-warning/5 rounded p-2">
                    <div class="font-medium mb-1">密码要求：</div>
                    <div>• 仅限数字，6-8位长度</div>
                    <div>• 更改后包工需使用新密码登录</div>
                    <div>• 建议定期更换密码确保安全</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- 管理员密码管理 -->
          <div id="ig4qh" class="bg-error/10 border border-error/30 rounded-lg p-4 ig4qh spark-custom-ig4qh hidden">
            <div class="flex items-center gap-2 mb-3">
              <span class="iconify text-error" data-icon="heroicons:shield-exclamation" data-width="16"></span><span class="text-sm font-medium">管理员密码管理</span>
            </div>
            <div class="space-y-3">
              <div class="flex gap-3">
                <input type="password" id="currentAdminPasswordInput" placeholder="输入当前管理员密码" maxlength="8" class="input input-bordered flex-1 text-sm currentAdminPasswordInput spark-custom-currentAdminPasswordInput">
              </div>
              <div class="flex gap-3">
                <input type="password" id="newAdminPasswordInput" placeholder="输入新管理员密码（6-8位）" maxlength="8" class="input input-bordered flex-1 text-sm"><button id="changeAdminPasswordBtn" title="更改管理员密码" class="btn btn-error px-4" onclick="changeAdminPassword()">
                  <span class="iconify" data-icon="heroicons:shield-exclamation" data-width="16"></span>
                  更改
                </button>
              </div>
              <div class="text-xs text-error bg-error/5 rounded p-2">
                <div class="font-medium mb-1">密码要求：</div>
                <div>• 长度6-8位，可包含数字和字母</div>
                <div>• 更改后需使用新密码解锁编辑功能</div>
                <div>• 请妥善保管新密码，遗失将无法编辑数据</div>
              </div>
              <!-- 数据提取功能 -->
              <div class="bg-info/10 border border-info/30 rounded-lg p-4 mt-4">
                <div class="flex items-center gap-2 mb-3">
                  <span class="iconify text-info" data-icon="heroicons:document-text" data-width="16"></span><span class="text-sm font-medium">数据提取工具</span>
                </div>
                <div class="space-y-3">
                  <div class="grid grid-cols-1 gap-2">
                    <button id="extractDataBtn" title="提取安装日期、地址和密码信息" class="btn btn-info w-full flex items-center justify-center gap-2" onclick="extractInstallationData()">
                      <span class="iconify" data-icon="heroicons:clipboard-document-list" data-width="16"></span><span class="text-sm">提取安装数据</span></button><button id="translateDataBtn" title="提取安装数据并翻译为英文" class="btn btn-success w-full flex items-center justify-center gap-2" onclick="extractAndTranslateData()">
                      <span class="iconify" data-icon="heroicons:language" data-width="16"></span><span class="text-sm">提取并翻译英文</span>
                    </button>
                  </div>
                  <div class="text-xs text-info bg-info/5 rounded p-2">
                    <div class="font-medium mb-1">提取说明：</div>
                    <div>• 提取所有安装项目的日期、地址和密码</div>
                    <div>• 翻译功能将地址等中文内容转换为英文</div>
                    <div>• 数据将以易读格式显示和复制</div>
                    <div>• 仅管理员可使用此功能</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 数据管理 -->
    <div class="px-4 pb-4">
      <div class="card bg-base-100 shadow-sm border border-base-300/50">
        <div class="card-body p-6">
          <h3 class="text-sm font-medium mb-4">数据管理</h3>
          <div class="grid grid-cols-2 gap-4">
            <button id="exportBtn" disabled="" title="导出CSV数据备份（需管理员密码）" class="btn btn-accent btn-disabled flex items-center justify-center gap-2" style="opacity: 0.5" onclick="exportData()">
              <span class="iconify" data-icon="heroicons:arrow-down-tray" data-width="16"></span><span class="text-sm">导出</span></button><button id="importBtn" title="导入数据备份（支持JSON和CSV格式）" class="btn btn-outline btn-accent flex items-center justify-center gap-2 importBtn spark-custom-importBtn" onclick="triggerFileImport()">
              <span class="iconify" data-icon="heroicons:arrow-up-tray" data-width="16"></span><span id="i4ub8" class="text-sm i4ub8 spark-custom-i4ub8">导入</span>
            </button>
          </div>
          <input type="file" id="importFileInput" accept=".csv,text/csv,application/csv,text/comma-separated-values,.json,application/json" capture="environment" multiple="false" style="position: absolute; left: -9999px; opacity: 0;" onchange="handleSecureFileImport(event)">
        </div>
      </div>
    </div>
    <!-- 视图切换 -->
    <div class="px-4 pb-4">
      <div class="flex gap-3 justify-center">
        <button id="tableViewBtn" class="btn btn-primary flex items-center gap-2 px-6" onclick="switchToTableView()">
          <span class="iconify" data-icon="heroicons:table-cells" data-width="16"></span><span class="text-sm">表格</span></button><button id="calendarViewBtn" class="btn btn-outline btn-primary flex items-center gap-2 px-6" onclick="switchToCalendarView()">
          <span class="iconify" data-icon="heroicons:calendar-days" data-width="16"></span><span id="ix2s5i" class="text-sm ix2s5i spark-custom-ix2s5i">日历</span>
        </button>
      </div>
    </div>
    <!-- 日历视图卡 -->
    <div id="calendarSection" class="px-4 pb-4 hidden">
      <div class="card bg-base-100 shadow-sm border border-base-300/50">
        <div class="card-body p-6">
          <!-- 日历标题和导航 -->
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-medium text-base-content">安装日历</h2>
            <div class="flex items-center gap-3">
              <button id="prevMonth" class="btn btn-outline btn-sm" onclick="changeMonth(-1)">
                <span class="iconify" data-icon="heroicons:chevron-left" data-width="16"></span></button><span id="currentMonth" class="text-sm font-medium px-4 py-2 bg-base-200 rounded-lg">
                2024年1月 </span><button id="nextMonth" class="btn btn-outline btn-sm" onclick="changeMonth(1)">
                <span class="iconify" data-icon="heroicons:chevron-right" data-width="16"></span>
              </button>
            </div>
          </div>
          <!-- 日历表头 -->
          <div class="grid grid-cols-7 gap-1 mb-3">
            <div class="text-sm font-medium text-center p-3 text-base-content/70">
              日
            </div>
            <div class="text-sm font-medium text-center p-3 text-base-content/70">
              一
            </div>
            <div class="text-sm font-medium text-center p-3 text-base-content/70">
              二
            </div>
            <div class="text-sm font-medium text-center p-3 text-base-content/70">
              三
            </div>
            <div class="text-sm font-medium text-center p-3 text-base-content/70">
              四
            </div>
            <div class="text-sm font-medium text-center p-3 text-base-content/70">
              五
            </div>
            <div class="text-sm font-medium text-center p-3 text-base-content/70">
              六
            </div>
          </div>
          <!-- 日历网格 -->
          <div id="calendarGrid" class="grid grid-cols-7 gap-1 mb-6">
            <!-- 日历日期将在这里生成 -->
          </div>
          <!-- 日历图例 -->
          <div class="join w-full mb-4">
            <div class="join-item flex items-center gap-2 px-3 py-2 bg-base-200 text-sm">
              <div class="w-3 h-3 bg-primary rounded"></div>
              <span>有安装</span>
            </div>
            <div class="join-item flex items-center gap-2 px-3 py-2 bg-base-200 text-sm">
              <div class="w-3 h-3 bg-base-300 rounded"></div>
              <span>无安装</span>
            </div>
            <div class="join-item flex items-center gap-2 px-3 py-2 bg-base-200 text-sm">
              <div class="w-3 h-3 bg-accent rounded"></div>
              <span>今天</span>
            </div>
            <div class="join-item flex items-center gap-2 px-3 py-2 bg-base-200 text-sm">
              <div class="w-3 h-3 bg-error/20 border border-error/30 rounded"></div>
              <span>假期</span>
            </div>
          </div>
          <!-- 选中日期信息 -->
          <div id="selectedDateInfo" class="p-4 bg-base-200 rounded-lg hidden">
            <h3 class="text-sm font-medium mb-3">选中日期信息</h3>
            <div id="dateInstallations" class="space-y-3">
              <!-- 安装信息将在这里显示 -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 表格操作卡 -->
    <div id="tableControls" class="px-4 pb-4 hidden">
      <div class="card bg-base-100 shadow-sm border border-base-300/50">
        <div class="card-body p-6">
          <h3 class="text-sm font-medium mb-4">表格操作</h3>
          <div class="flex flex-wrap gap-3 justify-center">
            <button id="addRowBtn" class="btn btn-success flex items-center gap-2" onclick="addTableRow()">
              <span class="iconify" data-icon="heroicons:plus" data-width="16"></span><span class="text-sm">添加行</span></button><button id="deleteRowBtn" class="btn btn-error flex items-center gap-2" onclick="deleteLastRow()">
              <span class="iconify" data-icon="heroicons:minus" data-width="16"></span><span class="text-sm">删除行</span></button><button id="clearAllBtn" class="btn btn-warning flex items-center gap-2" onclick="clearAllData()">
              <span class="iconify" data-icon="heroicons:trash" data-width="16"></span><span class="text-sm">清空数据</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- 报告表格卡 -->
    <div id="tableSection" class="px-4 pb-6">
      <div class="card bg-base-100 shadow-sm border border-base-300/50">
        <div id="irerew" class="card-body p-0 irerew spark-custom-irerew">
          <div class="overflow-x-auto">
            <table class="table table-sm w-full">
              <thead>
                <tr class="border-b border-base-300 bg-base-200">
                  <th class="text-sm font-medium text-base-content p-3 text-left min-w-32">
                    地址
                  </th>
                  <th id="i5z4vd" class="text-sm font-medium text-base-content p-3 text-left min-w-12 password-column i5z4vd spark-custom-i5z4vd">
                    密码
                  </th>
                  <th id="iw88j2" class="text-sm font-medium text-base-content p-3 text-left min-w-14 iw88j2 spark-custom-iw88j2">
                    安装日期
                  </th>
                  <th class="text-sm font-medium text-base-content p-3 text-left min-w-12">
                    包工
                  </th>
                  <th class="text-sm font-medium text-base-content p-3 text-left min-w-12">
                    收工
                  </th>
                  <th class="text-sm font-medium text-base-content p-3 text-center min-w-12 hidden">
                    操作
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr class="hover:bg-base-200/50 border-b border-base-300">
                  <td class="p-3">
                    <input type="text" placeholder="输入地址" readonly="" id="i6fa16" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary address-input i6fa16 spark-custom-i6fa16" onclick="showAddressDetail(this)">
                  </td>
                  <td class="p-3 password-column">
                    <input type="text" placeholder="输入锁具" readonly="" value="" data-original-password="" id="password-field-1" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary password-field-1 spark-custom-password-field-1" onclick="showPasswordDetail(this)">
                  </td>
                  <td class="p-3">
                    <input type="text" placeholder="安装日期" readonly="" id="iwc5ui" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary install-date-input iwc5ui spark-custom-iwc5ui" onclick="showDatePickerDetail(this)">
                  </td>
                  <td class="p-3">
                    <input type="text" placeholder="包工" readonly="" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary subcontractor-input" onclick="showSubcontractorDetail(this)">
                  </td>
                  <td class="p-3">
                    <input type="text" placeholder="收工" readonly="" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary designer-input" onclick="showDesignerDetail(this)">
                  </td>
                  <td class="p-3 hidden">
                    <div class="flex gap-2 justify-center">
                      <button title="复制此行" class="btn btn-sm btn-info copy-row-btn hidden" onclick="copyRowToNew(this)">
                        <span class="iconify" data-icon="heroicons:document-duplicate" data-width="14"></span></button><button title="删除此行" class="btn btn-sm btn-error delete-row-btn hidden" onclick="deleteSpecificRow(this)">
                        <span class="iconify" data-icon="heroicons:x-mark" data-width="14"></span>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr class="hover:bg-base-200/50 bg-base-50 border-b border-base-300">
                  <td class="p-3">
                    <input type="text" placeholder="输入地址" readonly="" id="irgrli" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary address-input irgrli spark-custom-irgrli" onclick="showAddressDetail(this)">
                  </td>
                  <td class="p-3 password-column">
                    <input type="text" placeholder="输入锁具" readonly="" value="" data-original-password="" id="password-field-2" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary" onclick="showPasswordDetail(this)">
                  </td>
                  <td class="p-3">
                    <input type="text" placeholder="安装日期" readonly="" id="i49bpg" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary install-date-input i49bpg spark-custom-i49bpg" onclick="showDatePickerDetail(this)">
                  </td>
                  <td class="p-3">
                    <input type="text" placeholder="包工" readonly="" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary subcontractor-input" onclick="showSubcontractorDetail(this)">
                  </td>
                  <td class="p-3">
                    <input type="text" placeholder="收工" readonly="" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary designer-input" onclick="showDesignerDetail(this)">
                  </td>
                  <td class="p-3 hidden">
                    <div class="flex gap-2 justify-center">
                      <button title="复制此行" class="btn btn-sm btn-info copy-row-btn hidden" onclick="copyRowToNew(this)">
                        <span class="iconify" data-icon="heroicons:document-duplicate" data-width="14"></span></button><button title="删除此行" class="btn btn-sm btn-error delete-row-btn hidden" onclick="deleteSpecificRow(this)">
                        <span class="iconify" data-icon="heroicons:x-mark" data-width="14"></span>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr class="hover:bg-base-200/50 border-b border-base-300">
                  <td class="p-3">
                    <input type="text" placeholder="输入地址" readonly="" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary address-input" onclick="showAddressDetail(this)">
                  </td>
                  <td class="p-3 password-column">
                    <input type="text" placeholder="输入锁具" readonly="" value="" data-original-password="" id="password-field-3" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary" onclick="showPasswordDetail(this)">
                  </td>
                  <td class="p-3">
                    <input type="text" placeholder="安装日期" readonly="" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary install-date-input" onclick="showDatePickerDetail(this)">
                  </td>
                  <td class="p-3">
                    <input type="text" placeholder="包工" readonly="" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary subcontractor-input" onclick="showSubcontractorDetail(this)">
                  </td>
                  <td class="p-3">
                    <input type="text" placeholder="收工" readonly="" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary designer-input" onclick="showDesignerDetail(this)">
                  </td>
                  <td class="p-3 hidden">
                    <div class="flex gap-2 justify-center">
                      <button title="复制此行" class="btn btn-sm btn-info copy-row-btn hidden" onclick="copyRowToNew(this)">
                        <span class="iconify" data-icon="heroicons:document-duplicate" data-width="14"></span></button><button title="删除此行" class="btn btn-sm btn-error delete-row-btn hidden" onclick="deleteSpecificRow(this)">
                        <span class="iconify" data-icon="heroicons:x-mark" data-width="14"></span>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <script>
/* 页面功能脚本 */
let isUnlocked = false;
let isContractorMode = false;
let currentContractor = null;
let currentFilter = "";
let correctPassword = "44444444"; // 改为可变的管理员密码

// 包工密码
const contractorPasswords = {
    "898989": "家庆",
    "223344": "大安", 
    "456789": "啊俊"
};

// 包工名单管理
let contractorList = ["家庆", "大安", "啊俊"];
const contractorStorageKey = &#39;dwoody_contractor_list&#39;;

// 存储变量
let localStorageKey = &#39;dwoody_table_data&#39;;
let localStorageMetaKey = &#39;dwoody_table_meta&#39;;

// 日历相关变量
let currentCalendarDate = new Date();
let currentView = &#39;table&#39;;

// 新加坡公共假期数据
const singaporeHolidays = {
    &#39;2020&#39;: [
        { date: &#39;2020-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2020-01-25&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2020-01-26&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2020-01-27&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2020-04-10&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2020-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2020-05-07&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2020-05-24&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2020-07-31&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2020-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2020-11-14&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2020-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ],
    &#39;2021&#39;: [
        { date: &#39;2021-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2021-02-12&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2021-02-13&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2021-02-14&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2021-04-02&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2021-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2021-05-13&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2021-05-26&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2021-07-20&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2021-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2021-11-04&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2021-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ],
    &#39;2022&#39;: [
        { date: &#39;2022-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2022-02-01&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2022-02-02&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2022-02-03&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2022-04-15&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2022-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2022-05-03&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2022-05-15&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2022-07-10&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2022-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2022-10-24&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2022-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ],
    &#39;2023&#39;: [
        { date: &#39;2023-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2023-01-22&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2023-01-23&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2023-01-24&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2023-04-07&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2023-04-22&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2023-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2023-06-02&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2023-06-29&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2023-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2023-11-12&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2023-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ],
    &#39;2024&#39;: [
        { date: &#39;2024-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2024-02-10&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2024-02-11&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2024-02-12&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2024-03-29&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2024-04-10&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2024-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2024-05-22&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2024-06-17&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2024-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2024-10-31&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2024-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ],
    &#39;2025&#39;: [
        { date: &#39;2025-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2025-01-29&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2025-01-30&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2025-01-31&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2025-03-30&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2025-04-18&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2025-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2025-05-12&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2025-06-06&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2025-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2025-10-20&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2025-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ],
    &#39;2026&#39;: [
        { date: &#39;2026-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2026-02-17&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2026-02-18&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2026-02-19&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2026-03-20&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2026-04-03&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2026-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2026-05-31&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2026-05-27&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2026-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2026-11-19&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2026-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ],
    &#39;2027&#39;: [
        { date: &#39;2027-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2027-02-06&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2027-02-07&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2027-02-08&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2027-03-09&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2027-03-26&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2027-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2027-05-16&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2027-05-20&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2027-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2027-11-08&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2027-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ],
    &#39;2028&#39;: [
        { date: &#39;2028-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2028-01-26&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2028-01-27&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2028-01-28&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2028-02-26&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2028-04-14&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2028-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2028-05-04&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2028-05-08&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2028-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2028-10-26&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2028-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ],
    &#39;2029&#39;: [
        { date: &#39;2029-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2029-02-13&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2029-02-14&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2029-02-15&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2029-02-14&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2029-03-30&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2029-04-23&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2029-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2029-05-27&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2029-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2029-11-14&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2029-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ],
    &#39;2030&#39;: [
        { date: &#39;2030-01-01&#39;, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
        { date: &#39;2030-02-03&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2030-02-04&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2030-02-05&#39;, name: &#39;农历新年&#39;, nameEn: &#39;Chinese New Year&#39; },
        { date: &#39;2030-02-04&#39;, name: &#39;开斋节&#39;, nameEn: &#39;Hari Raya Puasa&#39; },
        { date: &#39;2030-04-12&#39;, name: &#39;哈芝节&#39;, nameEn: &#39;Hari Raya Haji&#39; },
        { date: &#39;2030-04-19&#39;, name: &#39;耶稣受难节&#39;, nameEn: &#39;Good Friday&#39; },
        { date: &#39;2030-05-01&#39;, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
        { date: &#39;2030-05-16&#39;, name: &#39;卫塞节&#39;, nameEn: &#39;Vesak Day&#39; },
        { date: &#39;2030-08-09&#39;, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
        { date: &#39;2030-11-03&#39;, name: &#39;屠妖节&#39;, nameEn: &#39;Deepavali&#39; },
        { date: &#39;2030-12-25&#39;, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
    ]
};

document.addEventListener(&#39;DOMContentLoaded&#39;, function() {
    // 初始化设置
    setInputsReadonly(true);
    hideAllSensitiveData();
    checkLocalStorageStatus();
    updateStorageButtonsState();
    loadContractorList();
    loadContractorPasswords();
    loadAdminPassword();
    updateQuickFilterOptions();
    
    // 添加回车键支持
    const passwordInput = document.getElementById(&#39;passwordInput&#39;);
    if (passwordInput) {
        passwordInput.addEventListener(&#39;keypress&#39;, function(e) {
            if (e.key === &#39;Enter&#39;) {
                checkPassword();
            }
        });
    }
    
    // 添加新包工输入框回车键支持
    const newContractorInput = document.getElementById(&#39;newContractorInput&#39;);
    if (newContractorInput) {
        newContractorInput.addEventListener(&#39;keypress&#39;, function(e) {
            if (e.key === &#39;Enter&#39;) {
                addNewContractor();
            }
});
    }
    
    // 添加新密码输入框回车键支持
    const newPasswordInput = document.getElementById(&#39;newPasswordInput&#39;);
    if (newPasswordInput) {
        newPasswordInput.addEventListener(&#39;keypress&#39;, function(e) {
            if (e.key === &#39;Enter&#39;) {
                changeContractorPassword();
            }
        });
        
        // 限制只能输入数字
        newPasswordInput.addEventListener(&#39;input&#39;, function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, &#39;&#39;);
});
    }
    
    // 添加管理员密码输入框回车键支持
    const currentAdminPasswordInput = document.getElementById(&#39;currentAdminPasswordInput&#39;);
    if (currentAdminPasswordInput) {
        currentAdminPasswordInput.addEventListener(&#39;keypress&#39;, function(e) {
            if (e.key === &#39;Enter&#39;) {
                document.getElementById(&#39;newAdminPasswordInput&#39;).focus();
            }
        });
    }
    
    const newAdminPasswordInput = document.getElementById(&#39;newAdminPasswordInput&#39;);
    if (newAdminPasswordInput) {
        newAdminPasswordInput.addEventListener(&#39;keypress&#39;, function(e) {
            if (e.key === &#39;Enter&#39;) {
                changeAdminPassword();
            }
        });
    }
    
    // 初始化日历
    setTimeout(() => {
        if (currentView === &#39;calendar&#39;) {
            syncCalendarWithTableDates();
            initializeCalendar();
        }
    }, 100);
});

function checkPassword() {
    const passwordInput = document.getElementById(&#39;passwordInput&#39;);
    const passwordStatus = document.getElementById(&#39;passwordStatus&#39;);
    const unlockBtn = document.getElementById(&#39;unlockBtn&#39;);
    
    if (!passwordInput || !passwordStatus || !unlockBtn) return;
    
    const enteredPassword = passwordInput.value.trim();
    
// 检查管理员密码
    if (enteredPassword === correctPassword) {
        isUnlocked = true;
        isContractorMode = false;
        currentContractor = null;
        setInputsReadonly(false);
        showTableControls(true);
        updateDeleteButtonsVisibility();
        showAllRows();
        showAllDataForAdmin();
        updateStorageButtonsState();
showContractorManagement(true);
        showAdminPasswordManagement(true);
        showPreFillSection(true);
        updateContractorPasswordSelect();
        updatePreFillContractorOptions();
        passwordStatus.innerHTML = &#39;<span class="text-success">✓ 管理员已解锁 - 显示所有数据</span>&#39;;
        unlockBtn.textContent = &#39;已解锁&#39;;
        unlockBtn.disabled = true;
        unlockBtn.classList.remove(&#39;btn-primary&#39;);
        unlockBtn.classList.add(&#39;btn-success&#39;);
        passwordInput.disabled = true;
        
        if (currentView === &#39;calendar&#39;) {
            updateCalendarData();
        }
    }
    // 检查包工密码
    else if (contractorPasswords[enteredPassword]) {
        isUnlocked = false;
        isContractorMode = true;
        currentContractor = contractorPasswords[enteredPassword];
        setInputsReadonly(true);
        showTableControls(false);
        updateDeleteButtonsVisibility();
        showDataForContractor(currentContractor);
        updateStorageButtonsState();
showContractorManagement(false);
        showAdminPasswordManagement(false);
        showPreFillSection(false);
        passwordStatus.innerHTML = `<span class="text-success">✓ ${currentContractor}已登录 - 显示${currentContractor}的项目</span>`;
        unlockBtn.textContent = &#39;已登录&#39;;
        unlockBtn.disabled = true;
        unlockBtn.classList.remove(&#39;btn-primary&#39;);
        unlockBtn.classList.add(&#39;btn-info&#39;);
        passwordInput.disabled = true;
        
        if (currentView === &#39;calendar&#39;) {
            updateCalendarData();
        }
    }
    else {
        isUnlocked = false;
        isContractorMode = false;
        currentContractor = null;
        setInputsReadonly(true);
        showTableControls(false);
        updateDeleteButtonsVisibility();
        showAllRows();
        hideAllSensitiveData();
        updateStorageButtonsState();
showContractorManagement(false);
        showAdminPasswordManagement(false);
        showPreFillSection(false);
        passwordStatus.innerHTML = &#39;<span class="text-error">✗ 密码错误</span>&#39;;
        passwordInput.value = &#39;&#39;;
        passwordInput.focus();
        
        passwordInput.classList.add(&#39;animate-shake&#39;);
        setTimeout(() => {
            passwordInput.classList.remove(&#39;animate-shake&#39;);
        }, 500);
        
        if (currentView === &#39;calendar&#39;) {
            updateCalendarData();
        }
    }
}

function setInputsReadonly(readonly) {
    const tableInputs = document.querySelectorAll(&#39;.table input[type="text"]&#39;);
    
    tableInputs.forEach(input => {
        input.readOnly = readonly;
        if (readonly) {
            input.classList.add(&#39;cursor-default&#39;);
            input.classList.remove(&#39;cursor-text&#39;);
        } else {
            input.classList.remove(&#39;cursor-default&#39;);
            input.classList.add(&#39;cursor-text&#39;);
        }
    });
}

function showTableControls(show) {
    const tableControls = document.getElementById(&#39;tableControls&#39;);
    if (tableControls) {
        if (show) {
            tableControls.classList.remove(&#39;hidden&#39;);
        } else {
            tableControls.classList.add(&#39;hidden&#39;);
        }
    }
}

function updateDeleteButtonsVisibility() {
    const deleteButtons = document.querySelectorAll(&#39;.delete-row-btn&#39;);
    const copyButtons = document.querySelectorAll(&#39;.copy-row-btn&#39;);
    const tbody = document.querySelector(&#39;.table tbody&#39;);
    
    if (!tbody) return;
    
    const totalRows = tbody.querySelectorAll(&#39;tr&#39;).length;
    
    deleteButtons.forEach(button => {
        if (isUnlocked &amp;&amp; totalRows > 1) {
            button.classList.remove(&#39;hidden&#39;);
        } else {
            button.classList.add(&#39;hidden&#39;);
        }
    });
    
    copyButtons.forEach(button => {
        if (isUnlocked) {
            button.classList.remove(&#39;hidden&#39;);
        } else {
            button.classList.add(&#39;hidden&#39;);
        }
    });
}

function showPasswordColumns(mode, contractorName = null) {
    const passwordFields = document.querySelectorAll(&#39;.password-field&#39;);
    const tableBody = document.querySelector(&#39;.table tbody&#39;);
    
    if (mode === &#39;admin&#39;) {
        showAllDataForAdmin();
    } else if (mode === &#39;contractor&#39; &amp;&amp; contractorName) {
        showDataForContractor(contractorName);
    }
}

// 管理员模式：显示所有数据
function showAllDataForAdmin() {
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    const tableBody = document.querySelector(&#39;.table tbody&#39;);
    
    if (tableBody) {
        tableBody.classList.add(&#39;admin-mode&#39;);
        tableBody.classList.remove(&#39;contractor-mode&#39;);
    }
    
    tableRows.forEach(row => {
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        
        inputs.forEach((input, index) => {
            let originalValue = &#39;&#39;;
            
            if (index === 0) { // 地址
                originalValue = input.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
            } else if (index === 1) { // 密码
                originalValue = input.getAttribute(&#39;data-original-password&#39;) || &#39;&#39;;
                input.classList.add(&#39;unlocked&#39;);
                input.classList.remove(&#39;show-for-contractor&#39;);
            } else if (index === 2) { // 安装日期
                originalValue = input.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
            } else if (index === 3) { // 包工
                originalValue = input.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
            } else if (index === 4) { // 收工
                originalValue = input.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
            }
            
            if (originalValue &amp;&amp; originalValue !== &#39;&#39; &amp;&amp; originalValue !== &#39;***&#39;) {
                input.value = originalValue;
            } else if (input.value === &#39;***&#39;) {
                input.value = &#39;&#39;;
            }
            
            input.readOnly = false;
            input.style.display = &#39;block&#39;;
            input.style.backgroundColor = &#39;transparent&#39;;
            input.style.color = &#39;var(--color-base-content)&#39;;
            
            if (index === 1) { // 密码字段特殊处理
                input.placeholder = &#39;输入锁具&#39;;
            }
        });
        
        // 显示所有行
        row.style.display = &#39;&#39;;
    });
}

// 包工模式：只显示该包工的数据
function showDataForContractor(contractorName) {
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    const tableBody = document.querySelector(&#39;.table tbody&#39;);
    
    if (tableBody) {
        tableBody.classList.add(&#39;contractor-mode&#39;);
        tableBody.classList.remove(&#39;admin-mode&#39;);
    }
    
    tableRows.forEach(row => {
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        
        if (inputs.length >= 4) {
            // 获取原始包工值来判断是否属于当前包工
            const subcontractorInput = inputs[3];
            const originalSubcontractor = subcontractorInput.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
            
            // 如果是当前包工的项目或未分配的项目，显示数据
            if (originalSubcontractor === contractorName || originalSubcontractor === &#39;&#39;) {
                inputs.forEach((input, index) => {
                    let originalValue = &#39;&#39;;
                    
                    if (index === 0) { // 地址
                        originalValue = input.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
                    } else if (index === 1) { // 密码
                        originalValue = input.getAttribute(&#39;data-original-password&#39;) || &#39;&#39;;
                        input.classList.add(&#39;show-for-contractor&#39;);
                        input.classList.remove(&#39;unlocked&#39;);
                        input.placeholder = &#39;输入锁具&#39;;
                    } else if (index === 2) { // 安装日期
                        originalValue = input.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
                    } else if (index === 3) { // 包工
                        originalValue = input.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
                    } else if (index === 4) { // 收工
                        originalValue = input.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
                    }
                    
                    if (originalValue &amp;&amp; originalValue !== &#39;&#39; &amp;&amp; originalValue !== &#39;***&#39;) {
                        input.value = originalValue;
                    } else if (input.value === &#39;***&#39;) {
                        input.value = &#39;&#39;;
                    }
                    
                    input.readOnly = false;
                    input.style.display = &#39;block&#39;;
                    input.style.backgroundColor = &#39;transparent&#39;;
                    input.style.color = &#39;var(--color-base-content)&#39;;
                });
                
                row.style.display = &#39;&#39;;
            } else {
                // 其他包工的项目，隐藏整行
                row.style.display = &#39;none&#39;;
            }
        }
    });
}

// 隐藏所有敏感数据
function hideAllSensitiveData() {
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    const tableBody = document.querySelector(&#39;.table tbody&#39;);
    
    if (tableBody) {
        tableBody.classList.remove(&#39;admin-mode&#39;, &#39;contractor-mode&#39;);
    }
    
    tableRows.forEach(row => {
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        
        inputs.forEach((input, index) => {
            // 保存当前值到原始数据属性中（如果不是***的话）
            if (input.value &amp;&amp; input.value !== &#39;***&#39;) {
                if (index === 0) { // 地址
                    input.setAttribute(&#39;data-original-value&#39;, input.value);
                } else if (index === 1) { // 密码
                    input.setAttribute(&#39;data-original-password&#39;, input.value);
                } else if (index === 2) { // 安装日期
                    input.setAttribute(&#39;data-original-value&#39;, input.value);
                } else if (index === 3) { // 包工
                    input.setAttribute(&#39;data-original-value&#39;, input.value);
                } else if (index === 4) { // 收工
                    input.setAttribute(&#39;data-original-value&#39;, input.value);
                }
            }
            
            // 获取原始值来判断是否应该显示***
            let originalValue = &#39;&#39;;
            if (index === 1) { // 密码
                originalValue = input.getAttribute(&#39;data-original-password&#39;) || &#39;&#39;;
            } else {
                originalValue = input.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
            }
            
            // 如果有原始值，显示***，否则保持空白
            if (originalValue &amp;&amp; originalValue.trim() !== &#39;&#39;) {
                input.value = &#39;***&#39;;
            } else {
                input.value = &#39;&#39;;
            }
            
            input.readOnly = true;
            input.style.display = &#39;block&#39;;
            input.style.backgroundColor = &#39;var(--color-base-200)&#39;;
            input.style.color = &#39;var(--color-base-content)&#39;;
            input.style.opacity = &#39;0.5&#39;;
            
            if (index === 1) { // 密码字段特殊处理
                input.classList.remove(&#39;unlocked&#39;, &#39;show-for-contractor&#39;);
                input.placeholder = &#39;&#39;;
            }
        });
        
        // 显示所有行
        row.style.display = &#39;&#39;;
    });
}

function hidePasswordColumns() {
    hideAllSensitiveData();
}

function filterRowsByContractor(contractorName) {
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    
    tableRows.forEach(row => {
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        if (inputs.length >= 4) {
            const subcontractorValue = inputs[3].value.trim();
            const passwordCell = row.querySelector(&#39;.password-column&#39;);
            
            if (subcontractorValue === contractorName || subcontractorValue === &#39;&#39;) {
                row.style.display = &#39;&#39;;
                if (passwordCell) {
                    passwordCell.classList.add(&#39;show-for-contractor&#39;);
                }
            } else {
                row.style.display = &#39;none&#39;;
                if (passwordCell) {
                    passwordCell.classList.remove(&#39;show-for-contractor&#39;);
                }
            }
        }
    });
}

function showAllRows() {
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    tableRows.forEach(row => {
        row.style.display = &#39;&#39;;
    });
}

function applyQuickFilter() {
    const filterSelect = document.getElementById(&#39;quickFilter&#39;);
    const filterValue = filterSelect.value;
    currentFilter = filterValue;
    
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    let visibleCount = 0;
    
    tableRows.forEach(row => {
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        if (inputs.length >= 4) {
            const subcontractorValue = inputs[3].value.trim();
            
            let shouldShow = false;
            
            if (filterValue === "") {
                shouldShow = true;
            } else if (filterValue === "empty") {
                shouldShow = subcontractorValue === "";
            } else {
                shouldShow = subcontractorValue === filterValue;
            }
            
            if (shouldShow) {
                row.style.display = &#39;&#39;;
                visibleCount++;
            } else {
                row.style.display = &#39;none&#39;;
            }
        }
    });
    
    updateFilterStatus(filterValue, visibleCount);
    
    if (currentView === &#39;calendar&#39;) {
        updateCalendarData();
    }
}

function clearQuickFilter() {
    const filterSelect = document.getElementById(&#39;quickFilter&#39;);
    filterSelect.value = "";
    currentFilter = "";
    
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    tableRows.forEach(row => {
        row.style.display = &#39;&#39;;
    });
    
    updateFilterStatus("", tableRows.length);
    
    if (currentView === &#39;calendar&#39;) {
        updateCalendarData();
    }
}

function updateFilterStatus(filterValue, visibleCount) {
    const passwordStatus = document.getElementById(&#39;passwordStatus&#39;);
    
    if (filterValue === "") {
        passwordStatus.innerHTML = &#39;<span class="text-info">表格可查看，需密码编辑</span>&#39;;
    } else if (filterValue === "empty") {
        passwordStatus.innerHTML = `<span class="text-success">筛选：未填写包工 (${visibleCount}项)</span>`;
    } else {
        passwordStatus.innerHTML = `<span class="text-success">筛选：${filterValue} (${visibleCount}项)</span>`;
    }
}

function addTableRow() {
    if (!isUnlocked) return;
    
    const tbody = document.querySelector(&#39;.table tbody&#39;);
    if (!tbody) return;
    
    const existingRows = tbody.querySelectorAll(&#39;tr&#39;);
    const isEvenRow = existingRows.length % 2 === 0;
    
    const newRow = document.createElement(&#39;tr&#39;);
    newRow.className = isEvenRow ? &#39;hover:bg-base-200/50 bg-base-50 border-b border-base-300&#39; : &#39;hover:bg-base-200/50 border-b border-base-300&#39;;
    
newRow.innerHTML = `
        <td class="p-3">
            <input type="text" placeholder="输入地址" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary address-input" onclick="showAddressDetail(this)" />
        </td>
        <td class="p-3 password-column">
            <input type="text" placeholder="输入锁具" value="" data-original-password="" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary password-field" onclick="showPasswordDetail(this)" />
        </td>
        <td class="p-3">
            <input type="text" placeholder="安装日期" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary install-date-input" onclick="showDatePickerDetail(this)" />
        </td>
        <td class="p-3">
            <input type="text" placeholder="包工" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary subcontractor-input" onclick="showSubcontractorDetail(this)" />
        </td>
        <td class="p-3">
            <input type="text" placeholder="收工" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary designer-input" onclick="showDesignerDetail(this)" />
        </td>
        <td class="p-3">
            <div class="flex gap-2 justify-center">
                <button class="btn btn-sm btn-info copy-row-btn" onclick="copyRowToNew(this)" title="复制此行">
                    <span class="iconify" data-icon="heroicons:document-duplicate" data-width="14"></span>
                </button>
                <button class="btn btn-sm btn-error delete-row-btn" onclick="deleteSpecificRow(this)" title="删除此行">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="14"></span>
                </button>
            </div>
        </td>
    `;
    
    tbody.appendChild(newRow);
    
    const newInputs = newRow.querySelectorAll(&#39;input[type="text"]&#39;);
    newInputs.forEach(input => {
        input.readOnly = !isUnlocked;
        if (isUnlocked) {
            input.classList.remove(&#39;cursor-default&#39;);
            input.classList.add(&#39;cursor-text&#39;);
        } else {
            input.classList.add(&#39;cursor-default&#39;);
            input.classList.remove(&#39;cursor-text&#39;);
        }
    });
    
    updateDeleteButtonsVisibility();
}

function deleteLastRow() {
    if (!isUnlocked) return;
    
    const tbody = document.querySelector(&#39;.table tbody&#39;);
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll(&#39;tr&#39;);
    if (rows.length > 1) {
        rows[rows.length - 1].remove();
        updateRowColors();
    }
    
    updateDeleteButtonsVisibility();
}

function deleteSpecificRow(button) {
    if (!isUnlocked) return;
    
    const row = button.closest(&#39;tr&#39;);
    const tbody = document.querySelector(&#39;.table tbody&#39;);
    
    if (!row || !tbody) return;
    
    const totalRows = tbody.querySelectorAll(&#39;tr&#39;).length;
    if (totalRows <= 1) {
        alert(&#39;至少需要保留一行数据&#39;);
        return;
    }
    
    row.style.transition = &#39;opacity 0.3s ease, transform 0.3s ease&#39;;
    row.style.opacity = &#39;0&#39;;
    row.style.transform = &#39;translateX(-20px)&#39;;
    
    setTimeout(() => {
        row.remove();
        updateRowColors();
        updateDeleteButtonsVisibility();
    }, 300);
}

function copyRowToNew(button) {
    if (!isUnlocked) return;
    
    const sourceRow = button.closest(&#39;tr&#39;);
    const tbody = document.querySelector(&#39;.table tbody&#39;);
    
    if (!sourceRow || !tbody) return;
    
    const sourceInputs = sourceRow.querySelectorAll(&#39;input[type="text"]&#39;);
    const sourceData = [];
    sourceInputs.forEach(input => {
        sourceData.push(input.value);
    });
    
    const existingRows = tbody.querySelectorAll(&#39;tr&#39;);
    const isEvenRow = existingRows.length % 2 === 0;
    
    const newRow = document.createElement(&#39;tr&#39;);
    newRow.className = isEvenRow ? &#39;hover:bg-base-200/50 bg-base-50 border-b border-base-300&#39; : &#39;hover:bg-base-200/50 border-b border-base-300&#39;;
    
newRow.innerHTML = `
        <td class="p-3">
            <input type="text" value="${sourceData[0] || &#39;&#39;}" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary address-input" onclick="showAddressDetail(this)" />
        </td>
        <td class="p-3 password-column">
            <input type="text" value="${sourceData[1] || &#39;&#39;}" data-original-password="${sourceData[1] || &#39;&#39;}" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary password-field" onclick="showPasswordDetail(this)" />
        </td>
        <td class="p-3">
            <input type="text" value="" placeholder="安装日期" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary" />
        </td>
        <td class="p-3">
            <input type="text" value="${sourceData[3] || &#39;&#39;}" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary subcontractor-input" onclick="showSubcontractorDetail(this)" />
        </td>
<td class="p-3">
                             <input type="text" value="${sourceData[4] || &#39;&#39;}" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary designer-input" onclick="showDesignerDetail(this)" />
                         </td>
        <td class="p-3">
            <div class="flex gap-2 justify-center">
                <button class="btn btn-sm btn-info copy-row-btn" onclick="copyRowToNew(this)" title="复制此行">
                    <span class="iconify" data-icon="heroicons:document-duplicate" data-width="14"></span>
                </button>
                <button class="btn btn-sm btn-error delete-row-btn" onclick="deleteSpecificRow(this)" title="删除此行">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="14"></span>
                </button>
            </div>
        </td>
    `;
    
    sourceRow.insertAdjacentElement(&#39;afterend&#39;, newRow);
    
    const newInputs = newRow.querySelectorAll(&#39;input[type="text"]&#39;);
    newInputs.forEach(input => {
        input.readOnly = !isUnlocked;
        if (isUnlocked) {
            input.classList.remove(&#39;cursor-default&#39;);
            input.classList.add(&#39;cursor-text&#39;);
        } else {
            input.classList.add(&#39;cursor-default&#39;);
            input.classList.remove(&#39;cursor-text&#39;);
        }
    });
    
    updateRowColors();
    updateDeleteButtonsVisibility();
    
    const installDateInput = newInputs[2];
    if (installDateInput) {
        installDateInput.focus();
    }
}

function updateRowColors() {
    const tbody = document.querySelector(&#39;.table tbody&#39;);
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll(&#39;tr&#39;);
    rows.forEach((row, index) => {
        row.className = index % 2 === 1 ? &#39;hover:bg-base-200/50 bg-base-50 border-b border-base-300&#39; : &#39;hover:bg-base-200/50 border-b border-base-300&#39;;
    });
}

function clearAllData() {
    if (!isUnlocked) {
        alert(&#39;请先解锁表格才能清空数据&#39;);
        return;
    }
    
    if (!confirm(&#39;确定要清空所有数据吗？此操作不可撤销。&#39;)) {
        return;
    }
    
    const tbody = document.querySelector(&#39;.table tbody&#39;);
    if (!tbody) return;
    
    tbody.innerHTML = &#39;&#39;;
    
    const newRow = document.createElement(&#39;tr&#39;);
    newRow.className = &#39;hover:bg-base-200/50 border-b border-base-300&#39;;
    
newRow.innerHTML = `
        <td class="p-3">
            <input type="text" placeholder="输入地址" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary address-input" onclick="showAddressDetail(this)" />
        </td>
        <td class="p-3 password-column">
            <input type="text" placeholder="输入锁具" value="" data-original-password="" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary password-field" onclick="showPasswordDetail(this)" />
        </td>
        <td class="p-3">
            <input type="text" placeholder="安装日期" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary install-date-input" onclick="showDatePickerDetail(this)" />
        </td>
        <td class="p-3">
            <input type="text" placeholder="包工" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary subcontractor-input" onclick="showSubcontractorDetail(this)" />
        </td>
        <td class="p-3">
            <input type="text" placeholder="收工" class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary designer-input" onclick="showDesignerDetail(this)" />
        </td>
        <td class="p-3">
            <div class="flex gap-2 justify-center">
                <button class="btn btn-sm btn-info copy-row-btn hidden" onclick="copyRowToNew(this)" title="复制此行">
                    <span class="iconify" data-icon="heroicons:document-duplicate" data-width="14"></span>
                </button>
                <button class="btn btn-sm btn-error delete-row-btn hidden" onclick="deleteSpecificRow(this)" title="删除此行">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="14"></span>
                </button>
            </div>
        </td>
    `;
    
    tbody.appendChild(newRow);
    
    const newInputs = newRow.querySelectorAll(&#39;input[type="text"]&#39;);
    newInputs.forEach(input => {
        input.readOnly = !isUnlocked;
        if (isUnlocked) {
            input.classList.remove(&#39;cursor-default&#39;);
            input.classList.add(&#39;cursor-text&#39;);
        } else {
            input.classList.add(&#39;cursor-default&#39;);
            input.classList.remove(&#39;cursor-text&#39;);
        }
    });
    
    updateDeleteButtonsVisibility();
    localStorage.removeItem(localStorageKey);
    alert(&#39;所有数据已清空&#39;);
}

function extractTableData() {
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    const data = [];
    
    tableRows.forEach(row => {
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        const rowData = [];
        inputs.forEach((input, index) => {
            // 对于密码字段（第二列），优先使用原始密码值
            if (index === 1) { // 密码列
                const originalPassword = input.getAttribute(&#39;data-original-password&#39;) || &#39;&#39;;
                const currentValue = input.value;
                // 如果当前值是***，使用原始密码；否则使用当前值
                rowData.push(currentValue === &#39;***&#39; ? originalPassword : currentValue);
            } else {
                // 对于其他字段，如果显示为***，尝试获取原始值
                const originalValue = input.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
                const currentValue = input.value;
                rowData.push(currentValue === &#39;***&#39; ? originalValue : currentValue);
            }
        });
        data.push(rowData);
    });
    
    return data;
}

function exportData() {
    if (!isUnlocked) {
        alert(&#39;请先输入管理员密码才能导出数据&#39;);
        return;
    }
    
    const exportBtn = document.getElementById(&#39;exportBtn&#39;);
    exportBtn.disabled = true;
    exportBtn.innerHTML = &#39;<span class="iconify animate-spin" data-icon="heroicons:arrow-path" data-width="16"></span>&#39;;
    
    try {
        const tableData = extractTableData();
        const headers = [&#39;地址&#39;, &#39;密码&#39;, &#39;安装日期&#39;, &#39;包工&#39;, &#39;收工&#39;];
        
        // 检查是否为移动设备
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
            // 移动端：使用Web Share API或复制到剪贴板
            exportDataForMobile(tableData, headers);
        } else {
            // 桌面端：直接下载文件
            exportDataAsFile(tableData, headers);
        }
        
    } catch (error) {
        console.error(&#39;Export failed:&#39;, error);
        alert(&#39;导出失败: &#39; + error.message);
    } finally {
        exportBtn.disabled = false;
        exportBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:arrow-down-tray" data-width="16"></span><span class="text-sm">导出</span>&#39;;
    }
}

function exportDataAsFile(tableData, headers) {
    // 构建CSV内容
    let csvContent = headers.join(&#39;,&#39;) + &#39;\n&#39;;
    
    tableData.forEach(row => {
        const csvRow = row.map(cell => {
            // 处理包含逗号、引号或换行符的字段
            const cellValue = String(cell || &#39;&#39;);
            if (cellValue.includes(&#39;,&#39;) || cellValue.includes(&#39;"&#39;) || cellValue.includes(&#39;\n&#39;)) {
                return &#39;"&#39; + cellValue.replace(/"/g, &#39;""&#39;) + &#39;"&#39;;
            }
            return cellValue;
        });
        csvContent += csvRow.join(&#39;,&#39;) + &#39;\n&#39;;
    });
    
    // 添加BOM以支持中文显示
    const BOM = &#39;\uFEFF&#39;;
    const dataBlob = new Blob([BOM + csvContent], { type: &#39;text/csv;charset=utf-8&#39; });
    
    const link = document.createElement(&#39;a&#39;);
    link.href = URL.createObjectURL(dataBlob);
    link.download = `dwoody_report_${new Date().toISOString().split(&#39;T&#39;)[0]}.csv`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert(&#39;CSV文件导出完成！&#39;);
}

function exportDataForMobile(tableData, headers) {
    // 构建CSV内容
    let csvContent = headers.join(&#39;,&#39;) + &#39;\n&#39;;
    
    tableData.forEach(row => {
        const csvRow = row.map(cell => {
            const cellValue = String(cell || &#39;&#39;);
            if (cellValue.includes(&#39;,&#39;) || cellValue.includes(&#39;"&#39;) || cellValue.includes(&#39;\n&#39;)) {
                return &#39;"&#39; + cellValue.replace(/"/g, &#39;""&#39;) + &#39;"&#39;;
            }
            return cellValue;
        });
        csvContent += csvRow.join(&#39;,&#39;) + &#39;\n&#39;;
    });
    
    // 尝试使用Web Share API
    if (navigator.share) {
        const BOM = &#39;\uFEFF&#39;;
        const dataBlob = new Blob([BOM + csvContent], { type: &#39;text/csv;charset=utf-8&#39; });
        const file = new File([dataBlob], `dwoody_report_${new Date().toISOString().split(&#39;T&#39;)[0]}.csv`, { type: &#39;text/csv&#39; });
        
        navigator.share({
            title: &#39;D Woody 安装报告&#39;,
            text: &#39;安装服务数据导出&#39;,
            files: [file]
        }).then(() => {
            alert(&#39;数据分享成功！&#39;);
        }).catch((error) => {
            console.log(&#39;分享失败，使用备用方案:&#39;, error);
            fallbackMobileExport(csvContent);
        });
    } else {
        // 备用方案：复制到剪贴板或显示文本
        fallbackMobileExport(csvContent);
    }
}

function fallbackMobileExport(csvContent) {
    // 尝试复制到剪贴板
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(csvContent).then(() => {
            alert(&#39;CSV数据已复制到剪贴板！\n您可以粘贴到邮件或其他应用中。&#39;);
        }).catch(() => {
            showCsvModal(csvContent);
        });
    } else {
        showCsvModal(csvContent);
    }
}

function showCsvModal(csvContent) {
    // 创建模态框显示CSV内容
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-full max-h-full overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">导出的CSV数据</h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            <div class="text-sm text-base-content/70 mb-4">
                请复制以下内容并保存为CSV文件：
            </div>
            <textarea readonly class="textarea textarea-bordered w-full h-64 text-sm font-mono resize-none" 
                      onclick="this.select()">${csvContent}</textarea>
            <div class="flex gap-3 mt-4">
                <button onclick="copyToClipboard(&#39;${csvContent.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                        class="btn btn-primary flex-1">
                    <span class="iconify" data-icon="heroicons:clipboard" data-width="16"></span>
                    复制内容
                </button>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline">关闭</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function copyToClipboard(text) {
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            alert(&#39;内容已复制到剪贴板！&#39;);
        }).catch(() => {
            alert(&#39;复制失败，请手动选择并复制文本。&#39;);
        });
    } else {
        // 备用复制方法
        const textArea = document.createElement(&#39;textarea&#39;);
        textArea.value = text;
        textArea.style.position = &#39;fixed&#39;;
        textArea.style.left = &#39;-999999px&#39;;
        textArea.style.top = &#39;-999999px&#39;;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand(&#39;copy&#39;);
            alert(&#39;内容已复制到剪贴板！&#39;);
        } catch (err) {
            alert(&#39;复制失败，请手动选择并复制文本。&#39;);
        }
        
        document.body.removeChild(textArea);
    }
}

function triggerFileImport() {
    const fileInput = document.getElementById(&#39;importFileInput&#39;);
    if (!fileInput) {
        alert(&#39;系统错误：文件输入功能不可用&#39;);
        return;
    }
    
    // 检查是否为移动设备
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // 移动端：显示导入选项对话框
        showMobileImportDialog();
    } else {
        // 桌面端：直接文件选择
        if (!confirm(&#39;确定要导入数据文件吗？\n\n支持格式：CSV、JSON\n导入无需密码，会自动备份当前数据&#39;)) {
            return;
        }
        
        fileInput.value = &#39;&#39;;
        fileInput.click();
    }
}

function showMobileImportDialog() {
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-sm w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">导入数据文件</h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            <div class="space-y-4">
                <!-- 从内部存储选择文件 -->
                <div class="bg-base-200 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="iconify text-primary" data-icon="heroicons:device-phone-mobile" data-width="16"></span>
                        <span class="text-sm font-medium">从手机存储选择文件</span>
                    </div>
                    <button onclick="selectFileFromStorage(); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-primary w-full flex items-center justify-center gap-2">
                        <span class="iconify" data-icon="heroicons:folder-open" data-width="16"></span>
                        <span class="text-sm">浏览CSV/JSON文件</span>
                    </button>
                    <div class="text-sm text-base-content/70 mt-2">
                        支持从下载文件夹、文档等位置选择 CSV 或 JSON 文件
                    </div>
                </div>
                
                <!-- 粘贴文本数据 -->
                <div class="bg-base-200 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="iconify text-info" data-icon="heroicons:clipboard-document" data-width="16"></span>
                        <span class="text-sm font-medium">粘贴CSV数据</span>
                    </div>
                    <button onclick="showTextImportModal(); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-outline w-full flex items-center justify-center gap-2">
                        <span class="iconify" data-icon="heroicons:clipboard" data-width="16"></span>
                        <span class="text-sm">粘贴CSV文本</span>
                    </button>
                    <div class="text-sm text-base-content/70 mt-2">
                        适用于从其他应用复制的CSV格式数据
                    </div>
                </div>
                
                <!-- 说明信息 -->
                <div class="bg-success/10 border border-success/30 rounded-lg p-4">
                    <div class="flex items-start gap-2">
                        <span class="iconify text-success flex-shrink-0 mt-0.5" data-icon="heroicons:check-circle" data-width="16"></span>
                        <div class="text-sm text-success">
                            <div class="font-medium mb-2">导入说明：</div>
                            <div>• 支持 CSV 和 JSON 格式文件</div>
                            <div>• 导入无需密码，任何人都可以导入</div>
                            <div>• 导入前会自动备份当前数据</div>
                            <div>• 文件通常保存在"下载"或"文档"文件夹</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function selectFileFromStorage() {
    if (!confirm(&#39;确定要从手机存储导入数据文件吗？\n\n支持格式：CSV、JSON\n导入无需密码，会自动备份当前数据&#39;)) {
        return;
    }
    
    const fileInput = document.getElementById(&#39;importFileInput&#39;);
    if (fileInput) {
        // 为移动端优化文件选择器，优先支持CSV
        fileInput.accept = &#39;.csv,text/csv,application/csv,text/comma-separated-values,.json,application/json&#39;;
        fileInput.value = &#39;&#39;;
        
        // 添加文件选择提示
        const importBtn = document.getElementById(&#39;importBtn&#39;);
        if (importBtn) {
            importBtn.innerHTML = &#39;<span class="iconify animate-pulse" data-icon="heroicons:folder-open" data-width="16"></span><span class="text-sm">选择文件...</span>&#39;;
        }
        
        fileInput.click();
        
        // 重置按钮状态
        setTimeout(() => {
            if (importBtn &amp;&amp; !fileInput.files.length) {
                importBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:arrow-up-tray" data-width="16"></span><span class="text-sm">导入</span>&#39;;
            }
        }, 5000);
    }
}

function showTextImportModal() {
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-full max-h-full overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">粘贴CSV数据</h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            <div class="bg-info/10 border border-info/30 rounded-lg p-4 mb-4">
                <div class="flex items-start gap-2">
                    <span class="iconify text-info flex-shrink-0 mt-0.5" data-icon="heroicons:information-circle" data-width="16"></span>
                    <div class="text-sm text-info">
                        <div class="font-medium mb-2">CSV格式说明：</div>
                        <div>• 第一行为表头：地址,密码,安装日期,包工,收工</div>
                        <div>• 每行数据用逗号分隔</div>
                        <div>• 可以从其他应用（如Excel、记事本）复制数据</div>
                    </div>
                </div>
            </div>
            <div class="text-sm text-base-content/70 mb-4">
                请粘贴CSV格式的数据（包含表头）：
            </div>
            <textarea id="csvTextInput" placeholder="地址,密码,安装日期,包工,收工&amp;#10;示例地址,示例密码,2024-01-01,家庆,收工员&amp;#10;另一个地址,另一个密码,2024-01-02,大安,收工员2" 
                      class="textarea textarea-bordered w-full h-64 text-sm font-mono resize-none mb-4"></textarea>
            <div class="flex gap-3">
                <button onclick="importFromText(); this.closest(&#39;.fixed&#39;).remove();" 
                        class="btn btn-primary flex-1">
                    <span class="iconify" data-icon="heroicons:arrow-up-tray" data-width="16"></span>
                    导入数据
                </button>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline">取消</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function importFromText() {
    const textInput = document.getElementById(&#39;csvTextInput&#39;);
    const csvText = textInput.value.trim();
    
    if (!csvText) {
        alert(&#39;请输入CSV数据&#39;);
        return;
    }
    
    if (!confirm(&#39;确定要导入这些数据吗？\n导入前会备份当前数据&#39;)) {
        return;
    }
    
    const importBtn = document.getElementById(&#39;importBtn&#39;);
    importBtn.disabled = true;
    importBtn.innerHTML = &#39;<span class="iconify animate-spin" data-icon="heroicons:arrow-path" data-width="16"></span>&#39;;
    
    // 备份当前数据
    const currentDataBackup = extractTableData();
    
    try {
        const lines = csvText.split(&#39;\n&#39;).filter(line => line.trim());
        const data = [];
        
        // 跳过表头（第一行）
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // 简单的CSV解析（处理引号包围的字段）
            const cells = parseCSVLine(line);
            if (cells.length >= 1) {
                // 确保有5列数据
                while (cells.length < 5) {
                    cells.push(&#39;&#39;);
                }
                data.push(cells.slice(0, 5));
            }
        }
        
        if (data.length === 0) {
            throw new Error(&#39;没有找到有效的数据行&#39;);
        }
        
        loadDataIntoTable(data);
        alert(`导入成功！已导入 ${data.length} 行数据`);
        
        if (currentView === &#39;calendar&#39;) {
            updateCalendarData();
        }
        
    } catch (error) {
        console.error(&#39;文本导入失败:&#39;, error);
        if (currentDataBackup &amp;&amp; currentDataBackup.length > 0) {
            loadDataIntoTable(currentDataBackup);
        }
        alert(`导入失败：${error.message}`);
    } finally {
        importBtn.disabled = false;
        importBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:arrow-up-tray" data-width="16"></span><span class="text-sm">导入</span>&#39;;
    }
}

function parseCSVLine(line) {
    const result = [];
    let current = &#39;&#39;;
    let inQuotes = false;
    let i = 0;
    
    while (i < line.length) {
        const char = line[i];
        
        if (char === &#39;"&#39;) {
            if (inQuotes &amp;&amp; line[i + 1] === &#39;"&#39;) {
                // 转义的引号
                current += &#39;"&#39;;
                i += 2;
            } else {
                // 切换引号状态
                inQuotes = !inQuotes;
                i++;
            }
        } else if (char === &#39;,&#39; &amp;&amp; !inQuotes) {
            // 字段分隔符
            result.push(current.trim());
            current = &#39;&#39;;
            i++;
        } else {
            current += char;
            i++;
        }
    }
    
    // 添加最后一个字段
    result.push(current.trim());
    
    return result;
}

function handleSecureFileImport(event) {
    const file = event.target.files[0];
    const importBtn = document.getElementById(&#39;importBtn&#39;);
    
    if (!file) {
        // 如果没有选择文件，重置按钮状态
        if (importBtn) {
            importBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:arrow-up-tray" data-width="16"></span><span class="text-sm">导入</span>&#39;;
        }
        return;
    }
    
    // 检查文件类型，优先处理CSV文件
    const fileName = file.name.toLowerCase();
    const isCSV = fileName.endsWith(&#39;.csv&#39;) || file.type.includes(&#39;csv&#39;);
    const isJSON = fileName.endsWith(&#39;.json&#39;) || file.type.includes(&#39;json&#39;);
    
    if (!isCSV &amp;&amp; !isJSON) {
        alert(&#39;不支持的文件格式！\n请选择CSV或JSON格式的文件。&#39;);
        event.target.value = &#39;&#39;;
        if (importBtn) {
            importBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:arrow-up-tray" data-width="16"></span><span class="text-sm">导入</span>&#39;;
        }
        return;
    }
    
    // 显示文件信息
    const fileSize = (file.size / 1024).toFixed(2);
    const fileType = isCSV ? &#39;CSV数据文件&#39; : &#39;JSON数据文件&#39;;
    const fileInfo = `文件：${file.name}\n大小：${fileSize} KB\n类型：${fileType}`;
    
    if (!confirm(`找到${fileType}！\n\n${fileInfo}\n\n确定要导入这个文件吗？\n导入前会备份当前数据`)) {
        event.target.value = &#39;&#39;;
        if (importBtn) {
            importBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:arrow-up-tray" data-width="16"></span><span class="text-sm">导入</span>&#39;;
        }
        return;
    }
    
    importBtn.disabled = true;
    importBtn.innerHTML = &#39;<span class="iconify animate-spin" data-icon="heroicons:arrow-path" data-width="16"></span><span class="text-sm">处理中...</span>&#39;;
    
    const currentDataBackup = extractTableData();
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            let importData;
            let dataCount = 0;
            
            if (file.name.toLowerCase().endsWith(&#39;.json&#39;)) {
                importData = JSON.parse(content);
                if (!importData.data || !Array.isArray(importData.data)) {
                    throw new Error(&#39;JSON文件格式无效，缺少data数组&#39;);
                }
                dataCount = importData.data.length;
                loadDataIntoTable(importData.data);
            } else if (file.name.toLowerCase().endsWith(&#39;.csv&#39;)) {
                const lines = content.split(&#39;\n&#39;).filter(line => line.trim());
                if (lines.length < 2) {
                    throw new Error(&#39;CSV文件内容不足，至少需要表头和一行数据&#39;);
                }
                
                const data = [];
                // 跳过表头（第一行）
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // 使用更强的CSV解析
                    const cells = parseCSVLine(line);
                    if (cells.length >= 1) {
                        // 确保有5列数据
                        while (cells.length < 5) {
                            cells.push(&#39;&#39;);
                        }
                        data.push(cells.slice(0, 5));
                    }
                }
                
                if (data.length === 0) {
                    throw new Error(&#39;CSV文件中没有有效的数据行&#39;);
                }
                
                dataCount = data.length;
                loadDataIntoTable(data);
            } else {
                throw new Error(&#39;不支持的文件格式，请选择CSV或JSON文件&#39;);
            }
            
            alert(`导入成功！\n\n文件：${file.name}\n已导入 ${dataCount} 行数据`);
            
            if (currentView === &#39;calendar&#39;) {
                updateCalendarData();
            }
            
        } catch (error) {
            console.error(&#39;导入失败:&#39;, error);
            if (currentDataBackup &amp;&amp; currentDataBackup.length > 0) {
                loadDataIntoTable(currentDataBackup);
            }
            alert(`导入失败：${error.message}\n\n请检查文件格式是否正确`);
        } finally {
            importBtn.disabled = false;
            importBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:arrow-up-tray" data-width="16"></span><span class="text-sm">导入</span>&#39;;
            event.target.value = &#39;&#39;;
        }
    };
    
    reader.onerror = function() {
        alert(&#39;文件读取失败，请检查文件是否损坏&#39;);
        importBtn.disabled = false;
        importBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:arrow-up-tray" data-width="16"></span><span class="text-sm">导入</span>&#39;;
        event.target.value = &#39;&#39;;
    };
    
    reader.readAsText(file, &#39;UTF-8&#39;);
}

function loadDataIntoTable(data) {
    const tbody = document.querySelector(&#39;.table tbody&#39;);
    if (!tbody) return;
    
    tbody.innerHTML = &#39;&#39;;
    
    data.forEach((rowData, index) => {
        const isEvenRow = index % 2 === 1;
        const newRow = document.createElement(&#39;tr&#39;);
        newRow.className = isEvenRow ? &#39;hover:bg-base-200/50 bg-base-50 border-b border-base-300&#39; : &#39;hover:bg-base-200/50 border-b border-base-300&#39;;
        
        const cells = rowData.slice(0, 5);
        while (cells.length < 5) {
            cells.push(&#39;&#39;);
        }
        
        // 保存原始数据到data属性中，用于后续显示控制
        const originalAddress = cells[0] || &#39;&#39;;
        const originalPassword = cells[1] || &#39;&#39;;
        const originalInstallDate = cells[2] || &#39;&#39;;
        const originalSubcontractor = cells[3] || &#39;&#39;;
        const originalDesigner = cells[4] || &#39;&#39;;
        
        // 导入时所有敏感信息都用***隐藏，只有登录后才显示真实内容
        let addressValue = (originalAddress &amp;&amp; originalAddress.trim() !== &#39;&#39;) ? &#39;***&#39; : &#39;&#39;;
        let passwordValue = (originalPassword &amp;&amp; originalPassword.trim() !== &#39;&#39;) ? &#39;***&#39; : &#39;&#39;;
        let installDateValue = (originalInstallDate &amp;&amp; originalInstallDate.trim() !== &#39;&#39;) ? &#39;***&#39; : &#39;&#39;;
        let subcontractorValue = (originalSubcontractor &amp;&amp; originalSubcontractor.trim() !== &#39;&#39;) ? &#39;***&#39; : &#39;&#39;;
        let designerValue = (originalDesigner &amp;&amp; originalDesigner.trim() !== &#39;&#39;) ? &#39;***&#39; : &#39;&#39;;

newRow.innerHTML = `
            <td class="p-3">
                <input type="text" value="${addressValue}" data-original-value="${originalAddress}" ${!isUnlocked ? &#39;readonly&#39; : &#39;&#39;} class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary address-input" onclick="showAddressDetail(this)" />
            </td>
            <td class="p-3 password-column">
                <input type="text" value="${passwordValue}" data-original-password="${originalPassword}" ${!isUnlocked ? &#39;readonly&#39; : &#39;&#39;} class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary password-field" onclick="showPasswordDetail(this)" />
            </td>
            <td class="p-3">
                <input type="text" value="${installDateValue}" data-original-value="${originalInstallDate}" ${!isUnlocked ? &#39;readonly&#39; : &#39;&#39;} class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary install-date-input" />
            </td>
<td class="p-3">
                                <input type="text" value="${subcontractorValue}" data-original-value="${originalSubcontractor}" ${!isUnlocked ? &#39;readonly&#39; : &#39;&#39;} class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary subcontractor-input" onclick="showSubcontractorDetail(this)" />
                            </td>
<td class="p-3">
                <input type="text" value="${designerValue}" data-original-value="${originalDesigner}" ${!isUnlocked ? &#39;readonly&#39; : &#39;&#39;} class="input input-sm w-full bg-transparent border-none text-sm focus:bg-base-100 focus:border-primary designer-input" onclick="showDesignerDetail(this)" />
            </td>
            <td class="p-3">
                <div class="flex gap-2 justify-center">
                    <button class="btn btn-sm btn-info copy-row-btn ${!isUnlocked ? &#39;hidden&#39; : &#39;&#39;}" onclick="copyRowToNew(this)" title="复制此行">
                        <span class="iconify" data-icon="heroicons:document-duplicate" data-width="14"></span>
                    </button>
                    <button class="btn btn-sm btn-error delete-row-btn ${!isUnlocked || data.length <= 1 ? &#39;hidden&#39; : &#39;&#39;}" onclick="deleteSpecificRow(this)" title="删除此行">
                        <span class="iconify" data-icon="heroicons:x-mark" data-width="14"></span>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(newRow);
    });
    
    updateDeleteButtonsVisibility();
    
    // 导入后根据当前登录状态重新设置显示
    if (isUnlocked) {
        showAllDataForAdmin();
    } else if (isContractorMode &amp;&amp; currentContractor) {
        showDataForContractor(currentContractor);
    } else {
        hideAllSensitiveData();
    }
}

function checkLocalStorageStatus() {
    updateStorageStatus();
}

function updateStorageStatus() {
    const storageStatus = document.getElementById(&#39;storageStatus&#39;);
    if (!storageStatus) return;
    
    try {
        const savedDataStr = localStorage.getItem(localStorageKey);
        
        if (!savedDataStr) {
            storageStatus.innerHTML = &#39;<span class="text-info">本地存储：未检测到数据</span>&#39;;
            return;
        }
        
        const savedData = JSON.parse(savedDataStr);
        const rowCount = savedData.rowCount || (savedData.data ? savedData.data.length : 0);
        const saveDate = savedData.saveDate || &#39;未知时间&#39;;
        
        storageStatus.innerHTML = `<span class="text-success">✅ 本地存储：${rowCount} 行 (${saveDate})</span>`;
        
    } catch (error) {
        console.error(&#39;检查存储状态失败:&#39;, error);
        storageStatus.innerHTML = &#39;<span class="text-warning">⚠️ 本地存储：状态异常</span>&#39;;
    }
}

function updateStorageButtonsState() {
    const exportBtn = document.getElementById(&#39;exportBtn&#39;);
    const importBtn = document.getElementById(&#39;importBtn&#39;);
    
    // 导入按钮始终可用（不需要密码）
    if (importBtn) {
        importBtn.disabled = false;
        importBtn.classList.remove(&#39;btn-disabled&#39;);
        importBtn.style.opacity = &#39;1&#39;;
        importBtn.title = &#39;导入CSV/JSON数据文件（无需密码）&#39;;
    }
    
    // 导出按钮需要管理员密码
    if (exportBtn) {
        if (isUnlocked) {
            exportBtn.disabled = false;
            exportBtn.classList.remove(&#39;btn-disabled&#39;);
            exportBtn.style.opacity = &#39;1&#39;;
            exportBtn.title = &#39;导出CSV数据备份&#39;;
        } else {
            exportBtn.disabled = true;
            exportBtn.classList.add(&#39;btn-disabled&#39;);
            exportBtn.style.opacity = &#39;0.5&#39;;
            exportBtn.title = &#39;导出CSV数据备份（需管理员密码）&#39;;
        }
    }
}

function switchToTableView() {
    currentView = &#39;table&#39;;
    document.getElementById(&#39;calendarSection&#39;).classList.add(&#39;hidden&#39;);
    document.getElementById(&#39;tableSection&#39;).classList.remove(&#39;hidden&#39;);
    document.getElementById(&#39;tableControls&#39;).classList.remove(&#39;hidden&#39;);
    
    document.getElementById(&#39;tableViewBtn&#39;).classList.remove(&#39;btn-outline&#39;);
    document.getElementById(&#39;tableViewBtn&#39;).classList.add(&#39;btn-primary&#39;);
    document.getElementById(&#39;calendarViewBtn&#39;).classList.add(&#39;btn-outline&#39;);
    document.getElementById(&#39;calendarViewBtn&#39;).classList.remove(&#39;btn-primary&#39;);
}

function switchToCalendarView() {
    currentView = &#39;calendar&#39;;
    document.getElementById(&#39;calendarSection&#39;).classList.remove(&#39;hidden&#39;);
    document.getElementById(&#39;tableSection&#39;).classList.add(&#39;hidden&#39;);
    document.getElementById(&#39;tableControls&#39;).classList.add(&#39;hidden&#39;);
    
    document.getElementById(&#39;calendarViewBtn&#39;).classList.remove(&#39;btn-outline&#39;);
    document.getElementById(&#39;calendarViewBtn&#39;).classList.add(&#39;btn-primary&#39;);
    document.getElementById(&#39;tableViewBtn&#39;).classList.add(&#39;btn-outline&#39;);
    document.getElementById(&#39;tableViewBtn&#39;).classList.remove(&#39;btn-primary&#39;);
    
    syncCalendarWithTableDates();
    initializeCalendar();
}

function getSingaporeHoliday(dateString) {
    const year = dateString.split(&#39;-&#39;)[0];
    let holidays = singaporeHolidays[year];
    
    // 如果没有该年份的假期数据，提供基本的固定假期
    if (!holidays) {
        holidays = [
            { date: `${year}-01-01`, name: &#39;元旦&#39;, nameEn: &#39;New Year\&#39;s Day&#39; },
            { date: `${year}-05-01`, name: &#39;劳动节&#39;, nameEn: &#39;Labour Day&#39; },
            { date: `${year}-08-09`, name: &#39;国庆节&#39;, nameEn: &#39;National Day&#39; },
            { date: `${year}-12-25`, name: &#39;圣诞节&#39;, nameEn: &#39;Christmas Day&#39; }
        ];
        // 缓存到全局对象中
        singaporeHolidays[year] = holidays;
    }
    
    return holidays.find(holiday => holiday.date === dateString);
}

function parseDateString(dateString) {
    if (!dateString || dateString.trim() === &#39;&#39;) return null;
    
    let date = null;
    
    if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
        date = new Date(dateString + &#39;T00:00:00&#39;);
    } else if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
        const [day, month, year] = dateString.split(&#39;/&#39;);
        date = new Date(year, month - 1, day);
    } else {
        date = new Date(dateString);
    }
    
    return isNaN(date.getTime()) ? null : date;
}

function formatDateForDisplay(date) {
    if (!date) return &#39;&#39;;
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, &#39;0&#39;);
    const day = String(date.getDate()).padStart(2, &#39;0&#39;);
    return `${year}-${month}-${day}`;
}

function syncCalendarWithTableDates() {
    const installations = getInstallationData();
    const datesInTable = installations
        .map(inst => parseDateString(inst.installDate))
        .filter(date => date !== null);
    
    if (datesInTable.length > 0) {
        const earliestDate = new Date(Math.min(...datesInTable));
        currentCalendarDate = new Date(earliestDate.getFullYear(), earliestDate.getMonth(), 1);
    } else {
        currentCalendarDate = new Date();
    }
}

function initializeCalendar() {
    generateCalendar();
    updateCalendarData();
}

function generateCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    const monthNames = [&#39;1月&#39;, &#39;2月&#39;, &#39;3月&#39;, &#39;4月&#39;, &#39;5月&#39;, &#39;6月&#39;, 
                       &#39;7月&#39;, &#39;8月&#39;, &#39;9月&#39;, &#39;10月&#39;, &#39;11月&#39;, &#39;12月&#39;];
    document.getElementById(&#39;currentMonth&#39;).textContent = `${year}年${monthNames[month]}`;
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    const calendarGrid = document.getElementById(&#39;calendarGrid&#39;);
    calendarGrid.innerHTML = &#39;&#39;;
    
    // 添加空白单元格以对齐星期
    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyCell = document.createElement(&#39;div&#39;);
        emptyCell.className = &#39;p-2&#39;;
        calendarGrid.appendChild(emptyCell);
    }
    
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement(&#39;div&#39;);
        const cellDate = new Date(year, month, day);
        const isToday = cellDate.toDateString() === today.toDateString();
        const dateString = formatDateForDisplay(cellDate);
        const holiday = getSingaporeHoliday(dateString);
        
        // 基础样式类
        let cellClasses = &#39;min-h-12 p-2 text-sm text-center cursor-pointer rounded-lg transition-all duration-200 relative flex flex-col items-center justify-start&#39;;
        
        // 根据日期类型应用不同样式
        if (isToday &amp;&amp; holiday) {
            // 今天且是假期：特殊样式
            cellClasses += &#39; bg-gradient-to-br from-accent to-error/30 text-white font-bold calendar-today calendar-holiday&#39;;
        } else if (isToday) {
            // 仅今天
            cellClasses += &#39; bg-accent text-accent-content font-bold calendar-today&#39;;
        } else if (holiday) {
            // 仅假期
            cellClasses += &#39; bg-error/20 text-error hover:bg-error/30 hover:scale-105 font-medium calendar-holiday border border-error/40&#39;;
        } else {
            // 普通日期
            cellClasses += &#39; bg-base-300 hover:bg-base-200 hover:scale-105&#39;;
        }
        
        dayCell.className = cellClasses;
        dayCell.onclick = () => selectDate(cellDate);
        
        // 添加日期数字
        const dayNumber = document.createElement(&#39;div&#39;);
        dayNumber.className = &#39;font-medium&#39;;
        dayNumber.textContent = day;
        dayCell.appendChild(dayNumber);
        
        // 如果是假期，添加假期名称
        if (holiday) {
            const holidayName = document.createElement(&#39;div&#39;);
            holidayName.className = &#39;text-xs leading-tight mt-1 text-center break-words max-w-full&#39;;
            holidayName.style.fontSize = &#39;0.5rem&#39;;
            holidayName.style.lineHeight = &#39;1.0&#39;;
            holidayName.style.wordBreak = &#39;break-all&#39;;
            holidayName.textContent = holiday.name;
            dayCell.appendChild(holidayName);
            
            // 为农历新年添加特殊标识
            if (holiday.name.includes(&#39;农历新年&#39;)) {
                const cnyIcon = document.createElement(&#39;div&#39;);
                cnyIcon.className = &#39;text-xs mt-0.5&#39;;
                cnyIcon.textContent = &#39;🧧&#39;;
                dayCell.appendChild(cnyIcon);
            }
        }
        
        // 设置工具提示
        let tooltipText = `${String(day).padStart(2, &#39;0&#39;)}/${String(month + 1).padStart(2, &#39;0&#39;)}/${year}`;
        if (holiday) {
            tooltipText += `\n🎉 ${holiday.name}`;
            if (holiday.nameEn) {
                tooltipText += ` (${holiday.nameEn})`;
            }
        }
        if (isUnlocked &amp;&amp; !holiday) {
            tooltipText += &#39;\n点击选择作为安装日期&#39;;
        } else if (holiday) {
            tooltipText += &#39;\n(新加坡公共假期)&#39;;
        }
        dayCell.title = tooltipText;
        
        calendarGrid.appendChild(dayCell);
    }
}

function updateCalendarData() {
    const installations = getInstallationData();
    const calendarCells = document.querySelectorAll(&#39;#calendarGrid > div&#39;);
    
    calendarCells.forEach((cell, index) => {
        if (cell.textContent &amp;&amp; cell.textContent.trim()) {
            const dayNumberElement = cell.querySelector(&#39;div&#39;);
            if (!dayNumberElement) return;
            
            const day = parseInt(dayNumberElement.textContent);
            const cellDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
            const dateString = formatDateForDisplay(cellDate);
            
            cell.classList.remove(&#39;bg-primary&#39;, &#39;text-primary-content&#39;, &#39;calendar-has-installation&#39;);
            if (!cell.classList.contains(&#39;bg-accent&#39;) &amp;&amp; !cell.classList.contains(&#39;bg-error/20&#39;)) {
                cell.classList.add(&#39;bg-base-300&#39;);
            }
            
            const existingIndicator = cell.querySelector(&#39;.installation-count&#39;);
            const existingAddresses = cell.querySelector(&#39;.installation-addresses&#39;);
            if (existingIndicator) existingIndicator.remove();
            if (existingAddresses) existingAddresses.remove();
            
const holiday = getSingaporeHoliday(dateString);
            
            const dayInstallations = installations.filter(inst => {
                const instDate = parseDateString(inst.installDate);
                return instDate &amp;&amp; formatDateForDisplay(instDate) === dateString;
            });
            
            if (dayInstallations.length > 0) {
                cell.classList.remove(&#39;bg-base-300&#39;, &#39;bg-error/20&#39;);
                if (holiday) {
                    // 假期且有安装：特殊渐变背景
                    cell.classList.add(&#39;bg-gradient-to-br&#39;, &#39;from-primary&#39;, &#39;to-error/40&#39;, &#39;text-primary-content&#39;, &#39;border-2&#39;, &#39;border-primary&#39;);
                } else {
                    // 仅有安装：主色背景
                    cell.classList.add(&#39;bg-primary&#39;, &#39;text-primary-content&#39;, &#39;calendar-has-installation&#39;);
                }
                
                const addressContainer = document.createElement(&#39;div&#39;);
                addressContainer.className = &#39;installation-addresses text-xs mt-1 space-y-1 max-h-6 overflow-y-auto&#39;;
                
                dayInstallations.forEach((inst, index) => {
                    if (inst.address &amp;&amp; inst.address.trim()) {
                        const addressDiv = document.createElement(&#39;div&#39;);
                        addressDiv.className = &#39;text-xs leading-tight truncate&#39;;
                        const shortAddress = inst.address.length > 6 ? 
                            inst.address.substring(0, 6) + &#39;...&#39; : 
                            inst.address;
                        addressDiv.textContent = shortAddress;
                        addressDiv.title = inst.address;
                        addressContainer.appendChild(addressDiv);
                    }
                });
                
                if (dayInstallations.length > 1) {
                    const indicator = document.createElement(&#39;div&#39;);
                    indicator.className = &#39;installation-count text-xs font-bold bg-accent text-accent-content rounded-full w-4 h-4 flex items-center justify-center absolute -top-1 -right-1&#39;;
                    indicator.textContent = dayInstallations.length;
                    cell.style.position = &#39;relative&#39;;
                    cell.appendChild(indicator);
                }
                
                cell.appendChild(addressContainer);
                
                let tooltipText = `${dayInstallations.length} 个安装项目:\n`;
                dayInstallations.forEach((inst, index) => {
                    tooltipText += `${index + 1}. ${inst.address || &#39;未填写地址&#39;}\n`;
                    if (isUnlocked) {
                        tooltipText += `   锁具: ${inst.lock || &#39;未填写&#39;}\n`;
                    } else if (isContractorMode &amp;&amp; shouldShowLockForContractor(inst.subcontractor)) {
                        tooltipText += `   锁具: ${inst.lock || &#39;未填写&#39;}\n`;
                    } else if (inst.lock) {
                        tooltipText += `   锁具: ***\n`;
                    }
                });
                if (isUnlocked) {
                    tooltipText += &#39;\n点击查看详情或添加新项目&#39;;
                }
                cell.title = tooltipText;
            }
        }
    });
}

function getInstallationData() {
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    const installations = [];
    
    tableRows.forEach(row => {
        if (row.style.display === &#39;none&#39;) {
            return;
        }
        
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        if (inputs.length >= 5) {
            // 获取真实数据值，优先使用原始值而不是显示的***
            const address = inputs[0].value === &#39;***&#39; ? 
                (inputs[0].getAttribute(&#39;data-original-value&#39;) || &#39;&#39;) : inputs[0].value.trim();
            const lock = inputs[1].value === &#39;***&#39; ? 
                (inputs[1].getAttribute(&#39;data-original-password&#39;) || &#39;&#39;) : inputs[1].value.trim();
            const installDate = inputs[2].value === &#39;***&#39; ? 
                (inputs[2].getAttribute(&#39;data-original-value&#39;) || &#39;&#39;) : inputs[2].value.trim();
            const subcontractor = inputs[3].value === &#39;***&#39; ? 
                (inputs[3].getAttribute(&#39;data-original-value&#39;) || &#39;&#39;) : inputs[3].value.trim();
            const designer = inputs[4].value === &#39;***&#39; ? 
                (inputs[4].getAttribute(&#39;data-original-value&#39;) || &#39;&#39;) : inputs[4].value.trim();
            
            if (address || lock || installDate || subcontractor || designer) {
                installations.push({
                    address,
                    lock,
                    installDate,
                    subcontractor,
                    designer
                });
            }
        }
    });
    
    return installations;
}

function selectDate(date) {
    const dateString = formatDateForDisplay(date);
    const installations = getInstallationData();
    const dayInstallations = installations.filter(inst => {
        const instDate = parseDateString(inst.installDate);
        return instDate &amp;&amp; formatDateForDisplay(instDate) === dateString;
    });
    
    const selectedDateInfo = document.getElementById(&#39;selectedDateInfo&#39;);
    const dateInstallations = document.getElementById(&#39;dateInstallations&#39;);
    
    if (isUnlocked) {
        autoFillDateIntoTable(dateString);
    }
    
    if (dayInstallations.length > 0) {
        selectedDateInfo.classList.remove(&#39;hidden&#39;);
        
        const formattedDate = `${String(date.getDate()).padStart(2, &#39;0&#39;)}/${String(date.getMonth() + 1).padStart(2, &#39;0&#39;)}/${date.getFullYear()}`;
        
        let installationsHTML = `<div class="font-medium mb-3">${formattedDate} (${dayInstallations.length} 个项目)</div>`;
        
        dayInstallations.forEach((inst, index) => {
            let lockInfo = &#39;&#39;;
            if (isUnlocked) {
                lockInfo = `<div>锁具: ${inst.lock || &#39;未填写&#39;}</div>`;
            } else if (isContractorMode &amp;&amp; shouldShowLockForContractor(inst.subcontractor)) {
                lockInfo = `<div>锁具: ${inst.lock || &#39;未填写&#39;}</div>`;
            } else {
                lockInfo = `<div>锁具: ***</div>`;
            }
            
            installationsHTML += `
                <div class="p-3 bg-base-100 rounded-lg border-l-4 border-primary">
                    <div class="font-medium text-sm">${inst.address || &#39;未填写地址&#39;}</div>
                    <div class="text-sm text-base-content/70 mt-2 space-y-1">
                        ${lockInfo}
                        <div>包工: ${inst.subcontractor || &#39;未填写&#39;}</div>
                        <div>收工: ${inst.designer || &#39;未填写&#39;}</div>
                    </div>
                </div>
            `;
        });
        
        dateInstallations.innerHTML = installationsHTML;
    } else {
        selectedDateInfo.classList.remove(&#39;hidden&#39;);
        const formattedDate = `${String(date.getDate()).padStart(2, &#39;0&#39;)}/${String(date.getMonth() + 1).padStart(2, &#39;0&#39;)}/${date.getFullYear()}`;
        
        let actionHTML = &#39;&#39;;
        if (isUnlocked) {
            actionHTML = `
                <div class="mt-4">
                    <button class="btn btn-primary" onclick="addNewInstallationForDate(&#39;${dateString}&#39;)">
                        <span class="iconify" data-icon="heroicons:plus" data-width="16"></span>
                        <span class="text-sm">添加项目</span>
                    </button>
                </div>
            `;
        }
        
        dateInstallations.innerHTML = `
            <div class="font-medium mb-3">${formattedDate}</div>
            <div class="text-sm text-base-content/70">该日期没有安装项目</div>
            ${actionHTML}
        `;
    }
}

function changeMonth(direction) {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
    generateCalendar();
    updateCalendarData();
    
    document.getElementById(&#39;selectedDateInfo&#39;).classList.add(&#39;hidden&#39;);
}

function autoFillDateIntoTable(dateString) {
    if (!isUnlocked) {
        alert(&#39;请先解锁表格才能自动填入日期&#39;);
        return;
    }
    
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    let targetRow = null;
    
    for (let row of tableRows) {
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        const isEmpty = Array.from(inputs).every(input => !input.value.trim());
        if (isEmpty) {
            targetRow = row;
            break;
        }
    }
    
    if (!targetRow) {
        addTableRow();
        const newRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
        targetRow = newRows[newRows.length - 1];
    }
    
    if (targetRow) {
        const inputs = targetRow.querySelectorAll(&#39;input[type="text"]&#39;);
        if (inputs.length >= 3) {
            inputs[2].value = dateString;
            inputs[2].focus();
            
            inputs[2].style.backgroundColor = &#39;rgba(59, 130, 246, 0.2)&#39;;
            setTimeout(() => {
                inputs[2].style.backgroundColor = &#39;&#39;;
            }, 2000);
            
            alert(`已将日期 ${dateString} 填入安装日期字段`);
            
            if (currentView === &#39;calendar&#39;) {
                setTimeout(() => {
                    switchToTableView();
                }, 1000);
            }
        }
    }
}

function addNewInstallationForDate(dateString) {
    if (!isUnlocked) {
        alert(&#39;请先解锁表格才能添加安装项目&#39;);
        return;
    }
    
    addTableRow();
    
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    const newRow = tableRows[tableRows.length - 1];
    const inputs = newRow.querySelectorAll(&#39;input[type="text"]&#39;);
    
    if (inputs.length >= 3) {
        inputs[2].value = dateString;
        inputs[0].focus();
        
        newRow.style.backgroundColor = &#39;rgba(16, 185, 129, 0.1)&#39;;
        setTimeout(() => {
            newRow.style.backgroundColor = &#39;&#39;;
        }, 3000);
        
        alert(`已为 ${dateString} 创建新的安装项目`);
        switchToTableView();
    }
}

function shouldShowLockForContractor(subcontractorValue) {
    if (!isContractorMode || !currentContractor) {
        return false;
    }
    
    return subcontractorValue === currentContractor || subcontractorValue === &#39;&#39; || !subcontractorValue;
}

// 监听输入变化以更新日历
document.addEventListener(&#39;input&#39;, function(e) {
    if (e.target.matches(&#39;.table input[type="text"]&#39;) &amp;&amp; currentView === &#39;calendar&#39;) {
        clearTimeout(window.calendarUpdateTimeout);
        window.calendarUpdateTimeout = setTimeout(() => {
            updateCalendarData();
        }, 500);
    }
});

// 监听密码字段输入变化以更新原始密码值
document.addEventListener(&#39;input&#39;, function(e) {
    if (e.target.matches(&#39;.password-field&#39;)) {
        // 更新原始密码值
        e.target.setAttribute(&#39;data-original-password&#39;, e.target.value);
    }
});

// 监听输入变化以更新包工模式的密码列显示
document.addEventListener(&#39;input&#39;, function(e) {
    if (e.target.matches(&#39;.table input[type="text"]&#39;)) {
        clearTimeout(window.calendarSyncTimeout);
        window.calendarSyncTimeout = setTimeout(() => {
            if (currentView === &#39;calendar&#39;) {
                syncCalendarWithTableDates();
                updateCalendarData();
            }
            
if (isContractorMode &amp;&amp; currentContractor) {
                showDataForContractor(currentContractor);
            }
        }, 1000);
    }
});

// 显示地址详情模态框
function showAddressDetail(inputElement) {
    const address = inputElement.value.trim();
    const placeholder = inputElement.placeholder;
    
    // 如果地址被隐藏（显示为***），不允许查看
    if (address === &#39;***&#39;) {
        alert(&#39;此地址信息已隐藏，请先登录查看&#39;);
        return;
    }
    
    // 如果地址为空且不是解锁状态，显示提示
    if (!address &amp;&amp; !isUnlocked) {
        return;
    }
    
    // 在包工模式下，检查是否有权限查看此地址
    if (isContractorMode &amp;&amp; currentContractor) {
        const row = inputElement.closest(&#39;tr&#39;);
        const subcontractorInput = row.querySelector(&#39;input[type="text"]:nth-child(4)&#39;) || row.querySelectorAll(&#39;input[type="text"]&#39;)[3];
        const originalSubcontractor = subcontractorInput.getAttribute(&#39;data-original-value&#39;) || subcontractorInput.value;
        
        if (originalSubcontractor &amp;&amp; originalSubcontractor !== currentContractor &amp;&amp; originalSubcontractor !== &#39;&#39;) {
            alert(&#39;您只能查看自己负责的项目地址&#39;);
            return;
        }
    }
    
    // 创建模态框
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-lg w-full max-h-96 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">地址详情</h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <!-- 地址显示区域 -->
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="bg-base-200 rounded-lg p-4 min-h-32">
                    <div class="text-sm text-base-content/70 mb-2">地址内容：</div>
                    <div id="addressDisplay" class="text-lg leading-relaxed break-words ${!address ? &#39;text-base-content/50 italic&#39; : &#39;text-base-content&#39;}" 
                         style="word-wrap: break-word; overflow-wrap: break-word;">
                        ${address || &#39;暂无地址信息&#39;}
                    </div>
                </div>
            </div>
            
            <!-- 编辑区域（仅解锁时显示） -->
            ${isUnlocked ? `
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text text-sm font-medium">编辑地址：</span>
                    </label>
                    <textarea id="addressEditor" 
                              class="textarea textarea-bordered w-full h-24 text-sm resize-none" 
                              placeholder="${placeholder}">${address}</textarea>
                </div>
            ` : &#39;&#39;}
            
            <!-- 操作按钮 -->
            <div class="flex gap-2 flex-wrap">
                ${address ? `
                    <button onclick="openNavigation(&#39;${address.replace(/&#39;/g, "\\&#39;")}&#39;);" 
                            class="btn btn-info flex-1 min-w-32">
                        <span class="iconify" data-icon="heroicons:map-pin" data-width="16"></span>
                        导航
                    </button>
                    <button onclick="copyAddressToClipboard(&#39;${address.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-primary flex-1 min-w-32">
                        <span class="iconify" data-icon="heroicons:clipboard" data-width="16"></span>
                        复制地址
                    </button>
                ` : &#39;&#39;}
                
                ${isUnlocked ? `
                    <button onclick="saveAddressFromModal(this); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-success flex-1 min-w-32"
                            data-input-element="${getElementIndex(inputElement)}">
                        <span class="iconify" data-icon="heroicons:check" data-width="16"></span>
                        保存修改
                    </button>
                ` : &#39;&#39;}
                
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline min-w-24">
                    关闭
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 如果是解锁状态，聚焦到编辑框
    if (isUnlocked) {
        setTimeout(() => {
            const editor = document.getElementById(&#39;addressEditor&#39;);
            if (editor) {
                editor.focus();
                editor.setSelectionRange(editor.value.length, editor.value.length);
            }
        }, 100);
    }
}

// 获取元素在表格中的索引
function getElementIndex(element) {
    const allAddressInputs = document.querySelectorAll(&#39;.address-input&#39;);
    return Array.from(allAddressInputs).indexOf(element);
}

// 从模态框保存地址
function saveAddressFromModal(button) {
    const inputIndex = parseInt(button.getAttribute(&#39;data-input-element&#39;));
    const editor = document.getElementById(&#39;addressEditor&#39;);
    const allAddressInputs = document.querySelectorAll(&#39;.address-input&#39;);
    
    if (editor &amp;&amp; allAddressInputs[inputIndex]) {
        const newAddress = editor.value.trim();
        allAddressInputs[inputIndex].value = newAddress;
        
        // 高亮显示已更新的输入框
        const targetInput = allAddressInputs[inputIndex];
        targetInput.style.backgroundColor = &#39;rgba(34, 197, 94, 0.2)&#39;;
        setTimeout(() => {
            targetInput.style.backgroundColor = &#39;&#39;;
        }, 2000);
        
        // 如果在日历视图，更新日历数据
        if (currentView === &#39;calendar&#39;) {
            updateCalendarData();
        }
        
        alert(&#39;地址已更新&#39;);
    }
}

// 复制地址到剪贴板
function copyAddressToClipboard(address) {
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(address).then(() => {
            alert(&#39;地址已复制到剪贴板！&#39;);
        }).catch(() => {
            fallbackCopyAddress(address);
        });
    } else {
        fallbackCopyAddress(address);
    }
}

// 备用复制方法
function fallbackCopyAddress(address) {
    const textArea = document.createElement(&#39;textarea&#39;);
    textArea.value = address;
    textArea.style.position = &#39;fixed&#39;;
    textArea.style.left = &#39;-999999px&#39;;
    textArea.style.top = &#39;-999999px&#39;;
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand(&#39;copy&#39;);
        alert(&#39;地址已复制到剪贴板！&#39;);
    } catch (err) {
        alert(&#39;复制失败，请手动选择并复制地址。&#39;);
    }
    
document.body.removeChild(textArea);
}

// 包工管理功能
function loadContractorList() {
    try {
        const savedList = localStorage.getItem(contractorStorageKey);
        if (savedList) {
            contractorList = JSON.parse(savedList);
        }
    } catch (error) {
        console.error(&#39;加载包工名单失败:&#39;, error);
        contractorList = ["家庆", "大安", "啊俊"]; // 使用默认名单
    }
}

function saveContractorList() {
    try {
        localStorage.setItem(contractorStorageKey, JSON.stringify(contractorList));
    } catch (error) {
        console.error(&#39;保存包工名单失败:&#39;, error);
    }
}

function showContractorManagement(show) {
    const contractorManagement = document.getElementById(&#39;contractorManagement&#39;);
    if (contractorManagement) {
        if (show) {
            contractorManagement.classList.remove(&#39;hidden&#39;);
            updateContractorListDisplay();
        } else {
            contractorManagement.classList.add(&#39;hidden&#39;);
        }
    }
}

function showAdminPasswordManagement(show) {
    const adminPasswordManagement = document.getElementById(&#39;ig4qh&#39;);
    if (adminPasswordManagement) {
        if (show) {
            adminPasswordManagement.classList.remove(&#39;hidden&#39;);
        } else {
            adminPasswordManagement.classList.add(&#39;hidden&#39;);
        }
    }
}

function showPreFillSection(show) {
    const preFillSection = document.getElementById(&#39;preFillSection&#39;);
    if (preFillSection) {
        if (show) {
            preFillSection.classList.remove(&#39;hidden&#39;);
        } else {
            preFillSection.classList.add(&#39;hidden&#39;);
        }
    }
}

function updateQuickFilterOptions() {
    const quickFilter = document.getElementById(&#39;quickFilter&#39;);
    if (!quickFilter) return;
    
    // 保存当前选中的值
    const currentValue = quickFilter.value;
    
    // 清空现有选项（保留"显示全部"和"未填写包工"）
    quickFilter.innerHTML = `
        <option value="">显示全部</option>
        ${contractorList.map(name => `<option value="${name}">${name}</option>`).join(&#39;&#39;)}
        <option value="empty">未填写包工</option>
    `;
    
    // 恢复之前选中的值（如果还存在）
    if (currentValue &amp;&amp; (contractorList.includes(currentValue) || currentValue === "" || currentValue === "empty")) {
        quickFilter.value = currentValue;
    }
}

function updateContractorListDisplay() {
    const contractorListElement = document.getElementById(&#39;contractorList&#39;);
    if (!contractorListElement) return;
    
    if (contractorList.length === 0) {
        contractorListElement.innerHTML = &#39;<div class="text-sm text-base-content/70 italic">暂无包工</div>&#39;;
        updateContractorPasswordSelect();
        return;
    }
    
    contractorListElement.innerHTML = contractorList.map((name, index) => `
        <div class="flex items-center justify-between bg-base-100 rounded-lg px-3 py-2">
            <span class="text-sm font-medium">${name}</span>
            <div class="flex gap-2">
                <span class="text-xs text-base-content/50">密码: ${getContractorPassword(name) || &#39;未设置&#39;}</span>
                <button class="btn btn-sm btn-error btn-outline" 
                        onclick="removeContractor(${index})" 
                        title="删除 ${name}">
                    <span class="iconify" data-icon="heroicons:trash" data-width="14"></span>
                </button>
            </div>
        </div>
    `).join(&#39;&#39;);
    
    // 更新密码选择下拉框
    updateContractorPasswordSelect();
}

function addNewContractor() {
    const input = document.getElementById(&#39;newContractorInput&#39;);
    if (!input) return;
    
    const newName = input.value.trim();
    
    if (!newName) {
        alert(&#39;请输入包工名字&#39;);
        input.focus();
        return;
    }
    
    if (newName.length > 10) {
        alert(&#39;包工名字不能超过10个字符&#39;);
        input.focus();
        return;
    }
    
    if (contractorList.includes(newName)) {
        alert(&#39;该包工名字已存在&#39;);
        input.focus();
        return;
    }
    
    // 添加到列表
    contractorList.push(newName);
    
    // 保存到本地存储
    saveContractorList();
    
    // 更新显示
    updateContractorListDisplay();
    updateQuickFilterOptions();
    
    // 清空输入框
    input.value = &#39;&#39;;
    
    // 显示成功提示
    input.style.backgroundColor = &#39;rgba(34, 197, 94, 0.2)&#39;;
    setTimeout(() => {
        input.style.backgroundColor = &#39;&#39;;
    }, 1000);
    
    alert(`包工 "${newName}" 添加成功！`);
}

function removeContractor(index) {
    if (index < 0 || index >= contractorList.length) return;
    
    const contractorName = contractorList[index];
    
    if (!confirm(`确定要删除包工 "${contractorName}" 吗？\n\n注意：删除后该包工名字将从筛选选项中移除，但表格中已有的数据不会被删除。`)) {
        return;
    }
    
    // 从列表中移除
    contractorList.splice(index, 1);
    
    // 保存到本地存储
    saveContractorList();
    
    // 更新显示
    updateContractorListDisplay();
    updateQuickFilterOptions();
    
    // 如果当前筛选的是被删除的包工，清除筛选
    const quickFilter = document.getElementById(&#39;quickFilter&#39;);
    if (quickFilter &amp;&amp; quickFilter.value === contractorName) {
        quickFilter.value = &#39;&#39;;
        clearQuickFilter();
    }
    
alert(`包工 "${contractorName}" 已删除！`);
}

// 包工密码管理功能
function updateContractorPasswordSelect() {
    const select = document.getElementById(&#39;contractorPasswordSelect&#39;);
    if (!select) return;
    
    // 清空现有选项
    select.innerHTML = &#39;<option value="">选择要修改密码的包工</option>&#39;;
    
    // 添加所有包工选项
    contractorList.forEach(name => {
        const option = document.createElement(&#39;option&#39;);
        option.value = name;
        option.textContent = `${name} (当前密码: ${getContractorPassword(name) || &#39;未设置&#39;})`;
        select.appendChild(option);
});
}

// 预填写功能相关函数
function updatePreFillContractorOptions() {
    const select = document.getElementById(&#39;preFillContractorSelect&#39;);
    if (!select) return;
    
    // 清空现有选项
    select.innerHTML = &#39;<option value="">选择包工</option>&#39;;
    
    // 添加所有包工选项
    contractorList.forEach(name => {
        const option = document.createElement(&#39;option&#39;);
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
    });
}

function updatePreFillContractor() {
    const select = document.getElementById(&#39;preFillContractorSelect&#39;);
    const input = document.getElementById(&#39;preFillContractor&#39;);
    
    if (select &amp;&amp; input &amp;&amp; select.value) {
        input.value = select.value;
        updatePreFillPreview();
    }
}

function updatePreFillPreview() {
    const preview = document.getElementById(&#39;preFillPreview&#39;);
    const previewContent = document.getElementById(&#39;preFillPreviewContent&#39;);
    
    if (!preview || !previewContent) return;
    
    const address = document.getElementById(&#39;preFillAddress&#39;)?.value.trim() || &#39;&#39;;
    const password = document.getElementById(&#39;preFillPassword&#39;)?.value.trim() || &#39;&#39;;
    const date = document.getElementById(&#39;preFillDate&#39;)?.value || &#39;&#39;;
    const contractor = document.getElementById(&#39;preFillContractor&#39;)?.value.trim() || &#39;&#39;;
    const designer = document.getElementById(&#39;preFillDesigner&#39;)?.value.trim() || &#39;&#39;;
    
    // 如果所有字段都为空，隐藏预览
    if (!address &amp;&amp; !password &amp;&amp; !date &amp;&amp; !contractor &amp;&amp; !designer) {
        preview.classList.add(&#39;hidden&#39;);
        return;
    }
    
    // 显示预览
    preview.classList.remove(&#39;hidden&#39;);
    
    let previewHTML = &#39;&#39;;
    if (address) previewHTML += `<div><span class="text-base-content/60">地址：</span>${address}</div>`;
    if (password) previewHTML += `<div><span class="text-base-content/60">密码：</span>${password}</div>`;
    if (date) previewHTML += `<div><span class="text-base-content/60">安装日期：</span>${date}</div>`;
    if (contractor) previewHTML += `<div><span class="text-base-content/60">包工：</span>${contractor}</div>`;
    if (designer) previewHTML += `<div><span class="text-base-content/60">收工：</span>${designer}</div>`;
    
    previewContent.innerHTML = previewHTML || &#39;<div class="text-base-content/50 italic">暂无内容</div>&#39;;
}

function addPreFilledProject() {
    if (!isUnlocked) {
        alert(&#39;请先解锁表格才能添加项目&#39;);
        return;
    }
    
    const address = document.getElementById(&#39;preFillAddress&#39;)?.value.trim() || &#39;&#39;;
    const password = document.getElementById(&#39;preFillPassword&#39;)?.value.trim() || &#39;&#39;;
    const date = document.getElementById(&#39;preFillDate&#39;)?.value || &#39;&#39;;
    const contractor = document.getElementById(&#39;preFillContractor&#39;)?.value.trim() || &#39;&#39;;
    const designer = document.getElementById(&#39;preFillDesigner&#39;)?.value.trim() || &#39;&#39;;
    
    // 检查是否至少填写了地址或安装日期
    if (!address &amp;&amp; !date) {
        alert(&#39;请至少填写项目地址或安装日期&#39;);
        return;
    }
    
    // 确认添加
    let confirmMessage = &#39;确定要将以下信息添加到表格吗？\n\n&#39;;
    if (address) confirmMessage += `地址：${address}\n`;
    if (password) confirmMessage += `密码：${password}\n`;
    if (date) confirmMessage += `安装日期：${date}\n`;
    if (contractor) confirmMessage += `包工：${contractor}\n`;
    if (designer) confirmMessage += `收工：${designer}\n`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // 添加新行到表格
    addTableRow();
    
    // 获取最新添加的行
    const tbody = document.querySelector(&#39;.table tbody&#39;);
    const newRow = tbody.lastElementChild;
    const inputs = newRow.querySelectorAll(&#39;input[type="text"]&#39;);
    
    if (inputs.length >= 5) {
        // 填入预设数据
        if (address) {
            inputs[0].value = address;
            inputs[0].setAttribute(&#39;data-original-value&#39;, address);
        }
        if (password) {
            inputs[1].value = password;
            inputs[1].setAttribute(&#39;data-original-password&#39;, password);
        }
        if (date) {
            inputs[2].value = date;
            inputs[2].setAttribute(&#39;data-original-value&#39;, date);
        }
        if (contractor) {
            inputs[3].value = contractor;
            inputs[3].setAttribute(&#39;data-original-value&#39;, contractor);
        }
        if (designer) {
            inputs[4].value = designer;
            inputs[4].setAttribute(&#39;data-original-value&#39;, designer);
        }
        
        // 高亮新添加的行
        newRow.style.backgroundColor = &#39;rgba(34, 197, 94, 0.1)&#39;;
        newRow.style.border = &#39;2px solid rgba(34, 197, 94, 0.3)&#39;;
        setTimeout(() => {
            newRow.style.backgroundColor = &#39;&#39;;
            newRow.style.border = &#39;&#39;;
        }, 3000);
        
// 清空预填写表单（成功添加后清除后台数据）
        clearPreFillFormAfterAdd();
        
        // 滚动到新添加的行
        newRow.scrollIntoView({ behavior: &#39;smooth&#39;, block: &#39;center&#39; });
        
        // 如果在日历视图，更新日历数据
        if (currentView === &#39;calendar&#39;) {
            updateCalendarData();
        }
        
        alert(&#39;项目信息已成功添加到表格！&#39;);
    }
}

// 添加项目后清空表单（不需要确认）
function clearPreFillFormAfterAdd() {
    const fields = [
        &#39;preFillAddress&#39;,
        &#39;preFillPassword&#39;, 
        &#39;preFillDate&#39;,
        &#39;preFillContractor&#39;,
        &#39;preFillDesigner&#39;
    ];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = &#39;&#39;;
        }
    });
    
    // 重置包工选择
    const contractorSelect = document.getElementById(&#39;preFillContractorSelect&#39;);
    if (contractorSelect) {
        contractorSelect.value = &#39;&#39;;
    }
    
    // 隐藏预览
    const preview = document.getElementById(&#39;preFillPreview&#39;);
    if (preview) {
        preview.classList.add(&#39;hidden&#39;);
    }
    
    // 清除后台保存的数据
    clearPreFillStorage();
    
    // 重新设置今天的日期
    const dateField = document.getElementById(&#39;preFillDate&#39;);
    if (dateField) {
        const today = new Date();
        const todayString = today.toISOString().split(&#39;T&#39;)[0];
        dateField.value = todayString;
        updatePreFillPreview();
        savePreFillData();
    }
    
    // 聚焦到地址输入框
    const addressField = document.getElementById(&#39;preFillAddress&#39;);
    if (addressField) {
        addressField.focus();
    }
}

function clearPreFillForm() {
    // 确认清空操作
    if (!confirm(&#39;确定要清空所有预填写内容吗？\n\n这将清除当前表单内容和后台保存的数据。&#39;)) {
        return;
    }
    
    const fields = [
        &#39;preFillAddress&#39;,
        &#39;preFillPassword&#39;, 
        &#39;preFillDate&#39;,
        &#39;preFillContractor&#39;,
        &#39;preFillDesigner&#39;
    ];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = &#39;&#39;;
        }
    });
    
    // 重置包工选择
    const contractorSelect = document.getElementById(&#39;preFillContractorSelect&#39;);
    if (contractorSelect) {
        contractorSelect.value = &#39;&#39;;
    }
    
    // 隐藏预览
    const preview = document.getElementById(&#39;preFillPreview&#39;);
    if (preview) {
        preview.classList.add(&#39;hidden&#39;);
    }
    
    // 清除后台保存的数据
    clearPreFillStorage();
    
    // 重新设置今天的日期
    const dateField = document.getElementById(&#39;preFillDate&#39;);
    if (dateField) {
        const today = new Date();
        const todayString = today.toISOString().split(&#39;T&#39;)[0];
        dateField.value = todayString;
        updatePreFillPreview();
        savePreFillData();
    }
    
    // 聚焦到地址输入框
    const addressField = document.getElementById(&#39;preFillAddress&#39;);
    if (addressField) {
        addressField.focus();
    }
    
    // 显示清空成功提示
    const clearBtn = document.getElementById(&#39;clearPreFillBtn&#39;);
    if (clearBtn) {
        const originalText = clearBtn.innerHTML;
        clearBtn.innerHTML = &#39;<span class="iconify text-success" data-icon="heroicons:check" data-width="16"></span><span class="text-sm">已清空</span>&#39;;
        clearBtn.disabled = true;
        
        setTimeout(() => {
            clearBtn.innerHTML = originalText;
            clearBtn.disabled = false;
        }, 2000);
    }
}

// 预填写数据后台存储
const preFillStorageKey = &#39;dwoody_prefill_data&#39;;
const preFillTemplatesKey = &#39;dwoody_prefill_templates&#39;;

// 保存预填写数据到后台
function savePreFillData() {
    const preFillData = {
        address: document.getElementById(&#39;preFillAddress&#39;)?.value || &#39;&#39;,
        password: document.getElementById(&#39;preFillPassword&#39;)?.value || &#39;&#39;,
        date: document.getElementById(&#39;preFillDate&#39;)?.value || &#39;&#39;,
        contractor: document.getElementById(&#39;preFillContractor&#39;)?.value || &#39;&#39;,
        designer: document.getElementById(&#39;preFillDesigner&#39;)?.value || &#39;&#39;,
        contractorSelect: document.getElementById(&#39;preFillContractorSelect&#39;)?.value || &#39;&#39;,
        lastSaved: new Date().toISOString()
    };
    
    try {
        localStorage.setItem(preFillStorageKey, JSON.stringify(preFillData));
        console.log(&#39;预填写数据已保存到后台&#39;);
    } catch (error) {
        console.error(&#39;保存预填写数据失败:&#39;, error);
    }
}

// 从后台加载预填写数据
function loadPreFillData() {
    try {
        const savedData = localStorage.getItem(preFillStorageKey);
        if (savedData) {
            const preFillData = JSON.parse(savedData);
            
            // 恢复表单数据
            const addressField = document.getElementById(&#39;preFillAddress&#39;);
            const passwordField = document.getElementById(&#39;preFillPassword&#39;);
            const dateField = document.getElementById(&#39;preFillDate&#39;);
            const contractorField = document.getElementById(&#39;preFillContractor&#39;);
            const designerField = document.getElementById(&#39;preFillDesigner&#39;);
            const contractorSelectField = document.getElementById(&#39;preFillContractorSelect&#39;);
            
            if (addressField) addressField.value = preFillData.address || &#39;&#39;;
            if (passwordField) passwordField.value = preFillData.password || &#39;&#39;;
            if (dateField) dateField.value = preFillData.date || &#39;&#39;;
            if (contractorField) contractorField.value = preFillData.contractor || &#39;&#39;;
            if (designerField) designerField.value = preFillData.designer || &#39;&#39;;
            if (contractorSelectField) contractorSelectField.value = preFillData.contractorSelect || &#39;&#39;;
            
            // 更新预览
            updatePreFillPreview();
            
            // 显示恢复提示
            if (preFillData.lastSaved) {
                const lastSavedDate = new Date(preFillData.lastSaved);
                const timeAgo = getTimeAgo(lastSavedDate);
                showPreFillRestoreNotification(timeAgo);
            }
            
            console.log(&#39;预填写数据已从后台恢复&#39;);
            return true;
        }
    } catch (error) {
        console.error(&#39;加载预填写数据失败:&#39;, error);
    }
    return false;
}

// 清除后台预填写数据
function clearPreFillStorage() {
    try {
        localStorage.removeItem(preFillStorageKey);
        console.log(&#39;后台预填写数据已清除&#39;);
    } catch (error) {
        console.error(&#39;清除预填写数据失败:&#39;, error);
    }
}

// 计算时间差
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return &#39;刚刚&#39;;
    if (diffMins < 60) return `${diffMins}分钟前`;
    if (diffHours < 24) return `${diffHours}小时前`;
    if (diffDays < 7) return `${diffDays}天前`;
    return date.toLocaleDateString(&#39;zh-CN&#39;);
}

// 显示数据恢复通知
function showPreFillRestoreNotification(timeAgo) {
    const notification = document.createElement(&#39;div&#39;);
    notification.className = &#39;bg-success/10 border border-success/30 rounded-lg p-3 mb-3 animate-pulse&#39;;
    notification.innerHTML = `
        <div class="flex items-center gap-2">
            <span class="iconify text-success" data-icon="heroicons:clock" data-width="16"></span>
            <div class="text-sm text-success">
                <div class="font-medium">已恢复上次保存的预填写信息</div>
                <div class="text-xs opacity-80">保存时间：${timeAgo}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="btn btn-xs btn-ghost ml-auto">
                <span class="iconify" data-icon="heroicons:x-mark" data-width="12"></span>
            </button>
        </div>
    `;
    
    const preFillSection = document.querySelector(&#39;#preFillSection .bg-primary\\/5&#39;);
    if (preFillSection) {
        preFillSection.insertBefore(notification, preFillSection.firstChild);
        
        // 3秒后自动移除通知
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.transition = &#39;opacity 0.3s ease&#39;;
                notification.style.opacity = &#39;0&#39;;
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 3000);
    }
}

// 为预填写字段添加实时预览更新和自动保存
document.addEventListener(&#39;DOMContentLoaded&#39;, function() {
    const preFillFields = [
        &#39;preFillAddress&#39;,
        &#39;preFillPassword&#39;,
        &#39;preFillDate&#39;, 
        &#39;preFillContractor&#39;,
        &#39;preFillDesigner&#39;
    ];
    
    preFillFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener(&#39;input&#39;, function() {
                updatePreFillPreview();
                // 延迟保存，避免频繁写入
                clearTimeout(window.preFillSaveTimeout);
                window.preFillSaveTimeout = setTimeout(savePreFillData, 1000);
            });
            field.addEventListener(&#39;change&#39;, function() {
                updatePreFillPreview();
                savePreFillData();
            });
        }
    });
    
    // 包工选择下拉框也需要自动保存
    const contractorSelect = document.getElementById(&#39;preFillContractorSelect&#39;);
    if (contractorSelect) {
        contractorSelect.addEventListener(&#39;change&#39;, function() {
            updatePreFillContractor();
            savePreFillData();
        });
    }
    
    // 初始化模板选择器
    updateTemplateSelect();
    
    // 为日期字段设置默认值为今天（仅在没有保存数据时）
    const dateField = document.getElementById(&#39;preFillDate&#39;);
    if (dateField &amp;&amp; !loadPreFillData()) {
        const today = new Date();
        const todayString = today.toISOString().split(&#39;T&#39;)[0];
        dateField.value = todayString;
        updatePreFillPreview();
        savePreFillData();
    }
    
    // 为模板名称输入框添加回车键支持
    const templateNameInput = document.getElementById(&#39;templateNameInput&#39;);
    if (templateNameInput) {
        templateNameInput.addEventListener(&#39;keypress&#39;, function(e) {
            if (e.key === &#39;Enter&#39;) {
                savePreFillTemplate();
            }
        });
    }
});

// 手动保存预填写数据
function manualSavePreFillData() {
    savePreFillData();
    
    // 显示保存成功提示
    const saveBtn = document.getElementById(&#39;savePreFillBtn&#39;);
    if (saveBtn) {
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = &#39;<span class="iconify text-white" data-icon="heroicons:check" data-width="16"></span><span class="text-sm">已保存</span>&#39;;
        saveBtn.disabled = true;
        
        setTimeout(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }, 2000);
    }
    
    // 显示保存提示
    const notification = document.createElement(&#39;div&#39;);
    notification.className = &#39;bg-success/10 border border-success/30 rounded-lg p-3 mb-3&#39;;
    notification.innerHTML = `
        <div class="flex items-center gap-2">
            <span class="iconify text-success" data-icon="heroicons:check-circle" data-width="16"></span>
            <div class="text-sm text-success">
                <div class="font-medium">预填写信息已保存到后台</div>
                <div class="text-xs opacity-80">您可以随时继续编辑或添加到表格</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="btn btn-xs btn-ghost ml-auto">
                <span class="iconify" data-icon="heroicons:x-mark" data-width="12"></span>
            </button>
        </div>
    `;
    
    const preFillSection = document.querySelector(&#39;#preFillSection .bg-primary\\/5&#39;);
    if (preFillSection) {
        preFillSection.insertBefore(notification, preFillSection.firstChild);
        
        // 3秒后自动移除通知
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.transition = &#39;opacity 0.3s ease&#39;;
                notification.style.opacity = &#39;0&#39;;
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 3000);
}
}

// 预填写模板管理功能
function loadPreFillTemplates() {
    try {
        const savedTemplates = localStorage.getItem(preFillTemplatesKey);
        return savedTemplates ? JSON.parse(savedTemplates) : {};
    } catch (error) {
        console.error(&#39;加载预填写模板失败:&#39;, error);
        return {};
    }
}

function savePreFillTemplates(templates) {
    try {
        localStorage.setItem(preFillTemplatesKey, JSON.stringify(templates));
    } catch (error) {
        console.error(&#39;保存预填写模板失败:&#39;, error);
    }
}

function updateTemplateSelect() {
    const select = document.getElementById(&#39;preFillTemplateSelect&#39;);
    if (!select) return;
    
    const templates = loadPreFillTemplates();
    const templateCount = Object.keys(templates).length;
    
    // 清空现有选项
    select.innerHTML = &#39;<option value="">选择预设模板</option>&#39;;
    
    // 添加模板选项
    Object.keys(templates).forEach(templateName => {
        const option = document.createElement(&#39;option&#39;);
        option.value = templateName;
        option.textContent = templateName;
        select.appendChild(option);
    });
    
    // 更新模板统计信息
    updateTemplateStats(templateCount);
}

function updateTemplateStats(count) {
    const templateCountElement = document.getElementById(&#39;templateCount&#39;);
    if (templateCountElement) {
        templateCountElement.textContent = `当前模板数量：${count}`;
    }
}

function savePreFillTemplate() {
    const templateNameInput = document.getElementById(&#39;templateNameInput&#39;);
    const saveBtn = document.getElementById(&#39;saveTemplateBtn&#39;);
    
    if (!templateNameInput || !saveBtn) return;
    
    const templateName = templateNameInput.value.trim();
    
    if (!templateName) {
        alert(&#39;请输入模板名称&#39;);
        templateNameInput.focus();
        return;
    }
    
    if (templateName.length > 30) {
        alert(&#39;模板名称不能超过30个字符&#39;);
        templateNameInput.focus();
        return;
    }
    
    // 获取当前预填写数据
    const currentData = {
        address: document.getElementById(&#39;preFillAddress&#39;)?.value || &#39;&#39;,
        password: document.getElementById(&#39;preFillPassword&#39;)?.value || &#39;&#39;,
        date: document.getElementById(&#39;preFillDate&#39;)?.value || &#39;&#39;,
        contractor: document.getElementById(&#39;preFillContractor&#39;)?.value || &#39;&#39;,
        designer: document.getElementById(&#39;preFillDesigner&#39;)?.value || &#39;&#39;,
        contractorSelect: document.getElementById(&#39;preFillContractorSelect&#39;)?.value || &#39;&#39;
    };
    
    // 检查是否有内容
    const hasContent = Object.values(currentData).some(value => value.trim() !== &#39;&#39;);
    if (!hasContent) {
        alert(&#39;请先填写一些预填写内容再保存模板&#39;);
        return;
    }
    
    // 加载现有模板
    const templates = loadPreFillTemplates();
    
    // 检查模板名称是否已存在
    if (templates[templateName]) {
        if (!confirm(`模板 "${templateName}" 已存在，确定要覆盖吗？`)) {
            return;
        }
    }
    
    // 显示保存状态
    saveBtn.disabled = true;
    saveBtn.innerHTML = &#39;<span class="iconify animate-spin" data-icon="heroicons:arrow-path" data-width="14"></span>&#39;;
    
    try {
        // 保存模板
        templates[templateName] = {
            ...currentData,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        savePreFillTemplates(templates);
        updateTemplateSelect();
        
        // 清空模板名称输入框
        templateNameInput.value = &#39;&#39;;
        
        // 显示成功提示
        templateNameInput.style.backgroundColor = &#39;rgba(34, 197, 94, 0.2)&#39;;
        setTimeout(() => {
            templateNameInput.style.backgroundColor = &#39;&#39;;
        }, 2000);
        
        alert(`模板 "${templateName}" 保存成功！`);
        
    } catch (error) {
        console.error(&#39;保存模板失败:&#39;, error);
        alert(&#39;保存模板失败，请重试&#39;);
    } finally {
        // 恢复按钮状态
        saveBtn.disabled = false;
        saveBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:bookmark-square" data-width="14"></span><span class="text-sm">保存模板</span>&#39;;
    }
}

function loadPreFillTemplate() {
    const select = document.getElementById(&#39;preFillTemplateSelect&#39;);
    if (!select || !select.value) return;
    
    loadSelectedTemplate();
}

function loadSelectedTemplate() {
    const select = document.getElementById(&#39;preFillTemplateSelect&#39;);
    if (!select || !select.value) {
        alert(&#39;请先选择一个模板&#39;);
        return;
    }
    
    const templateName = select.value;
    const templates = loadPreFillTemplates();
    const template = templates[templateName];
    
    if (!template) {
        alert(&#39;模板不存在或已损坏&#39;);
        updateTemplateSelect();
        return;
    }
    
    // 确认加载模板
    if (!confirm(`确定要加载模板 "${templateName}" 吗？\n\n这将覆盖当前的预填写内容。`)) {
        select.value = &#39;&#39;;
        return;
    }
    
    try {
        // 填入模板数据
        const addressField = document.getElementById(&#39;preFillAddress&#39;);
        const passwordField = document.getElementById(&#39;preFillPassword&#39;);
        const dateField = document.getElementById(&#39;preFillDate&#39;);
        const contractorField = document.getElementById(&#39;preFillContractor&#39;);
        const designerField = document.getElementById(&#39;preFillDesigner&#39;);
        const contractorSelectField = document.getElementById(&#39;preFillContractorSelect&#39;);
        
        if (addressField) addressField.value = template.address || &#39;&#39;;
        if (passwordField) passwordField.value = template.password || &#39;&#39;;
        if (dateField) dateField.value = template.date || &#39;&#39;;
        if (contractorField) contractorField.value = template.contractor || &#39;&#39;;
        if (designerField) designerField.value = template.designer || &#39;&#39;;
        if (contractorSelectField) contractorSelectField.value = template.contractorSelect || &#39;&#39;;
        
        // 更新预览
        updatePreFillPreview();
        
        // 自动保存当前数据
        savePreFillData();
        
        // 显示加载成功提示
        showTemplateLoadNotification(templateName);
        
        // 重置选择框
        select.value = &#39;&#39;;
        
    } catch (error) {
        console.error(&#39;加载模板失败:&#39;, error);
        alert(&#39;加载模板失败，请重试&#39;);
    }
}

function deletePreFillTemplate() {
    const select = document.getElementById(&#39;preFillTemplateSelect&#39;);
    if (!select || !select.value) {
        alert(&#39;请先选择要删除的模板&#39;);
        return;
    }
    
    const templateName = select.value;
    
    if (!confirm(`确定要删除模板 "${templateName}" 吗？\n\n此操作不可撤销。`)) {
        return;
    }
    
    const deleteBtn = document.getElementById(&#39;deleteTemplateBtn&#39;);
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = &#39;<span class="iconify animate-spin" data-icon="heroicons:arrow-path" data-width="14"></span>&#39;;
    
    try {
        const templates = loadPreFillTemplates();
        
        if (!templates[templateName]) {
            alert(&#39;模板不存在&#39;);
            return;
        }
        
        // 删除模板
        delete templates[templateName];
        savePreFillTemplates(templates);
        updateTemplateSelect();
        
        alert(`模板 "${templateName}" 已删除！`);
        
    } catch (error) {
        console.error(&#39;删除模板失败:&#39;, error);
        alert(&#39;删除模板失败，请重试&#39;);
    } finally {
        // 恢复按钮状态
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:trash" data-width="14"></span>&#39;;
    }
}

function showTemplateLoadNotification(templateName) {
    const notification = document.createElement(&#39;div&#39;);
    notification.className = &#39;bg-accent/10 border border-accent/30 rounded-lg p-3 mb-3 animate-pulse&#39;;
    notification.innerHTML = `
        <div class="flex items-center gap-2">
            <span class="iconify text-accent" data-icon="heroicons:bookmark-square" data-width="16"></span>
            <div class="text-sm text-accent">
                <div class="font-medium">已加载模板：${templateName}</div>
                <div class="text-xs opacity-80">预填写内容已更新</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="btn btn-xs btn-ghost ml-auto">
                <span class="iconify" data-icon="heroicons:x-mark" data-width="12"></span>
            </button>
        </div>
    `;
    
    const preFillSection = document.querySelector(&#39;#preFillSection .bg-primary\\/5&#39;);
    if (preFillSection) {
        preFillSection.insertBefore(notification, preFillSection.firstChild);
        
        // 3秒后自动移除通知
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.transition = &#39;opacity 0.3s ease&#39;;
                notification.style.opacity = &#39;0&#39;;
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 3000);
    }
}

// 获取所有模板的统计信息
function getTemplateStats() {
    const templates = loadPreFillTemplates();
    const templateCount = Object.keys(templates).length;
    const templateNames = Object.keys(templates);
    
    return {
        count: templateCount,
        names: templateNames,
        templates: templates
    };
}

// 导出所有模板
function exportAllTemplates() {
    const templates = loadPreFillTemplates();
    const templateCount = Object.keys(templates).length;
    
    if (templateCount === 0) {
        alert(&#39;没有保存的模板可以导出&#39;);
        return;
    }
    
    const exportData = {
        version: &#39;1.0&#39;,
        exportTime: new Date().toISOString(),
        templateCount: templateCount,
        templates: templates
    };
    
    const exportText = JSON.stringify(exportData, null, 2);
    
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(exportText).then(() => {
            alert(`已导出 ${templateCount} 个预填写模板到剪贴板！\n\n您可以将其保存为备份文件。`);
        }).catch(() => {
            fallbackCopyExtractedData(exportText);
        });
    } else {
        fallbackCopyExtractedData(exportText);
    }
}

// 显示模板管理模态框
function showTemplateManagementModal() {
    const templates = loadPreFillTemplates();
    const templateNames = Object.keys(templates);
    const templateCount = templateNames.length;
    
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-lg w-full max-h-96 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-accent" data-icon="heroicons:bookmark-square" data-width="20"></span>
                    模板管理中心
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <div class="bg-accent/10 border border-accent/30 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="iconify text-accent" data-icon="heroicons:information-circle" data-width="16"></span>
                    <span class="text-sm font-medium text-accent">模板统计</span>
                </div>
                <div class="text-sm text-accent">
                    当前共有 <span class="font-medium">${templateCount}</span> 个预设模板
                </div>
            </div>
            
            ${templateCount > 0 ? `
                <div class="flex-1 overflow-y-auto mb-4">
                    <div class="text-sm font-medium mb-3">已保存的模板：</div>
                    <div class="space-y-2">
                        ${templateNames.map(templateName => {
                            const template = templates[templateName];
                            const createdDate = template.createdAt ? new Date(template.createdAt).toLocaleDateString(&#39;zh-CN&#39;) : &#39;未知&#39;;
                            return `
                                <div class="bg-base-200 rounded-lg p-3 border border-base-300">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="font-medium text-sm">${templateName}</div>
                                        <div class="flex gap-1">
                                            <button onclick="loadTemplateByName(&#39;${templateName.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                                                    class="btn btn-xs btn-info" 
                                                    title="加载此模板">
                                                <span class="iconify" data-icon="heroicons:arrow-down-tray" data-width="12"></span>
                                            </button>
                                            <button onclick="editTemplateName(&#39;${templateName.replace(/&#39;/g, "\\&#39;")}&#39;);" 
                                                    class="btn btn-xs btn-warning" 
                                                    title="重命名模板">
                                                <span class="iconify" data-icon="heroicons:pencil" data-width="12"></span>
                                            </button>
                                            <button onclick="deleteTemplateByName(&#39;${templateName.replace(/&#39;/g, "\\&#39;")}&#39;);" 
                                                    class="btn btn-xs btn-error" 
                                                    title="删除此模板">
                                                <span class="iconify" data-icon="heroicons:trash" data-width="12"></span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="text-xs text-base-content/70">
                                        创建时间：${createdDate}
                                    </div>
                                    <div class="text-xs text-base-content/60 mt-1">
                                        ${template.address ? `地址：${template.address.substring(0, 20)}${template.address.length > 20 ? &#39;...&#39; : &#39;&#39;}` : &#39;&#39;}
                                        ${template.contractor ? ` | 包工：${template.contractor}` : &#39;&#39;}
                                    </div>
                                </div>
                            `;
                        }).join(&#39;&#39;)}
                    </div>
                </div>
            ` : `
                <div class="flex-1 flex items-center justify-center mb-4">
                    <div class="text-center text-base-content/70">
                        <span class="iconify text-base-content/50 mb-2" data-icon="heroicons:bookmark-slash" data-width="48"></span>
                        <div class="text-sm">暂无保存的模板</div>
                        <div class="text-xs mt-1">填写预填写信息后点击"保存模板"来创建第一个模板</div>
                    </div>
                </div>
            `}
            
            <div class="flex gap-3">
                ${templateCount > 0 ? `
                    <button onclick="exportAllTemplates(); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-info flex-1">
                        <span class="iconify" data-icon="heroicons:arrow-up-tray" data-width="16"></span>
                        导出全部
                    </button>
                    <button onclick="clearAllTemplates();" 
                            class="btn btn-error flex-1">
                        <span class="iconify" data-icon="heroicons:trash" data-width="16"></span>
                        清空全部
                    </button>
                ` : &#39;&#39;}
                <button onclick="showImportTemplateModal();" 
                        class="btn btn-success flex-1">
                    <span class="iconify" data-icon="heroicons:arrow-down-tray" data-width="16"></span>
                    导入模板
                </button>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline">关闭</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// 按名称加载模板
function loadTemplateByName(templateName) {
    const templates = loadPreFillTemplates();
    const template = templates[templateName];
    
    if (!template) {
        alert(&#39;模板不存在或已损坏&#39;);
        return;
    }
    
    try {
        // 填入模板数据
        const addressField = document.getElementById(&#39;preFillAddress&#39;);
        const passwordField = document.getElementById(&#39;preFillPassword&#39;);
        const dateField = document.getElementById(&#39;preFillDate&#39;);
        const contractorField = document.getElementById(&#39;preFillContractor&#39;);
        const designerField = document.getElementById(&#39;preFillDesigner&#39;);
        const contractorSelectField = document.getElementById(&#39;preFillContractorSelect&#39;);
        
        if (addressField) addressField.value = template.address || &#39;&#39;;
        if (passwordField) passwordField.value = template.password || &#39;&#39;;
        if (dateField) dateField.value = template.date || &#39;&#39;;
        if (contractorField) contractorField.value = template.contractor || &#39;&#39;;
        if (designerField) designerField.value = template.designer || &#39;&#39;;
        if (contractorSelectField) contractorSelectField.value = template.contractorSelect || &#39;&#39;;
        
        // 更新预览
        updatePreFillPreview();
        
        // 自动保存当前数据
        savePreFillData();
        
        // 显示加载成功提示
        showTemplateLoadNotification(templateName);
        
        alert(`模板 "${templateName}" 已加载！`);
        
    } catch (error) {
        console.error(&#39;加载模板失败:&#39;, error);
        alert(&#39;加载模板失败，请重试&#39;);
    }
}

// 按名称删除模板
function deleteTemplateByName(templateName) {
    if (!confirm(`确定要删除模板 "${templateName}" 吗？\n\n此操作不可撤销。`)) {
        return;
    }
    
    try {
        const templates = loadPreFillTemplates();
        
        if (!templates[templateName]) {
            alert(&#39;模板不存在&#39;);
            return;
        }
        
        // 删除模板
        delete templates[templateName];
        savePreFillTemplates(templates);
        updateTemplateSelect();
        
        alert(`模板 "${templateName}" 已删除！`);
        
        // 刷新模态框
        const modal = document.querySelector(&#39;.fixed.inset-0&#39;);
        if (modal) {
            modal.remove();
            showTemplateManagementModal();
        }
        
    } catch (error) {
        console.error(&#39;删除模板失败:&#39;, error);
        alert(&#39;删除模板失败，请重试&#39;);
    }
}

// 编辑模板名称
function editTemplateName(oldName) {
    const newName = prompt(`请输入新的模板名称：`, oldName);
    
    if (!newName || newName.trim() === &#39;&#39;) {
        return;
    }
    
    const trimmedName = newName.trim();
    
    if (trimmedName === oldName) {
        return;
    }
    
    if (trimmedName.length > 30) {
        alert(&#39;模板名称不能超过30个字符&#39;);
        return;
    }
    
    try {
        const templates = loadPreFillTemplates();
        
        if (!templates[oldName]) {
            alert(&#39;原模板不存在&#39;);
            return;
        }
        
        if (templates[trimmedName]) {
            alert(&#39;新模板名称已存在，请选择其他名称&#39;);
            return;
        }
        
        // 复制模板数据到新名称
        templates[trimmedName] = {
            ...templates[oldName],
            updatedAt: new Date().toISOString()
        };
        
        // 删除旧模板
        delete templates[oldName];
        
        savePreFillTemplates(templates);
        updateTemplateSelect();
        
        alert(`模板已重命名为 "${trimmedName}"！`);
        
        // 刷新模态框
        const modal = document.querySelector(&#39;.fixed.inset-0&#39;);
        if (modal) {
            modal.remove();
            showTemplateManagementModal();
        }
        
    } catch (error) {
        console.error(&#39;重命名模板失败:&#39;, error);
        alert(&#39;重命名模板失败，请重试&#39;);
    }
}

// 清空所有模板
function clearAllTemplates() {
    const templates = loadPreFillTemplates();
    const templateCount = Object.keys(templates).length;
    
    if (templateCount === 0) {
        alert(&#39;没有模板可以清空&#39;);
        return;
    }
    
    if (!confirm(`确定要清空所有 ${templateCount} 个模板吗？\n\n此操作不可撤销，建议先导出备份。`)) {
        return;
    }
    
    try {
        savePreFillTemplates({});
        updateTemplateSelect();
        
        alert(&#39;所有模板已清空！&#39;);
        
        // 关闭模态框
        const modal = document.querySelector(&#39;.fixed.inset-0&#39;);
        if (modal) {
            modal.remove();
        }
        
    } catch (error) {
        console.error(&#39;清空模板失败:&#39;, error);
        alert(&#39;清空模板失败，请重试&#39;);
    }
}

// 显示导入模板模态框
function showImportTemplateModal() {
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-success" data-icon="heroicons:arrow-down-tray" data-width="20"></span>
                    导入模板
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <div class="bg-info/10 border border-info/30 rounded-lg p-4 mb-4">
                <div class="text-sm text-info">
                    <div class="font-medium mb-2">支持的导入格式：</div>
                    <div>• JSON格式的模板数据</div>
                    <div>• 从其他设备导出的模板文件</div>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="label">
                    <span class="label-text text-sm font-medium">粘贴模板数据：</span>
                </label>
                <textarea id="importTemplateData" 
                          placeholder="请粘贴JSON格式的模板数据..."
                          class="textarea textarea-bordered w-full h-32 text-sm font-mono resize-none"></textarea>
            </div>
            
            <div class="flex gap-3">
                <button onclick="importTemplatesFromText(); this.closest(&#39;.fixed&#39;).remove();" 
                        class="btn btn-success flex-1">
                    <span class="iconify" data-icon="heroicons:arrow-down-tray" data-width="16"></span>
                    导入
                </button>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline">取消</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// 从文本导入模板
function importTemplatesFromText() {
    const textArea = document.getElementById(&#39;importTemplateData&#39;);
    const importData = textArea.value.trim();
    
    if (!importData) {
        alert(&#39;请输入模板数据&#39;);
        return;
    }
    
    importTemplates(importData);
}

// 导入模板
function importTemplates(importData) {
    try {
        const data = JSON.parse(importData);
        
        if (!data.templates || typeof data.templates !== &#39;object&#39;) {
            throw new Error(&#39;导入数据格式无效&#39;);
        }
        
        const currentTemplates = loadPreFillTemplates();
        const importTemplates = data.templates;
        const importCount = Object.keys(importTemplates).length;
        
        if (importCount === 0) {
            alert(&#39;导入数据中没有找到模板&#39;);
            return;
        }
        
        // 检查冲突
        const conflicts = Object.keys(importTemplates).filter(name => currentTemplates[name]);
        
        let shouldProceed = true;
        if (conflicts.length > 0) {
            shouldProceed = confirm(`发现 ${conflicts.length} 个同名模板：\n${conflicts.join(&#39;, &#39;)}\n\n确定要覆盖这些模板吗？`);
        }
        
        if (!shouldProceed) return;
        
        // 合并模板
        const mergedTemplates = { ...currentTemplates, ...importTemplates };
        savePreFillTemplates(mergedTemplates);
        updateTemplateSelect();
        
        alert(`成功导入 ${importCount} 个预填写模板！`);
        
    } catch (error) {
        console.error(&#39;导入模板失败:&#39;, error);
        alert(&#39;导入失败：&#39; + error.message);
    }
}

function getContractorPassword(contractorName) {
    // 从contractorPasswords对象中查找对应的密码
    for (const [password, name] of Object.entries(contractorPasswords)) {
        if (name === contractorName) {
            return password;
        }
    }
    return null;
}

function changeContractorPassword() {
    const select = document.getElementById(&#39;contractorPasswordSelect&#39;);
    const passwordInput = document.getElementById(&#39;newPasswordInput&#39;);
    const changeBtn = document.getElementById(&#39;changePasswordBtn&#39;);
    
    if (!select || !passwordInput || !changeBtn) return;
    
    const selectedContractor = select.value.trim();
    const newPassword = passwordInput.value.trim();
    
    // 验证选择
    if (!selectedContractor) {
        alert(&#39;请选择要修改密码的包工&#39;);
        select.focus();
        return;
    }
    
    // 验证新密码
    if (!newPassword) {
        alert(&#39;请输入新密码&#39;);
        passwordInput.focus();
        return;
    }
    
    if (!/^\d{6,8}$/.test(newPassword)) {
        alert(&#39;密码必须是6-8位数字&#39;);
        passwordInput.focus();
        return;
    }
    
    // 检查密码是否已被其他包工使用
    const existingContractor = contractorPasswords[newPassword];
    if (existingContractor &amp;&amp; existingContractor !== selectedContractor) {
        alert(`密码 "${newPassword}" 已被包工 "${existingContractor}" 使用，请选择其他密码`);
        passwordInput.focus();
        return;
    }
    
    // 确认更改
    const oldPassword = getContractorPassword(selectedContractor);
    const confirmMessage = oldPassword 
        ? `确定要将包工 "${selectedContractor}" 的密码从 "${oldPassword}" 更改为 "${newPassword}" 吗？`
        : `确定要为包工 "${selectedContractor}" 设置密码 "${newPassword}" 吗？`;
    
    if (!confirm(confirmMessage + &#39;\n\n更改后包工需使用新密码登录。&#39;)) {
        return;
    }
    
    // 显示处理状态
    changeBtn.disabled = true;
    changeBtn.innerHTML = &#39;<span class="iconify animate-spin" data-icon="heroicons:arrow-path" data-width="16"></span>&#39;;
    
    try {
        // 删除旧密码映射
        if (oldPassword) {
            delete contractorPasswords[oldPassword];
        }
        
        // 添加新密码映射
        contractorPasswords[newPassword] = selectedContractor;
        
        // 保存到本地存储
        saveContractorPasswords();
        
        // 清空输入
        passwordInput.value = &#39;&#39;;
        select.value = &#39;&#39;;
        
        // 更新显示
        updateContractorListDisplay();
        updateContractorPasswordSelect();
        
        // 显示成功提示
        passwordInput.style.backgroundColor = &#39;rgba(34, 197, 94, 0.2)&#39;;
        setTimeout(() => {
            passwordInput.style.backgroundColor = &#39;&#39;;
        }, 2000);
        
        alert(`包工 "${selectedContractor}" 的密码已成功更改为 "${newPassword}"！\n\n请通知该包工使用新密码登录。`);
        
    } catch (error) {
        console.error(&#39;更改密码失败:&#39;, error);
        alert(&#39;更改密码失败，请重试&#39;);
    } finally {
        // 恢复按钮状态
        changeBtn.disabled = false;
        changeBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:key" data-width="16"></span>更改&#39;;
    }
}

function saveContractorPasswords() {
    try {
        localStorage.setItem(&#39;dwoody_contractor_passwords&#39;, JSON.stringify(contractorPasswords));
    } catch (error) {
        console.error(&#39;保存包工密码失败:&#39;, error);
    }
}

function loadContractorPasswords() {
    try {
        const savedPasswords = localStorage.getItem(&#39;dwoody_contractor_passwords&#39;);
        if (savedPasswords) {
            const loadedPasswords = JSON.parse(savedPasswords);
            // 合并保存的密码和默认密码
            Object.assign(contractorPasswords, loadedPasswords);
        }
    } catch (error) {
console.error(&#39;加载包工密码失败:&#39;, error);
    }
}

// 管理员密码管理功能
function loadAdminPassword() {
    try {
        const savedPassword = localStorage.getItem(&#39;dwoody_admin_password&#39;);
        if (savedPassword) {
            correctPassword = savedPassword;
        }
    } catch (error) {
        console.error(&#39;加载管理员密码失败:&#39;, error);
    }
}

function saveAdminPassword() {
    try {
        localStorage.setItem(&#39;dwoody_admin_password&#39;, correctPassword);
    } catch (error) {
        console.error(&#39;保存管理员密码失败:&#39;, error);
    }
}

function changeAdminPassword() {
    const currentPasswordInput = document.getElementById(&#39;currentAdminPasswordInput&#39;);
    const newPasswordInput = document.getElementById(&#39;newAdminPasswordInput&#39;);
    const changeBtn = document.getElementById(&#39;changeAdminPasswordBtn&#39;);
    
    if (!currentPasswordInput || !newPasswordInput || !changeBtn) return;
    
    const currentPassword = currentPasswordInput.value.trim();
    const newPassword = newPasswordInput.value.trim();
    
    // 验证当前密码
    if (!currentPassword) {
        alert(&#39;请输入当前管理员密码&#39;);
        currentPasswordInput.focus();
        return;
    }
    
    if (currentPassword !== correctPassword) {
        alert(&#39;当前密码错误，请重新输入&#39;);
        currentPasswordInput.value = &#39;&#39;;
        currentPasswordInput.focus();
        
        // 添加错误动画
        currentPasswordInput.classList.add(&#39;animate-shake&#39;);
        setTimeout(() => {
            currentPasswordInput.classList.remove(&#39;animate-shake&#39;);
        }, 500);
        return;
    }
    
    // 验证新密码
    if (!newPassword) {
        alert(&#39;请输入新管理员密码&#39;);
        newPasswordInput.focus();
        return;
    }
    
    if (newPassword.length < 6 || newPassword.length > 8) {
        alert(&#39;新密码长度必须为6-8位&#39;);
        newPasswordInput.focus();
        return;
    }
    
    // 检查新密码是否与当前密码相同
    if (newPassword === currentPassword) {
        alert(&#39;新密码不能与当前密码相同&#39;);
        newPasswordInput.focus();
        return;
    }
    
    // 确认更改
    if (!confirm(`确定要将管理员密码更改为 "${newPassword}" 吗？\n\n更改后请使用新密码解锁编辑功能。\n请务必记住新密码，遗失将无法编辑数据！`)) {
        return;
    }
    
    // 显示处理状态
    changeBtn.disabled = true;
    changeBtn.innerHTML = &#39;<span class="iconify animate-spin" data-icon="heroicons:arrow-path" data-width="16"></span>&#39;;
    
    try {
        // 更新密码
        correctPassword = newPassword;
        
        // 保存到本地存储
        saveAdminPassword();
        
        // 清空输入框
        currentPasswordInput.value = &#39;&#39;;
        newPasswordInput.value = &#39;&#39;;
        
        // 显示成功提示
        newPasswordInput.style.backgroundColor = &#39;rgba(34, 197, 94, 0.2)&#39;;
        setTimeout(() => {
            newPasswordInput.style.backgroundColor = &#39;&#39;;
        }, 2000);
        
        alert(`管理员密码已成功更改为 "${newPassword}"！\n\n请使用新密码重新登录以继续编辑。`);
        
        // 自动退出登录状态，要求重新输入密码
        if (isUnlocked) {
            // 重置登录状态
            isUnlocked = false;
            isContractorMode = false;
            currentContractor = null;
            
            // 重置界面状态
            setInputsReadonly(true);
            showTableControls(false);
            updateDeleteButtonsVisibility();
            showAllRows();
            hidePasswordColumns();
            updateStorageButtonsState();
showContractorManagement(false);
            showAdminPasswordManagement(false);
            showPreFillSection(false);
            
            // 重置密码输入区域
            const passwordInput = document.getElementById(&#39;passwordInput&#39;);
            const passwordStatus = document.getElementById(&#39;passwordStatus&#39;);
            const unlockBtn = document.getElementById(&#39;unlockBtn&#39;);
            
            if (passwordInput &amp;&amp; passwordStatus &amp;&amp; unlockBtn) {
                passwordInput.value = &#39;&#39;;
                passwordInput.disabled = false;
                passwordStatus.innerHTML = &#39;<span class="text-info">密码已更改，请重新输入新密码解锁</span>&#39;;
                unlockBtn.textContent = &#39;解锁&#39;;
                unlockBtn.disabled = false;
                unlockBtn.classList.remove(&#39;btn-success&#39;, &#39;btn-info&#39;);
                unlockBtn.classList.add(&#39;btn-primary&#39;);
                passwordInput.focus();
            }
            
            if (currentView === &#39;calendar&#39;) {
                updateCalendarData();
            }
        }
        
    } catch (error) {
        console.error(&#39;更改管理员密码失败:&#39;, error);
        alert(&#39;更改密码失败，请重试&#39;);
    } finally {
        // 恢复按钮状态
        changeBtn.disabled = false;
changeBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:shield-exclamation" data-width="16"></span>更改&#39;;
    }
}

// 数据提取功能
function extractInstallationData() {
    if (!isUnlocked) {
        alert(&#39;请先输入管理员密码才能提取数据&#39;);
        return;
    }
    
    // 显示月份选择模态框
    showMonthSelectionModal();
}

function showMonthSelectionModal() {
    const installations = getInstallationData();
    
    if (installations.length === 0) {
        alert(&#39;没有找到安装数据&#39;);
        return;
    }
    
    // 过滤出有效的安装数据（至少有地址或安装日期）
    const validInstallations = installations.filter(inst => 
        inst.address.trim() || inst.installDate.trim()
    );
    
    if (validInstallations.length === 0) {
        alert(&#39;没有找到有效的安装数据（需要地址或安装日期）&#39;);
        return;
    }
    
    // 获取所有安装日期并按月份分组
    const monthlyData = {};
    validInstallations.forEach(inst => {
        if (inst.installDate &amp;&amp; inst.installDate.trim()) {
            const installDate = parseDateString(inst.installDate);
            if (installDate) {
                const monthKey = `${installDate.getFullYear()}-${String(installDate.getMonth() + 1).padStart(2, &#39;0&#39;)}`;
                const monthName = `${installDate.getFullYear()}年${installDate.getMonth() + 1}月`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        name: monthName,
                        count: 0,
                        installations: []
                    };
                }
                monthlyData[monthKey].count++;
                monthlyData[monthKey].installations.push(inst);
            }
        }
    });
    
    // 按月份排序
    const sortedMonths = Object.keys(monthlyData).sort().reverse();
    
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-md w-full max-h-96 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-primary" data-icon="heroicons:calendar-days" data-width="20"></span>
                    选择提取月份
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <div class="bg-info/10 border border-info/30 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="iconify text-info" data-icon="heroicons:information-circle" data-width="16"></span>
                    <span class="text-sm font-medium text-info">数据统计</span>
                </div>
                <div class="text-sm text-info">
                    总共找到 ${validInstallations.length} 条有效安装记录，分布在 ${sortedMonths.length} 个月份
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="space-y-2">
                    <!-- 提取全部数据选项 -->
                    <button onclick="showFieldSelectionModal(&#39;all&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-primary w-full flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="iconify" data-icon="heroicons:document-text" data-width="20"></span>
                            <span class="text-sm font-medium">提取全部数据</span>
                        </div>
                        <span class="badge badge-primary">${validInstallations.length} 项</span>
                    </button>
                    
                    ${sortedMonths.length > 0 ? `
                        <div class="divider text-xs">按月份选择</div>
                        
                        ${sortedMonths.map(monthKey => `
                            <button onclick="showFieldSelectionModal(&#39;${monthKey}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                                    class="btn btn-outline w-full flex items-center justify-between hover:btn-primary">
                                <div class="flex items-center gap-3">
                                    <span class="iconify" data-icon="heroicons:calendar" data-width="16"></span>
                                    <span class="text-sm">${monthlyData[monthKey].name}</span>
                                </div>
                                <span class="badge badge-outline">${monthlyData[monthKey].count} 项</span>
                            </button>
                        `).join(&#39;&#39;)}
                    ` : &#39;&#39;}
                </div>
            </div>
            
            <div class="text-xs text-base-content/70 text-center">
                选择要提取的月份范围，然后选择需要的字段内容
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 存储月份数据到全局变量
    window.currentMonthlyData = monthlyData;
    window.currentValidInstallations = validInstallations;
}

// 显示字段选择模态框
function showFieldSelectionModal(monthKey) {
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-md w-full max-h-96 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-success" data-icon="heroicons:check-circle" data-width="20"></span>
                    选择提取字段
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <div class="bg-success/10 border border-success/30 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="iconify text-success" data-icon="heroicons:information-circle" data-width="16"></span>
                    <span class="text-sm font-medium text-success">自定义提取内容</span>
                </div>
                <div class="text-sm text-success">
                    选择您需要提取的字段内容，可以多选或全选
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="space-y-3">
                    <!-- 全选选项 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3 p-3 bg-primary/10 rounded-lg">
                            <input type="checkbox" id="selectAllFields" class="checkbox checkbox-primary" onchange="toggleAllFields(this)" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-primary" data-icon="heroicons:check-circle" data-width="16"></span>
                                <span class="label-text font-medium">全选所有字段</span>
                            </div>
                        </label>
                    </div>
                    
                    <div class="divider text-xs">选择具体字段</div>
                    
                    <!-- 地址字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="extractField" value="address" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-info" data-icon="heroicons:map-pin" data-width="16"></span>
                                <span class="label-text">地址</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- 上货日期字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="extractField" value="deliveryDate" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-warning" data-icon="heroicons:truck" data-width="16"></span>
                                <span class="label-text">上货日期</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- 安装日期字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="extractField" value="installDate" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-primary" data-icon="heroicons:calendar-days" data-width="16"></span>
                                <span class="label-text">安装日期</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- 锁具密码字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="extractField" value="lock" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-error" data-icon="heroicons:key" data-width="16"></span>
                                <span class="label-text">锁具密码</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- 包工字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="extractField" value="subcontractor" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-accent" data-icon="heroicons:user-group" data-width="16"></span>
                                <span class="label-text">包工</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- 收工字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="extractField" value="designer" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-secondary" data-icon="heroicons:user" data-width="16"></span>
                                <span class="label-text">收工</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="performCustomExtraction(&#39;${monthKey}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                        class="btn btn-primary flex-1">
                    <span class="iconify" data-icon="heroicons:document-text" data-width="16"></span>
                    开始提取
                </button>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline">取消</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// 切换全选状态
function toggleAllFields(selectAllCheckbox) {
    const fieldCheckboxes = document.querySelectorAll(&#39;input[name="extractField"]&#39;);
    fieldCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

// 执行自定义字段提取
function performCustomExtraction(monthKey) {
    const extractBtn = document.getElementById(&#39;extractDataBtn&#39;);
    extractBtn.disabled = true;
    extractBtn.innerHTML = &#39;<span class="iconify animate-spin" data-icon="heroicons:arrow-path" data-width="16"></span><span class="text-sm">提取中...</span>&#39;;
    
    try {
        // 获取选中的字段
        const selectedFields = [];
        const fieldCheckboxes = document.querySelectorAll(&#39;input[name="extractField"]:checked&#39;);
        fieldCheckboxes.forEach(checkbox => {
            selectedFields.push(checkbox.value);
        });
        
        if (selectedFields.length === 0) {
            alert(&#39;请至少选择一个字段进行提取&#39;);
            return;
        }
        
        let targetInstallations;
        let reportTitle;
        
        if (monthKey === &#39;all&#39;) {
            targetInstallations = window.currentValidInstallations;
            reportTitle = &#39;全部数据&#39;;
        } else {
            targetInstallations = window.currentMonthlyData[monthKey].installations;
            reportTitle = window.currentMonthlyData[monthKey].name;
        }
        
        // 字段名称映射
        const fieldNames = {
            address: &#39;地址&#39;,
            deliveryDate: &#39;上货日期&#39;,
            installDate: &#39;安装日期&#39;,
            lock: &#39;锁具密码&#39;,
            subcontractor: &#39;包工&#39;,
            designer: &#39;收工&#39;
        };
        
        // 生成提取的数据文本
        let extractedText = `D WOODY HOME 安装数据提取报告\n`;
        extractedText += `提取范围：${reportTitle}\n`;
        extractedText += `提取字段：${selectedFields.map(field => fieldNames[field]).join(&#39;、&#39;)}\n`;
        extractedText += `提取时间：${new Date().toLocaleString(&#39;zh-CN&#39;)}\n`;
        extractedText += `数据条数：${targetInstallations.length}\n`;
        extractedText += `${&#39;=&#39;.repeat(50)}\n\n`;
        
        targetInstallations.forEach((inst, index) => {
            extractedText += `项目 ${index + 1}：\n`;
            
            selectedFields.forEach(field => {
                switch (field) {
                    case &#39;address&#39;:
                        extractedText += `地址：${inst.address || &#39;未填写&#39;}\n`;
                        break;
                    case &#39;deliveryDate&#39;:
                        let deliveryDate = &#39;未填写&#39;;
                        if (inst.installDate &amp;&amp; inst.installDate.trim()) {
                            const installDate = parseDateString(inst.installDate);
                            if (installDate) {
                                const delivery = new Date(installDate);
                                delivery.setDate(delivery.getDate() - 1);
                                deliveryDate = formatDateForDisplay(delivery);
                            }
                        }
                        extractedText += `上货日期：${deliveryDate}\n`;
                        break;
                    case &#39;installDate&#39;:
                        extractedText += `安装日期：${inst.installDate || &#39;未填写&#39;}\n`;
                        break;
                    case &#39;lock&#39;:
                        extractedText += `锁具密码：${inst.lock || &#39;未填写&#39;}\n`;
                        break;
                    case &#39;subcontractor&#39;:
                        extractedText += `包工：${inst.subcontractor || &#39;未填写&#39;}\n`;
                        break;
                    case &#39;designer&#39;:
                        extractedText += `收工：${inst.designer || &#39;未填写&#39;}\n`;
                        break;
                }
            });
            
            extractedText += `${&#39;-&#39;.repeat(30)}\n`;
        });
        
        extractedText += `\n提取完成 - D WOODY HOME 专业安装服务管理系统`;
        
        // 显示提取结果模态框
        showExtractedDataModal(extractedText, targetInstallations.length, reportTitle, targetInstallations, selectedFields);
        
    } catch (error) {
        console.error(&#39;数据提取失败:&#39;, error);
        alert(&#39;数据提取失败: &#39; + error.message);
    } finally {
        extractBtn.disabled = false;
        extractBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:clipboard-document-list" data-width="16"></span><span class="text-sm">提取安装数据</span>&#39;;
    }
}

function performExtraction(monthKey) {
    // 兼容旧版本调用，使用全字段提取
    window.currentSelectedFields = [&#39;address&#39;, &#39;deliveryDate&#39;, &#39;installDate&#39;, &#39;lock&#39;, &#39;subcontractor&#39;, &#39;designer&#39;];
    performCustomExtraction(monthKey);
}

function showExtractedDataModal(extractedText, dataCount, reportTitle = &#39;全部数据&#39;, targetInstallations = null, selectedFields = null) {
    const validInstallations = targetInstallations || getInstallationData().filter(inst => 
        inst.address.trim() || inst.installDate.trim()
    );
    
    // 字段名称映射
    const fieldNames = {
        address: &#39;地址&#39;,
        deliveryDate: &#39;上货日期&#39;,
        installDate: &#39;安装日期&#39;,
        lock: &#39;锁具密码&#39;,
        subcontractor: &#39;包工&#39;,
        designer: &#39;收工&#39;
    };
    
    // 如果没有指定字段，默认为全部字段
    const fields = selectedFields || [&#39;address&#39;, &#39;deliveryDate&#39;, &#39;installDate&#39;, &#39;lock&#39;, &#39;subcontractor&#39;, &#39;designer&#39;];
    const fieldNamesText = fields.map(field => fieldNames[field]).join(&#39;、&#39;);
    
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-full max-h-full overflow-hidden flex flex-col" style="width: 95vw; max-width: 700px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-success" data-icon="heroicons:check-circle" data-width="20"></span>
                    数据提取完成
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
<div class="bg-success/10 border border-success/30 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="iconify text-success" data-icon="heroicons:information-circle" data-width="16"></span>
                    <span class="text-sm font-medium text-success">提取结果</span>
                </div>
                <div class="text-sm text-success">
                    <div>提取范围：${reportTitle}</div>
                    <div>提取字段：${fieldNamesText}</div>
                    <div>成功提取 ${dataCount} 条安装记录</div>
                </div>
            </div>
            
            <!-- 视图切换按钮 -->
            <div class="flex gap-2 mb-4">
                <button id="listViewBtn" class="btn btn-primary btn-sm" onclick="switchExtractView(&#39;list&#39;)">
                    <span class="iconify" data-icon="heroicons:list-bullet" data-width="16"></span>
                    <span class="text-sm">列表视图</span>
                </button>
                <button id="textViewBtn" class="btn btn-outline btn-sm" onclick="switchExtractView(&#39;text&#39;)">
                    <span class="iconify" data-icon="heroicons:document-text" data-width="16"></span>
                    <span class="text-sm">文本视图</span>
                </button>
            </div>
            
<!-- 列表视图 -->
            <div id="listView" class="flex-1 overflow-y-auto mb-4">
                <div class="space-y-3">
${validInstallations.map((inst, index) => {
                        // 计算上货日期（安装日期的前一天）
                        let deliveryDate = &#39;未填写&#39;;
                        if (inst.installDate &amp;&amp; inst.installDate.trim()) {
                            const installDate = parseDateString(inst.installDate);
                            if (installDate) {
                                const delivery = new Date(installDate);
                                delivery.setDate(delivery.getDate() - 1);
                                deliveryDate = formatDateForDisplay(delivery);
                            }
                        }
                        
                        return `
                        <div class="bg-base-200 rounded-lg p-4 border border-base-300">
                            <div class="flex justify-between items-start mb-3">
                                <div class="font-medium text-sm text-primary">项目 ${index + 1}</div>
                                <div class="flex gap-2">
                                    <button onclick="copyInstallationData(${index})" 
                                            class="btn btn-xs btn-primary" 
                                            title="复制此项目数据">
                                        <span class="iconify" data-icon="heroicons:clipboard" data-width="12"></span>
                                    </button>
                                    <button onclick="shareInstallationData(${index})" 
                                            class="btn btn-xs btn-success" 
                                            title="分享此项目数据">
                                        <span class="iconify" data-icon="heroicons:share" data-width="12"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm">
                                ${fields.includes(&#39;address&#39;) ? `
                                    <div class="flex items-start gap-2">
                                        <span class="text-base-content/70 min-w-16">地址：</span>
                                        <span class="flex-1 break-words">${inst.address || &#39;未填写&#39;}</span>
                                        ${inst.address ? `
                                            <button onclick="copyAddressOnly(&#39;${inst.address.replace(/&#39;/g, "\\&#39;")}&#39;, ${index + 1})" 
                                                    class="btn btn-xs btn-outline" 
                                                    title="仅复制地址">
                                                <span class="iconify" data-icon="heroicons:map-pin" data-width="12"></span>
                                            </button>
                                        ` : &#39;&#39;}
                                    </div>
                                ` : &#39;&#39;}
                                ${fields.includes(&#39;deliveryDate&#39;) ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-base-content/70 min-w-16">上货：</span>
                                        <span class="flex-1">${deliveryDate}</span>
                                    </div>
                                ` : &#39;&#39;}
                                ${fields.includes(&#39;installDate&#39;) ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-base-content/70 min-w-16">安装：</span>
                                        <span class="flex-1">${inst.installDate || &#39;未填写&#39;}</span>
                                    </div>
                                ` : &#39;&#39;}
                                ${fields.includes(&#39;lock&#39;) ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-base-content/70 min-w-16">锁具：</span>
                                        <span class="flex-1">${inst.lock || &#39;未填写&#39;}</span>
                                    </div>
                                ` : &#39;&#39;}
                                ${fields.includes(&#39;subcontractor&#39;) ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-base-content/70 min-w-16">包工：</span>
                                        <span class="flex-1">${inst.subcontractor || &#39;未填写&#39;}</span>
                                    </div>
                                ` : &#39;&#39;}
                                ${fields.includes(&#39;designer&#39;) ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-base-content/70 min-w-16">收工：</span>
                                        <span class="flex-1">${inst.designer || &#39;未填写&#39;}</span>
                                    </div>
                                ` : &#39;&#39;}
                            </div>
                        </div>
                        `;
                    }).join(&#39;&#39;)}
                </div>
            </div>
            
            <!-- 文本视图 -->
            <div id="textView" class="flex-1 overflow-y-auto mb-4 hidden">
                <div class="text-sm text-base-content/70 mb-2">
                    完整数据文本：
                </div>
                <textarea readonly 
                          class="textarea textarea-bordered w-full h-full text-sm font-mono resize-none" 
                          onclick="this.select()"
                          style="font-family: &#39;SF Mono&#39;, &#39;Monaco&#39;, &#39;Inconsolata&#39;, &#39;Roboto Mono&#39;, monospace; line-height: 1.4;">${extractedText}</textarea>
            </div>
            
            <div class="flex gap-3">
                <button onclick="copyExtractedData(&#39;${extractedText.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                        class="btn btn-primary flex-1">
                    <span class="iconify" data-icon="heroicons:clipboard" data-width="16"></span>
                    复制全部数据
                </button>
                <button onclick="shareExtractedData(&#39;${extractedText.replace(/&#39;/g, "\\&#39;")}&#39;);" 
                        class="btn btn-success flex-1">
                    <span class="iconify" data-icon="heroicons:share" data-width="16"></span>
                    分享全部数据
                </button>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline">关闭</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
// 存储安装数据到全局变量，供复制和分享函数使用
    window.currentExtractedInstallations = validInstallations;
    window.currentSelectedFields = fields;
}

function copyExtractedData(text) {
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            alert(&#39;安装数据已复制到剪贴板！\n您可以粘贴到邮件、记事本或其他应用中。&#39;);
        }).catch(() => {
            fallbackCopyExtractedData(text);
        });
    } else {
        fallbackCopyExtractedData(text);
    }
}

function fallbackCopyExtractedData(text) {
    const textArea = document.createElement(&#39;textarea&#39;);
    textArea.value = text;
    textArea.style.position = &#39;fixed&#39;;
    textArea.style.left = &#39;-999999px&#39;;
    textArea.style.top = &#39;-999999px&#39;;
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand(&#39;copy&#39;);
        alert(&#39;安装数据已复制到剪贴板！&#39;);
    } catch (err) {
        alert(&#39;复制失败，请手动选择并复制文本。&#39;);
    }
    
    document.body.removeChild(textArea);
}

function shareExtractedData(text) {
    // 检查是否支持Web Share API
    if (navigator.share) {
        const fileName = `dwoody_installation_data_${new Date().toISOString().split(&#39;T&#39;)[0]}.txt`;
        
        // 创建文件对象
        const blob = new Blob([text], { type: &#39;text/plain;charset=utf-8&#39; });
        const file = new File([blob], fileName, { type: &#39;text/plain&#39; });
        
        navigator.share({
            title: &#39;D WOODY HOME 安装数据&#39;,
            text: &#39;安装服务数据提取报告&#39;,
            files: [file]
        }).then(() => {
            alert(&#39;数据分享成功！&#39;);
        }).catch((error) => {
            console.log(&#39;分享失败，使用复制功能:&#39;, error);
            copyExtractedData(text);
        });
    } else {
        // 备用方案：复制到剪贴板
        copyExtractedData(text);
    }
}

// 视图切换功能
function switchExtractView(viewType) {
    const listView = document.getElementById(&#39;listView&#39;);
    const textView = document.getElementById(&#39;textView&#39;);
    const listViewBtn = document.getElementById(&#39;listViewBtn&#39;);
    const textViewBtn = document.getElementById(&#39;textViewBtn&#39;);
    
    if (viewType === &#39;list&#39;) {
        listView.classList.remove(&#39;hidden&#39;);
        textView.classList.add(&#39;hidden&#39;);
        listViewBtn.classList.remove(&#39;btn-outline&#39;);
        listViewBtn.classList.add(&#39;btn-primary&#39;);
        textViewBtn.classList.add(&#39;btn-outline&#39;);
        textViewBtn.classList.remove(&#39;btn-primary&#39;);
    } else {
        listView.classList.add(&#39;hidden&#39;);
        textView.classList.remove(&#39;hidden&#39;);
        textViewBtn.classList.remove(&#39;btn-outline&#39;);
        textViewBtn.classList.add(&#39;btn-primary&#39;);
        listViewBtn.classList.add(&#39;btn-outline&#39;);
        listViewBtn.classList.remove(&#39;btn-primary&#39;);
    }
}

// 复制单个安装项目数据
function copyInstallationData(index) {
    if (!window.currentExtractedInstallations || !window.currentExtractedInstallations[index]) {
        alert(&#39;数据不可用&#39;);
        return;
    }
    
    const inst = window.currentExtractedInstallations[index];
    const fields = window.currentSelectedFields || [&#39;address&#39;, &#39;deliveryDate&#39;, &#39;installDate&#39;, &#39;lock&#39;, &#39;subcontractor&#39;, &#39;designer&#39;];
    
    // 计算上货日期（安装日期的前一天）
    let deliveryDate = &#39;未填写&#39;;
    if (inst.installDate &amp;&amp; inst.installDate.trim()) {
        const installDate = parseDateString(inst.installDate);
        if (installDate) {
            const delivery = new Date(installDate);
            delivery.setDate(delivery.getDate() - 1);
            deliveryDate = formatDateForDisplay(delivery);
        }
    }
    
    let installationText = `D WOODY HOME 安装项目 ${index + 1}\n` +
        `提取时间：${new Date().toLocaleString(&#39;zh-CN&#39;)}\n` +
        `${&#39;=&#39;.repeat(30)}\n\n`;
    
    // 根据选中的字段生成内容
    if (fields.includes(&#39;address&#39;)) {
        installationText += `地址：${inst.address || &#39;未填写&#39;}\n`;
    }
    if (fields.includes(&#39;deliveryDate&#39;)) {
        installationText += `上货日期：${deliveryDate}\n`;
    }
    if (fields.includes(&#39;installDate&#39;)) {
        installationText += `安装日期：${inst.installDate || &#39;未填写&#39;}\n`;
    }
    if (fields.includes(&#39;lock&#39;)) {
        installationText += `锁具密码：${inst.lock || &#39;未填写&#39;}\n`;
    }
    if (fields.includes(&#39;subcontractor&#39;)) {
        installationText += `包工：${inst.subcontractor || &#39;未填写&#39;}\n`;
    }
    if (fields.includes(&#39;designer&#39;)) {
        installationText += `收工：${inst.designer || &#39;未填写&#39;}\n`;
    }
    
    installationText += `\nD WOODY HOME 专业安装服务管理系统`;
    
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(installationText).then(() => {
            alert(`项目 ${index + 1} 的数据已复制到剪贴板！`);
        }).catch(() => {
            fallbackCopyExtractedData(installationText);
        });
    } else {
        fallbackCopyExtractedData(installationText);
    }
}

// 分享单个安装项目数据
function shareInstallationData(index) {
    if (!window.currentExtractedInstallations || !window.currentExtractedInstallations[index]) {
        alert(&#39;数据不可用&#39;);
        return;
    }
    
    const inst = window.currentExtractedInstallations[index];
    const fields = window.currentSelectedFields || [&#39;address&#39;, &#39;deliveryDate&#39;, &#39;installDate&#39;, &#39;lock&#39;, &#39;subcontractor&#39;, &#39;designer&#39;];
    
    // 计算上货日期（安装日期的前一天）
    let deliveryDate = &#39;未填写&#39;;
    if (inst.installDate &amp;&amp; inst.installDate.trim()) {
        const installDate = parseDateString(inst.installDate);
        if (installDate) {
            const delivery = new Date(installDate);
            delivery.setDate(delivery.getDate() - 1);
            deliveryDate = formatDateForDisplay(delivery);
        }
    }
    
    let installationText = `D WOODY HOME 安装项目 ${index + 1}\n` +
        `提取时间：${new Date().toLocaleString(&#39;zh-CN&#39;)}\n` +
        `${&#39;=&#39;.repeat(30)}\n\n`;
    
    // 根据选中的字段生成内容
    if (fields.includes(&#39;address&#39;)) {
        installationText += `地址：${inst.address || &#39;未填写&#39;}\n`;
    }
    if (fields.includes(&#39;deliveryDate&#39;)) {
        installationText += `上货日期：${deliveryDate}\n`;
    }
    if (fields.includes(&#39;installDate&#39;)) {
        installationText += `安装日期：${inst.installDate || &#39;未填写&#39;}\n`;
    }
    if (fields.includes(&#39;lock&#39;)) {
        installationText += `锁具密码：${inst.lock || &#39;未填写&#39;}\n`;
    }
    if (fields.includes(&#39;subcontractor&#39;)) {
        installationText += `包工：${inst.subcontractor || &#39;未填写&#39;}\n`;
    }
    if (fields.includes(&#39;designer&#39;)) {
        installationText += `收工：${inst.designer || &#39;未填写&#39;}\n`;
    }
    
    installationText += `\nD WOODY HOME 专业安装服务管理系统`;
    
    // 检查是否支持Web Share API
    if (navigator.share) {
        const fileName = `dwoody_project_${index + 1}_${new Date().toISOString().split(&#39;T&#39;)[0]}.txt`;
        
        // 创建文件对象
        const blob = new Blob([installationText], { type: &#39;text/plain;charset=utf-8&#39; });
        const file = new File([blob], fileName, { type: &#39;text/plain&#39; });
        
        navigator.share({
            title: `D WOODY HOME 安装项目 ${index + 1}`,
            text: &#39;安装项目详细信息&#39;,
            files: [file]
        }).then(() => {
            alert(`项目 ${index + 1} 分享成功！`);
        }).catch((error) => {
            console.log(&#39;分享失败，使用复制功能:&#39;, error);
            copyInstallationData(index);
        });
    } else {
        // 备用方案：复制到剪贴板
        copyInstallationData(index);
    }
}

// 仅复制地址
function copyAddressOnly(address, projectNumber) {
    if (!address || address.trim() === &#39;&#39;) {
        alert(&#39;地址为空，无法复制&#39;);
        return;
    }
    
    const addressText = `项目 ${projectNumber} 地址：\n${address}`;
    
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(addressText).then(() => {
            alert(`项目 ${projectNumber} 的地址已复制到剪贴板！`);
        }).catch(() => {
            fallbackCopyAddress(addressText);
        });
    } else {
        fallbackCopyAddress(addressText);
    }
}

// 华语翻译英文功能
function extractAndTranslateData() {
    if (!isUnlocked) {
        alert(&#39;请先输入管理员密码才能提取和翻译数据&#39;);
        return;
    }
    
    // 显示月份选择模态框（翻译版本）
    showTranslateMonthSelectionModal();
}

function showTranslateMonthSelectionModal() {
    const installations = getInstallationData();
    
    if (installations.length === 0) {
        alert(&#39;没有找到安装数据&#39;);
        return;
    }
    
    // 过滤出有效的安装数据（至少有地址或安装日期）
    const validInstallations = installations.filter(inst => 
        inst.address.trim() || inst.installDate.trim()
    );
    
    if (validInstallations.length === 0) {
        alert(&#39;没有找到有效的安装数据（需要地址或安装日期）&#39;);
        return;
    }
    
    // 获取所有安装日期并按月份分组
    const monthlyData = {};
    validInstallations.forEach(inst => {
        if (inst.installDate &amp;&amp; inst.installDate.trim()) {
            const installDate = parseDateString(inst.installDate);
            if (installDate) {
                const monthKey = `${installDate.getFullYear()}-${String(installDate.getMonth() + 1).padStart(2, &#39;0&#39;)}`;
                const monthName = `${installDate.getFullYear()}年${installDate.getMonth() + 1}月`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        name: monthName,
                        count: 0,
                        installations: []
                    };
                }
                monthlyData[monthKey].count++;
                monthlyData[monthKey].installations.push(inst);
            }
        }
    });
    
    // 按月份排序
    const sortedMonths = Object.keys(monthlyData).sort().reverse();
    
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-md w-full max-h-96 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-success" data-icon="heroicons:language" data-width="20"></span>
                    选择翻译月份
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <div class="bg-success/10 border border-success/30 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="iconify text-success" data-icon="heroicons:information-circle" data-width="16"></span>
                    <span class="text-sm font-medium text-success">翻译统计</span>
                </div>
                <div class="text-sm text-success">
                    总共找到 ${validInstallations.length} 条有效安装记录，将翻译为英文版本
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="space-y-2">
                    <!-- 翻译全部数据选项 -->
                    <button onclick="showTranslateFieldSelectionModal(&#39;all&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-success w-full flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="iconify" data-icon="heroicons:language" data-width="20"></span>
                            <span class="text-sm font-medium">翻译全部数据</span>
                        </div>
                        <span class="badge badge-success">${validInstallations.length} 项</span>
                    </button>
                    
                    ${sortedMonths.length > 0 ? `
                        <div class="divider text-xs">按月份选择</div>
                        
                        ${sortedMonths.map(monthKey => `
                            <button onclick="showTranslateFieldSelectionModal(&#39;${monthKey}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                                    class="btn btn-outline btn-success w-full flex items-center justify-between hover:btn-success">
                                <div class="flex items-center gap-3">
                                    <span class="iconify" data-icon="heroicons:calendar" data-width="16"></span>
                                    <span class="text-sm">${monthlyData[monthKey].name}</span>
                                </div>
                                <span class="badge badge-outline">${monthlyData[monthKey].count} 项</span>
                            </button>
                        `).join(&#39;&#39;)}
                    ` : &#39;&#39;}
                </div>
            </div>
            
            <div class="text-xs text-base-content/70 text-center">
                选择要翻译的月份范围，然后选择需要的字段内容
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 存储月份数据到全局变量
    window.currentTranslateMonthlyData = monthlyData;
    window.currentTranslateValidInstallations = validInstallations;
}

// 显示翻译字段选择模态框
function showTranslateFieldSelectionModal(monthKey) {
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-md w-full max-h-96 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-success" data-icon="heroicons:language" data-width="20"></span>
                    选择翻译字段
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <div class="bg-success/10 border border-success/30 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="iconify text-success" data-icon="heroicons:information-circle" data-width="16"></span>
                    <span class="text-sm font-medium text-success">自定义翻译内容</span>
                </div>
                <div class="text-sm text-success">
                    选择您需要翻译的字段内容，可以多选或全选
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="space-y-3">
                    <!-- 全选选项 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3 p-3 bg-success/10 rounded-lg">
                            <input type="checkbox" id="selectAllTranslateFields" class="checkbox checkbox-success" onchange="toggleAllTranslateFields(this)" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-success" data-icon="heroicons:check-circle" data-width="16"></span>
                                <span class="label-text font-medium">全选所有字段</span>
                            </div>
                        </label>
                    </div>
                    
                    <div class="divider text-xs">选择具体字段</div>
                    
                    <!-- 地址字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="translateField" value="address" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-info" data-icon="heroicons:map-pin" data-width="16"></span>
                                <span class="label-text">地址</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- 上货日期字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="translateField" value="deliveryDate" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-warning" data-icon="heroicons:truck" data-width="16"></span>
                                <span class="label-text">上货日期</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- 安装日期字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="translateField" value="installDate" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-primary" data-icon="heroicons:calendar-days" data-width="16"></span>
                                <span class="label-text">安装日期</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- 锁具密码字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="translateField" value="lock" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-error" data-icon="heroicons:key" data-width="16"></span>
                                <span class="label-text">锁具密码</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- 包工字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="translateField" value="subcontractor" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-accent" data-icon="heroicons:user-group" data-width="16"></span>
                                <span class="label-text">包工</span>
                            </div>
                        </label>
                    </div>
                    
                    <!-- 收工字段 -->
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="translateField" value="designer" class="checkbox checkbox-sm" checked />
                            <div class="flex items-center gap-2">
                                <span class="iconify text-secondary" data-icon="heroicons:user" data-width="16"></span>
                                <span class="label-text">收工</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="performCustomTranslation(&#39;${monthKey}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                        class="btn btn-success flex-1">
                    <span class="iconify" data-icon="heroicons:language" data-width="16"></span>
                    开始翻译
                </button>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline">取消</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// 切换翻译全选状态
function toggleAllTranslateFields(selectAllCheckbox) {
    const fieldCheckboxes = document.querySelectorAll(&#39;input[name="translateField"]&#39;);
    fieldCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

// 执行自定义字段翻译
function performCustomTranslation(monthKey) {
    const translateBtn = document.getElementById(&#39;translateDataBtn&#39;);
    translateBtn.disabled = true;
    translateBtn.innerHTML = &#39;<span class="iconify animate-spin" data-icon="heroicons:arrow-path" data-width="16"></span><span class="text-sm">翻译中...</span>&#39;;
    
    try {
        // 获取选中的字段
        const selectedFields = [];
        const fieldCheckboxes = document.querySelectorAll(&#39;input[name="translateField"]:checked&#39;);
        fieldCheckboxes.forEach(checkbox => {
            selectedFields.push(checkbox.value);
        });
        
        if (selectedFields.length === 0) {
            alert(&#39;请至少选择一个字段进行翻译&#39;);
            return;
        }
        
        let targetInstallations;
        let reportTitle;
        
        if (monthKey === &#39;all&#39;) {
            targetInstallations = window.currentTranslateValidInstallations;
            reportTitle = &#39;All Data&#39;;
        } else {
            targetInstallations = window.currentTranslateMonthlyData[monthKey].installations;
            reportTitle = window.currentTranslateMonthlyData[monthKey].name;
        }
        
        // 翻译安装数据
        const translatedInstallations = targetInstallations.map(inst => ({
            ...inst,
            addressEn: translateChineseToEnglish(inst.address),
            subcontractorEn: translateChineseToEnglish(inst.subcontractor),
            designerEn: translateChineseToEnglish(inst.designer)
        }));
        
        // 字段名称映射（英文）
        const fieldNamesEn = {
            address: &#39;Address&#39;,
            deliveryDate: &#39;Delivery Date&#39;,
            installDate: &#39;Installation Date&#39;,
            lock: &#39;Lock Password&#39;,
            subcontractor: &#39;Contractor&#39;,
            designer: &#39;Designer&#39;
        };
        
        // 生成英文版本的数据文本
        let extractedText = `D WOODY HOME Installation Data Report\n`;
        extractedText += `Extract Range: ${reportTitle}\n`;
        extractedText += `Extract Fields: ${selectedFields.map(field => fieldNamesEn[field]).join(&#39;, &#39;)}\n`;
        extractedText += `Extract Time: ${new Date().toLocaleString(&#39;en-US&#39;)}\n`;
        extractedText += `Data Count: ${targetInstallations.length}\n`;
        extractedText += `${&#39;=&#39;.repeat(50)}\n\n`;
        
        translatedInstallations.forEach((inst, index) => {
            extractedText += `Project ${index + 1}:\n`;
            
            selectedFields.forEach(field => {
                switch (field) {
                    case &#39;address&#39;:
                        extractedText += `Address: ${inst.addressEn || &#39;Not filled&#39;}\n`;
                        break;
                    case &#39;deliveryDate&#39;:
                        let deliveryDateEn = &#39;Not filled&#39;;
                        if (inst.installDate &amp;&amp; inst.installDate.trim()) {
                            const installDate = parseDateString(inst.installDate);
                            if (installDate) {
                                const delivery = new Date(installDate);
                                delivery.setDate(delivery.getDate() - 1);
                                deliveryDateEn = delivery.toLocaleDateString(&#39;en-US&#39;);
                            }
                        }
                        extractedText += `Delivery Date: ${deliveryDateEn}\n`;
                        break;
                    case &#39;installDate&#39;:
                        extractedText += `Installation Date: ${inst.installDate ? new Date(inst.installDate).toLocaleDateString(&#39;en-US&#39;) : &#39;Not filled&#39;}\n`;
                        break;
                    case &#39;lock&#39;:
                        extractedText += `Lock Password: ${inst.lock || &#39;Not filled&#39;}\n`;
                        break;
                    case &#39;subcontractor&#39;:
                        extractedText += `Contractor: ${inst.subcontractorEn || &#39;Not filled&#39;}\n`;
                        break;
                    case &#39;designer&#39;:
                        extractedText += `Designer: ${inst.designerEn || &#39;Not filled&#39;}\n`;
                        break;
                }
            });
            
            extractedText += `${&#39;-&#39;.repeat(30)}\n`;
        });
        
        extractedText += `\nExtraction Complete - D WOODY HOME Professional Installation Service Management System`;
        
        // 显示翻译结果模态框
        showTranslatedDataModal(extractedText, translatedInstallations, reportTitle, selectedFields);
        
    } catch (error) {
        console.error(&#39;数据提取和翻译失败:&#39;, error);
        alert(&#39;数据提取和翻译失败: &#39; + error.message);
    } finally {
        translateBtn.disabled = false;
        translateBtn.innerHTML = &#39;<span class="iconify" data-icon="heroicons:language" data-width="16"></span><span class="text-sm">提取并翻译英文</span>&#39;;
    }
}

function performTranslation(monthKey) {
    // 兼容旧版本调用，使用全字段翻译
    window.currentSelectedTranslateFields = [&#39;address&#39;, &#39;deliveryDate&#39;, &#39;installDate&#39;, &#39;lock&#39;, &#39;subcontractor&#39;, &#39;designer&#39;];
    performCustomTranslation(monthKey);
}

// 简单的中文到英文翻译函数
function translateChineseToEnglish(chineseText) {
    if (!chineseText || chineseText.trim() === &#39;&#39;) {
        return &#39;&#39;;
    }
    
    // 常用地址词汇翻译字典
    const translations = {
        // 地区和城市
        &#39;新加坡&#39;: &#39;Singapore&#39;,
        &#39;马来西亚&#39;: &#39;Malaysia&#39;,
        &#39;吉隆坡&#39;: &#39;Kuala Lumpur&#39;,
        &#39;槟城&#39;: &#39;Penang&#39;,
        &#39;柔佛&#39;: &#39;Johor&#39;,
        &#39;雪兰莪&#39;: &#39;Selangor&#39;,
        &#39;霹雳&#39;: &#39;Perak&#39;,
        &#39;彭亨&#39;: &#39;Pahang&#39;,
        &#39;登嘉楼&#39;: &#39;Terengganu&#39;,
        &#39;吉兰丹&#39;: &#39;Kelantan&#39;,
        &#39;玻璃市&#39;: &#39;Perlis&#39;,
        &#39;吉打&#39;: &#39;Kedah&#39;,
        &#39;森美兰&#39;: &#39;Negeri Sembilan&#39;,
        &#39;马六甲&#39;: &#39;Melaka&#39;,
        &#39;沙巴&#39;: &#39;Sabah&#39;,
        &#39;砂拉越&#39;: &#39;Sarawak&#39;,
        
        // 街道和建筑类型
        &#39;路&#39;: &#39;Road&#39;,
        &#39;街&#39;: &#39;Street&#39;,
        &#39;巷&#39;: &#39;Lane&#39;,
        &#39;大道&#39;: &#39;Avenue&#39;,
        &#39;花园&#39;: &#39;Garden&#39;,
        &#39;公园&#39;: &#39;Park&#39;,
        &#39;广场&#39;: &#39;Plaza&#39;,
        &#39;中心&#39;: &#39;Centre&#39;,
        &#39;购物中心&#39;: &#39;Shopping Centre&#39;,
        &#39;商场&#39;: &#39;Mall&#39;,
        &#39;大厦&#39;: &#39;Building&#39;,
        &#39;塔&#39;: &#39;Tower&#39;,
        &#39;阁&#39;: &#39;Court&#39;,
        &#39;苑&#39;: &#39;Garden&#39;,
        &#39;村&#39;: &#39;Village&#39;,
        &#39;镇&#39;: &#39;Town&#39;,
        &#39;市&#39;: &#39;City&#39;,
        &#39;区&#39;: &#39;District&#39;,
        &#39;县&#39;: &#39;County&#39;,
        &#39;州&#39;: &#39;State&#39;,
        
        // 建筑物和房屋类型
        &#39;公寓&#39;: &#39;Apartment&#39;,
        &#39;排屋&#39;: &#39;Terrace House&#39;,
        &#39;半独立式&#39;: &#39;Semi-Detached&#39;,
        &#39;独立式&#39;: &#39;Detached House&#39;,
        &#39;别墅&#39;: &#39;Villa&#39;,
        &#39;组屋&#39;: &#39;HDB Flat&#39;,
        &#39;私人公寓&#39;: &#39;Condominium&#39;,
        &#39;服务式公寓&#39;: &#39;Serviced Apartment&#39;,
        &#39;办公室&#39;: &#39;Office&#39;,
        &#39;店屋&#39;: &#39;Shophouse&#39;,
        &#39;工厂&#39;: &#39;Factory&#39;,
        &#39;仓库&#39;: &#39;Warehouse&#39;,
        
        // 方向和位置
        &#39;东&#39;: &#39;East&#39;,
        &#39;西&#39;: &#39;West&#39;,
        &#39;南&#39;: &#39;South&#39;,
        &#39;北&#39;: &#39;North&#39;,
        &#39;中&#39;: &#39;Central&#39;,
        &#39;上&#39;: &#39;Upper&#39;,
        &#39;下&#39;: &#39;Lower&#39;,
        &#39;新&#39;: &#39;New&#39;,
        &#39;旧&#39;: &#39;Old&#39;,
        &#39;大&#39;: &#39;Great&#39;,
        &#39;小&#39;: &#39;Little&#39;,
        
        // 楼层和单位
        &#39;楼&#39;: &#39;Floor&#39;,
        &#39;层&#39;: &#39;Level&#39;,
        &#39;单位&#39;: &#39;Unit&#39;,
        &#39;号&#39;: &#39;No.&#39;,
        &#39;座&#39;: &#39;Block&#39;,
        &#39;栋&#39;: &#39;Block&#39;,
        &#39;幢&#39;: &#39;Block&#39;,
        
        // 人名常用翻译
        &#39;家庆&#39;: &#39;Jia Qing&#39;,
        &#39;大安&#39;: &#39;Da An&#39;,
        &#39;啊俊&#39;: &#39;Ah Jun&#39;,
        
        // 其他常用词
        &#39;附近&#39;: &#39;Near&#39;,
        &#39;对面&#39;: &#39;Opposite&#39;,
        &#39;旁边&#39;: &#39;Beside&#39;,
        &#39;里面&#39;: &#39;Inside&#39;,
        &#39;外面&#39;: &#39;Outside&#39;,
        &#39;前面&#39;: &#39;Front&#39;,
        &#39;后面&#39;: &#39;Back&#39;,
        &#39;左边&#39;: &#39;Left&#39;,
        &#39;右边&#39;: &#39;Right&#39;
    };
    
    let translatedText = chineseText;
    
    // 应用翻译字典
    for (const [chinese, english] of Object.entries(translations)) {
        const regex = new RegExp(chinese, &#39;g&#39;);
        translatedText = translatedText.replace(regex, english);
    }
    
    // 处理数字和特殊字符
    translatedText = translatedText
        .replace(/第(\d+)/g, &#39;$1st&#39;)
        .replace(/(\d+)号/g, &#39;No. $1&#39;)
        .replace(/(\d+)楼/g, &#39;Floor $1&#39;)
        .replace(/(\d+)层/g, &#39;Level $1&#39;)
        .replace(/单位(\w+)/g, &#39;Unit $1&#39;)
        .replace(/座(\w+)/g, &#39;Block $1&#39;);
    
    return translatedText;
}

// 显示翻译数据模态框
function showTranslatedDataModal(extractedText, translatedInstallations, reportTitle = &#39;All Data&#39;, selectedFields = null) {
// 字段名称映射（英文）
    const fieldNamesEn = {
        address: &#39;Address&#39;,
        deliveryDate: &#39;Delivery Date&#39;,
        installDate: &#39;Installation Date&#39;,
        lock: &#39;Lock Password&#39;,
        subcontractor: &#39;Contractor&#39;,
        designer: &#39;Designer&#39;
    };
    
    // 如果没有指定字段，默认为全部字段
    const fields = selectedFields || [&#39;address&#39;, &#39;deliveryDate&#39;, &#39;installDate&#39;, &#39;lock&#39;, &#39;subcontractor&#39;, &#39;designer&#39;];
    const fieldNamesText = fields.map(field => fieldNamesEn[field]).join(&#39;, &#39;);
    
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-full max-h-full overflow-hidden flex flex-col" style="width: 95vw; max-width: 700px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-success" data-icon="heroicons:language" data-width="20"></span>
                    英文翻译完成
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <div class="bg-success/10 border border-success/30 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="iconify text-success" data-icon="heroicons:check-circle" data-width="16"></span>
                    <span class="text-sm font-medium text-success">翻译结果</span>
                </div>
                <div class="text-sm text-success">
                    <div>翻译范围：${reportTitle}</div>
                    <div>翻译字段：${fieldNamesText}</div>
                    <div>成功提取并翻译 ${translatedInstallations.length} 条安装记录为英文版本</div>
                </div>
            </div>
            
            <!-- 视图切换按钮 -->
            <div class="flex gap-2 mb-4">
                <button id="englishListViewBtn" class="btn btn-primary btn-sm" onclick="switchTranslatedView(&#39;list&#39;)">
                    <span class="iconify" data-icon="heroicons:list-bullet" data-width="16"></span>
                    <span class="text-sm">英文列表</span>
                </button>
                <button id="englishTextViewBtn" class="btn btn-outline btn-sm" onclick="switchTranslatedView(&#39;text&#39;)">
                    <span class="iconify" data-icon="heroicons:document-text" data-width="16"></span>
                    <span class="text-sm">英文文本</span>
                </button>
            </div>
            
            <!-- 英文列表视图 -->
            <div id="englishListView" class="flex-1 overflow-y-auto mb-4">
                <div class="space-y-3">
${translatedInstallations.map((inst, index) => {
                        // 计算上货日期
                        let deliveryDateEn = &#39;Not filled&#39;;
                        if (inst.installDate &amp;&amp; inst.installDate.trim()) {
                            const installDate = parseDateString(inst.installDate);
                            if (installDate) {
                                const delivery = new Date(installDate);
                                delivery.setDate(delivery.getDate() - 1);
                                deliveryDateEn = delivery.toLocaleDateString(&#39;en-US&#39;);
                            }
                        }
                        
                        return `
                        <div class="bg-base-200 rounded-lg p-4 border border-base-300">
                            <div class="flex justify-between items-start mb-3">
                                <div class="font-medium text-sm text-primary">Project ${index + 1}</div>
                                <div class="flex gap-2">
                                    <button onclick="copyTranslatedInstallationData(${index})" 
                                            class="btn btn-xs btn-primary" 
                                            title="复制英文数据">
                                        <span class="iconify" data-icon="heroicons:clipboard" data-width="12"></span>
                                    </button>
                                    <button onclick="shareTranslatedInstallationData(${index})" 
                                            class="btn btn-xs btn-success" 
                                            title="分享英文数据">
                                        <span class="iconify" data-icon="heroicons:share" data-width="12"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm">
                                ${fields.includes(&#39;address&#39;) ? `
                                    <div class="flex items-start gap-2">
                                        <span class="text-base-content/70 min-w-16">Address:</span>
                                        <span class="flex-1 break-words">${inst.addressEn || &#39;Not filled&#39;}</span>
                                        ${inst.addressEn ? `
                                            <button onclick="copyAddressOnly(&#39;${inst.addressEn.replace(/&#39;/g, "\\&#39;")}&#39;, ${index + 1})" 
                                                    class="btn btn-xs btn-outline" 
                                                    title="仅复制地址">
                                                <span class="iconify" data-icon="heroicons:map-pin" data-width="12"></span>
                                            </button>
                                        ` : &#39;&#39;}
                                    </div>
                                ` : &#39;&#39;}
                                ${fields.includes(&#39;deliveryDate&#39;) ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-base-content/70 min-w-16">Delivery:</span>
                                        <span class="flex-1">${deliveryDateEn}</span>
                                    </div>
                                ` : &#39;&#39;}
                                ${fields.includes(&#39;installDate&#39;) ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-base-content/70 min-w-16">Install:</span>
                                        <span class="flex-1">${inst.installDate ? new Date(inst.installDate).toLocaleDateString(&#39;en-US&#39;) : &#39;Not filled&#39;}</span>
                                    </div>
                                ` : &#39;&#39;}
                                ${fields.includes(&#39;lock&#39;) ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-base-content/70 min-w-16">Lock:</span>
                                        <span class="flex-1">${inst.lock || &#39;Not filled&#39;}</span>
                                    </div>
                                ` : &#39;&#39;}
                                ${fields.includes(&#39;subcontractor&#39;) ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-base-content/70 min-w-16">Contractor:</span>
                                        <span class="flex-1">${inst.subcontractorEn || &#39;Not filled&#39;}</span>
                                    </div>
                                ` : &#39;&#39;}
                                ${fields.includes(&#39;designer&#39;) ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-base-content/70 min-w-16">Designer:</span>
                                        <span class="flex-1">${inst.designerEn || &#39;Not filled&#39;}</span>
                                    </div>
                                ` : &#39;&#39;}
                            </div>
                        </div>
                        `;
                    }).join(&#39;&#39;)}
                </div>
            </div>
            
            <!-- 英文文本视图 -->
            <div id="englishTextView" class="flex-1 overflow-y-auto mb-4 hidden">
                <div class="text-sm text-base-content/70 mb-2">
                    完整英文数据文本：
                </div>
                <textarea readonly 
                          class="textarea textarea-bordered w-full h-full text-sm font-mono resize-none" 
                          onclick="this.select()"
                          style="font-family: &#39;SF Mono&#39;, &#39;Monaco&#39;, &#39;Inconsolata&#39;, &#39;Roboto Mono&#39;, monospace; line-height: 1.4;">${extractedText}</textarea>
            </div>
            
            <div class="flex gap-3">
                <button onclick="copyTranslatedData(&#39;${extractedText.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                        class="btn btn-primary flex-1">
                    <span class="iconify" data-icon="heroicons:clipboard" data-width="16"></span>
                    复制英文数据
                </button>
                <button onclick="shareTranslatedData(&#39;${extractedText.replace(/&#39;/g, "\\&#39;")}&#39;);" 
                        class="btn btn-success flex-1">
                    <span class="iconify" data-icon="heroicons:share" data-width="16"></span>
                    分享英文数据
                </button>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline">关闭</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
// 存储翻译数据到全局变量
    window.currentTranslatedInstallations = translatedInstallations;
    window.currentSelectedTranslateFields = fields;
}

// 翻译视图切换功能
function switchTranslatedView(viewType) {
    const listView = document.getElementById(&#39;englishListView&#39;);
    const textView = document.getElementById(&#39;englishTextView&#39;);
    const listViewBtn = document.getElementById(&#39;englishListViewBtn&#39;);
    const textViewBtn = document.getElementById(&#39;englishTextViewBtn&#39;);
    
    if (viewType === &#39;list&#39;) {
        listView.classList.remove(&#39;hidden&#39;);
        textView.classList.add(&#39;hidden&#39;);
        listViewBtn.classList.remove(&#39;btn-outline&#39;);
        listViewBtn.classList.add(&#39;btn-primary&#39;);
        textViewBtn.classList.add(&#39;btn-outline&#39;);
        textViewBtn.classList.remove(&#39;btn-primary&#39;);
    } else {
        listView.classList.add(&#39;hidden&#39;);
        textView.classList.remove(&#39;hidden&#39;);
        textViewBtn.classList.remove(&#39;btn-outline&#39;);
        textViewBtn.classList.add(&#39;btn-primary&#39;);
        listViewBtn.classList.add(&#39;btn-outline&#39;);
        listViewBtn.classList.remove(&#39;btn-primary&#39;);
    }
}

// 复制翻译数据
function copyTranslatedData(text) {
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            alert(&#39;英文安装数据已复制到剪贴板！&#39;);
        }).catch(() => {
            fallbackCopyExtractedData(text);
        });
    } else {
        fallbackCopyExtractedData(text);
    }
}

// 分享翻译数据
function shareTranslatedData(text) {
    if (navigator.share) {
        const fileName = `dwoody_english_data_${new Date().toISOString().split(&#39;T&#39;)[0]}.txt`;
        
        const blob = new Blob([text], { type: &#39;text/plain;charset=utf-8&#39; });
        const file = new File([blob], fileName, { type: &#39;text/plain&#39; });
        
        navigator.share({
            title: &#39;D WOODY HOME English Installation Data&#39;,
            text: &#39;English Installation Service Data Report&#39;,
            files: [file]
        }).then(() => {
            alert(&#39;英文数据分享成功！&#39;);
        }).catch((error) => {
            console.log(&#39;分享失败，使用复制功能:&#39;, error);
            copyTranslatedData(text);
        });
    } else {
        copyTranslatedData(text);
    }
}

// 复制单个翻译安装项目数据
function copyTranslatedInstallationData(index) {
    if (!window.currentTranslatedInstallations || !window.currentTranslatedInstallations[index]) {
        alert(&#39;数据不可用&#39;);
        return;
    }
    
    const inst = window.currentTranslatedInstallations[index];
    const fields = window.currentSelectedTranslateFields || [&#39;address&#39;, &#39;deliveryDate&#39;, &#39;installDate&#39;, &#39;lock&#39;, &#39;subcontractor&#39;, &#39;designer&#39;];
    
    // 计算上货日期
    let deliveryDateEn = &#39;Not filled&#39;;
    if (inst.installDate &amp;&amp; inst.installDate.trim()) {
        const installDate = parseDateString(inst.installDate);
        if (installDate) {
            const delivery = new Date(installDate);
            delivery.setDate(delivery.getDate() - 1);
            deliveryDateEn = delivery.toLocaleDateString(&#39;en-US&#39;);
        }
    }
    
    let installationText = `D WOODY HOME Installation Project ${index + 1}\n` +
        `Extract Time: ${new Date().toLocaleString(&#39;en-US&#39;)}\n` +
        `${&#39;=&#39;.repeat(30)}\n\n`;
    
    // 根据选中的字段生成内容
    if (fields.includes(&#39;address&#39;)) {
        installationText += `Address: ${inst.addressEn || &#39;Not filled&#39;}\n`;
    }
    if (fields.includes(&#39;deliveryDate&#39;)) {
        installationText += `Delivery Date: ${deliveryDateEn}\n`;
    }
    if (fields.includes(&#39;installDate&#39;)) {
        installationText += `Installation Date: ${inst.installDate ? new Date(inst.installDate).toLocaleDateString(&#39;en-US&#39;) : &#39;Not filled&#39;}\n`;
    }
    if (fields.includes(&#39;lock&#39;)) {
        installationText += `Lock Password: ${inst.lock || &#39;Not filled&#39;}\n`;
    }
    if (fields.includes(&#39;subcontractor&#39;)) {
        installationText += `Contractor: ${inst.subcontractorEn || &#39;Not filled&#39;}\n`;
    }
    if (fields.includes(&#39;designer&#39;)) {
        installationText += `Designer: ${inst.designerEn || &#39;Not filled&#39;}\n`;
    }
    
    installationText += `\nD WOODY HOME Professional Installation Service Management System`;
    
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(installationText).then(() => {
            alert(`项目 ${index + 1} 的英文数据已复制到剪贴板！`);
        }).catch(() => {
            fallbackCopyExtractedData(installationText);
        });
    } else {
        fallbackCopyExtractedData(installationText);
    }
}

// 分享单个翻译安装项目数据
function shareTranslatedInstallationData(index) {
    if (!window.currentTranslatedInstallations || !window.currentTranslatedInstallations[index]) {
        alert(&#39;数据不可用&#39;);
        return;
    }
    
    const inst = window.currentTranslatedInstallations[index];
    const fields = window.currentSelectedTranslateFields || [&#39;address&#39;, &#39;deliveryDate&#39;, &#39;installDate&#39;, &#39;lock&#39;, &#39;subcontractor&#39;, &#39;designer&#39;];
    
    // 计算上货日期
    let deliveryDateEn = &#39;Not filled&#39;;
    if (inst.installDate &amp;&amp; inst.installDate.trim()) {
        const installDate = parseDateString(inst.installDate);
        if (installDate) {
            const delivery = new Date(installDate);
            delivery.setDate(delivery.getDate() - 1);
            deliveryDateEn = delivery.toLocaleDateString(&#39;en-US&#39;);
        }
    }
    
    let installationText = `D WOODY HOME Installation Project ${index + 1}\n` +
        `Extract Time: ${new Date().toLocaleString(&#39;en-US&#39;)}\n` +
        `${&#39;=&#39;.repeat(30)}\n\n`;
    
    // 根据选中的字段生成内容
    if (fields.includes(&#39;address&#39;)) {
        installationText += `Address: ${inst.addressEn || &#39;Not filled&#39;}\n`;
    }
    if (fields.includes(&#39;deliveryDate&#39;)) {
        installationText += `Delivery Date: ${deliveryDateEn}\n`;
    }
    if (fields.includes(&#39;installDate&#39;)) {
        installationText += `Installation Date: ${inst.installDate ? new Date(inst.installDate).toLocaleDateString(&#39;en-US&#39;) : &#39;Not filled&#39;}\n`;
    }
    if (fields.includes(&#39;lock&#39;)) {
        installationText += `Lock Password: ${inst.lock || &#39;Not filled&#39;}\n`;
    }
    if (fields.includes(&#39;subcontractor&#39;)) {
        installationText += `Contractor: ${inst.subcontractorEn || &#39;Not filled&#39;}\n`;
    }
    if (fields.includes(&#39;designer&#39;)) {
        installationText += `Designer: ${inst.designerEn || &#39;Not filled&#39;}\n`;
    }
    
    installationText += `\nD WOODY HOME Professional Installation Service Management System`;
    
    if (navigator.share) {
        const fileName = `dwoody_english_project_${index + 1}_${new Date().toISOString().split(&#39;T&#39;)[0]}.txt`;
        
        const blob = new Blob([installationText], { type: &#39;text/plain;charset=utf-8&#39; });
        const file = new File([blob], fileName, { type: &#39;text/plain&#39; });
        
        navigator.share({
            title: `D WOODY HOME English Project ${index + 1}`,
            text: &#39;English Installation Project Details&#39;,
            files: [file]
        }).then(() => {
            alert(`项目 ${index + 1} 英文数据分享成功！`);
        }).catch((error) => {
            console.log(&#39;分享失败，使用复制功能:&#39;, error);
            copyTranslatedInstallationData(index);
        });
    } else {
        copyTranslatedInstallationData(index);
    }
}

// 导航功能
function openNavigation(address) {
    if (!address || address.trim() === &#39;&#39;) {
        alert(&#39;地址为空，无法导航&#39;);
        return;
    }
    
    // 检测设备类型和可用的导航应用
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    
    // 创建导航选择模态框
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-sm w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-info" data-icon="heroicons:map-pin" data-width="20"></span>
                    选择导航应用
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <div class="bg-info/10 border border-info/30 rounded-lg p-4 mb-4">
                <div class="text-sm text-info break-words">
                    <div class="font-medium mb-2">导航目的地：</div>
                    <div>${address}</div>
                </div>
            </div>
            
            <div class="space-y-3">
                <!-- Google Maps -->
                <button onclick="openGoogleMaps(&#39;${address.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                        class="btn btn-primary w-full flex items-center justify-start gap-3">
                    <span class="iconify text-white" data-icon="heroicons:globe-alt" data-width="20"></span>
                    <span class="text-sm">Google Maps</span>
                </button>
                
                ${isIOS ? `
                    <!-- Apple Maps (仅iOS) -->
                    <button onclick="openAppleMaps(&#39;${address.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-success w-full flex items-center justify-start gap-3">
                        <span class="iconify text-white" data-icon="heroicons:map" data-width="20"></span>
                        <span class="text-sm">Apple Maps</span>
                    </button>
                ` : &#39;&#39;}
                
                ${isMobile ? `
                    <!-- Waze -->
                    <button onclick="openWaze(&#39;${address.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-accent w-full flex items-center justify-start gap-3">
                        <span class="iconify text-white" data-icon="heroicons:bolt" data-width="20"></span>
                        <span class="text-sm">Waze</span>
                    </button>
                ` : &#39;&#39;}
                
                <!-- 复制地址用于其他导航应用 -->
                <button onclick="copyForNavigation(&#39;${address.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                        class="btn btn-outline w-full flex items-center justify-start gap-3">
                    <span class="iconify" data-icon="heroicons:clipboard" data-width="20"></span>
                    <span class="text-sm">复制地址到其他导航</span>
                </button>
            </div>
            
            <div class="mt-4 text-xs text-base-content/70 text-center">
                选择您偏好的导航应用来前往目的地
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// 打开 Google Maps
function openGoogleMaps(address) {
    const encodedAddress = encodeURIComponent(address);
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    let url;
    if (isMobile) {
        // 移动端：尝试打开 Google Maps 应用
        url = `https://maps.google.com/maps?q=${encodedAddress}&amp;navigate=yes`;
    } else {
        // 桌面端：打开 Google Maps 网页版
        url = `https://www.google.com/maps/search/${encodedAddress}`;
    }
    
    try {
        window.open(url, &#39;_blank&#39;);
        showNavigationSuccess(&#39;Google Maps&#39;, address);
    } catch (error) {
        console.error(&#39;打开 Google Maps 失败:&#39;, error);
        alert(&#39;无法打开 Google Maps，请检查网络连接或手动复制地址&#39;);
    }
}

// 打开 Apple Maps (仅iOS)
function openAppleMaps(address) {
    const encodedAddress = encodeURIComponent(address);
    const url = `http://maps.apple.com/?q=${encodedAddress}`;
    
    try {
        window.open(url, &#39;_blank&#39;);
        showNavigationSuccess(&#39;Apple Maps&#39;, address);
    } catch (error) {
        console.error(&#39;打开 Apple Maps 失败:&#39;, error);
        alert(&#39;无法打开 Apple Maps，请确保您使用的是 iOS 设备&#39;);
    }
}

// 打开 Waze
function openWaze(address) {
    const encodedAddress = encodeURIComponent(address);
    const url = `https://waze.com/ul?q=${encodedAddress}&amp;navigate=yes`;
    
    try {
        window.open(url, &#39;_blank&#39;);
        showNavigationSuccess(&#39;Waze&#39;, address);
    } catch (error) {
        console.error(&#39;打开 Waze 失败:&#39;, error);
        alert(&#39;无法打开 Waze，请确保已安装 Waze 应用&#39;);
    }
}

// 复制地址用于其他导航应用
function copyForNavigation(address) {
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(address).then(() => {
            alert(&#39;地址已复制到剪贴板！\n您可以粘贴到任何导航应用中使用。\n\n建议的导航应用：\n• Google Maps\n• Apple Maps\n• Waze\n• 百度地图\n• 高德地图&#39;);
        }).catch(() => {
            fallbackCopyForNavigation(address);
        });
    } else {
        fallbackCopyForNavigation(address);
    }
}

// 备用复制方法
function fallbackCopyForNavigation(address) {
    const textArea = document.createElement(&#39;textarea&#39;);
    textArea.value = address;
    textArea.style.position = &#39;fixed&#39;;
    textArea.style.left = &#39;-999999px&#39;;
    textArea.style.top = &#39;-999999px&#39;;
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand(&#39;copy&#39;);
        alert(&#39;地址已复制到剪贴板！\n您可以粘贴到任何导航应用中使用。&#39;);
    } catch (err) {
        alert(&#39;复制失败，请手动选择并复制地址：\n\n&#39; + address);
    }
    
    document.body.removeChild(textArea);
}

// 显示导航成功提示
function showNavigationSuccess(appName, address) {
    // 创建成功提示
    const toast = document.createElement(&#39;div&#39;);
    toast.className = &#39;fixed top-4 right-4 bg-success text-success-content rounded-lg p-4 shadow-lg z-50 max-w-sm&#39;;
    toast.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="iconify" data-icon="heroicons:check-circle" data-width="24"></span>
            <div>
                <div class="font-medium text-sm">导航已启动</div>
                <div class="text-xs opacity-90">正在使用 ${appName} 导航到目的地</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // 3秒后自动移除提示
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.transition = &#39;opacity 0.3s ease, transform 0.3s ease&#39;;
            toast.style.opacity = &#39;0&#39;;
            toast.style.transform = &#39;translateX(100%)&#39;;
            setTimeout(() => {
                if (toast.parentNode) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }
    }, 3000);
}

// 显示密码详情模态框
function showPasswordDetail(inputElement) {
    const password = inputElement.value.trim();
    const originalPassword = inputElement.getAttribute(&#39;data-original-password&#39;) || &#39;&#39;;
    const placeholder = inputElement.placeholder;
    
    // 如果密码被隐藏（显示为***），检查权限
    if (password === &#39;***&#39;) {
        // 在包工模式下，检查是否有权限查看此密码
        if (isContractorMode &amp;&amp; currentContractor) {
            const row = inputElement.closest(&#39;tr&#39;);
            const subcontractorInput = row.querySelector(&#39;input[type="text"]:nth-child(4)&#39;) || row.querySelectorAll(&#39;input[type="text"]&#39;)[3];
            const originalSubcontractor = subcontractorInput.getAttribute(&#39;data-original-value&#39;) || subcontractorInput.value;
            
            if (originalSubcontractor &amp;&amp; originalSubcontractor !== currentContractor &amp;&amp; originalSubcontractor !== &#39;&#39;) {
                alert(&#39;您只能查看自己负责的项目密码&#39;);
                return;
            }
        } else if (!isUnlocked &amp;&amp; !isContractorMode) {
            alert(&#39;此密码信息已隐藏，请先登录查看&#39;);
            return;
        }
    }
    
    // 获取实际密码值（如果被隐藏，使用原始值）
    const actualPassword = password === &#39;***&#39; ? originalPassword : password;
    
    // 获取对应的地址信息用于上下文
    const row = inputElement.closest(&#39;tr&#39;);
    const addressInput = row.querySelector(&#39;.address-input&#39;);
    const addressValue = addressInput ? (addressInput.value === &#39;***&#39; ? addressInput.getAttribute(&#39;data-original-value&#39;) || &#39;&#39; : addressInput.value) : &#39;&#39;;
    
    // 创建模态框
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-lg w-full max-h-96 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-warning" data-icon="heroicons:key" data-width="20"></span>
                    锁具密码详情
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <!-- 地址信息（上下文） -->
            ${addressValue ? `
                <div class="bg-base-200 rounded-lg p-3 mb-4">
                    <div class="text-sm text-base-content/70 mb-1">对应地址：</div>
                    <div class="text-sm font-medium break-words">${addressValue}</div>
                </div>
            ` : &#39;&#39;}
            
            <!-- 密码显示区域 -->
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="bg-warning/10 border border-warning/30 rounded-lg p-4">
                    <div class="text-sm text-base-content/70 mb-2">锁具密码：</div>
                    <div id="passwordDisplay" class="text-2xl font-mono font-bold text-center py-4 px-2 bg-base-100 rounded-lg border-2 border-dashed border-warning/50 ${!actualPassword ? &#39;text-base-content/50 italic&#39; : &#39;text-warning tracking-widest&#39;}" 
                         style="word-wrap: break-word; overflow-wrap: break-word; letter-spacing: 0.2em;">
                        ${actualPassword || &#39;暂无密码信息&#39;}
                    </div>
                </div>
            </div>
            
            <!-- 编辑区域（仅解锁时显示） -->
            ${isUnlocked ? `
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text text-sm font-medium">编辑密码：</span>
                    </label>
                    <input id="passwordEditor" 
                           type="text" 
                           class="input input-bordered w-full text-lg font-mono text-center tracking-widest" 
                           placeholder="${placeholder}"
                           value="${actualPassword}"
                           style="letter-spacing: 0.2em;" />
                    <div class="text-xs text-base-content/70 mt-2">
                        建议使用数字密码，便于记忆和输入
                    </div>
                </div>
            ` : &#39;&#39;}
            
            <!-- 操作按钮 -->
            <div class="flex gap-2 flex-wrap">
                ${actualPassword ? `
                    <button onclick="copyPasswordToClipboard(&#39;${actualPassword.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-warning flex-1 min-w-32">
                        <span class="iconify" data-icon="heroicons:clipboard" data-width="16"></span>
                        复制密码
                    </button>
                ` : &#39;&#39;}
                
                ${isUnlocked ? `
                    <button onclick="savePasswordFromModal(this); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-success flex-1 min-w-32"
                            data-input-element="${getPasswordElementIndex(inputElement)}">
                        <span class="iconify" data-icon="heroicons:check" data-width="16"></span>
                        保存修改
                    </button>
                ` : &#39;&#39;}
                
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline min-w-24">
                    关闭
                </button>
            </div>
            
            <!-- 安全提示 -->
            <div class="mt-4 bg-info/10 border border-info/30 rounded-lg p-3">
                <div class="flex items-center gap-2 mb-2">
                    <span class="iconify text-info" data-icon="heroicons:shield-check" data-width="16"></span>
                    <span class="text-sm font-medium text-info">安全提示</span>
                </div>
                <div class="text-xs text-info">
                    <div>• 请妥善保管锁具密码，避免泄露</div>
                    <div>• 建议定期更换密码确保安全</div>
                    <div>• 复制密码后请及时清除剪贴板</div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 如果是解锁状态，聚焦到编辑框
    if (isUnlocked) {
        setTimeout(() => {
            const editor = document.getElementById(&#39;passwordEditor&#39;);
            if (editor) {
                editor.focus();
                editor.setSelectionRange(editor.value.length, editor.value.length);
            }
        }, 100);
    }
}

// 获取密码元素在表格中的索引
function getPasswordElementIndex(element) {
    const allPasswordInputs = document.querySelectorAll(&#39;.password-field&#39;);
    return Array.from(allPasswordInputs).indexOf(element);
}

// 从模态框保存密码
function savePasswordFromModal(button) {
    const inputIndex = parseInt(button.getAttribute(&#39;data-input-element&#39;));
    const editor = document.getElementById(&#39;passwordEditor&#39;);
    const allPasswordInputs = document.querySelectorAll(&#39;.password-field&#39;);
    
    if (editor &amp;&amp; allPasswordInputs[inputIndex]) {
        const newPassword = editor.value.trim();
        const targetInput = allPasswordInputs[inputIndex];
        
        // 更新输入框值和原始密码属性
        targetInput.value = newPassword;
        targetInput.setAttribute(&#39;data-original-password&#39;, newPassword);
        
        // 高亮显示已更新的输入框
        targetInput.style.backgroundColor = &#39;rgba(245, 158, 11, 0.2)&#39;;
        setTimeout(() => {
            targetInput.style.backgroundColor = &#39;&#39;;
        }, 2000);
        
        // 如果在日历视图，更新日历数据
        if (currentView === &#39;calendar&#39;) {
            updateCalendarData();
        }
        
        alert(&#39;密码已更新&#39;);
    }
}

// 复制密码到剪贴板
function copyPasswordToClipboard(password) {
    if (!password || password.trim() === &#39;&#39;) {
        alert(&#39;密码为空，无法复制&#39;);
        return;
    }
    
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(password).then(() => {
            alert(&#39;密码已复制到剪贴板！\n\n⚠️ 安全提醒：\n• 请妥善使用复制的密码\n• 使用完毕后建议清除剪贴板\n• 避免在不安全的环境下粘贴&#39;);
        }).catch(() => {
            fallbackCopyPassword(password);
        });
    } else {
        fallbackCopyPassword(password);
    }
}

// 备用密码复制方法
function fallbackCopyPassword(password) {
    const textArea = document.createElement(&#39;textarea&#39;);
    textArea.value = password;
    textArea.style.position = &#39;fixed&#39;;
    textArea.style.left = &#39;-999999px&#39;;
    textArea.style.top = &#39;-999999px&#39;;
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand(&#39;copy&#39;);
        alert(&#39;密码已复制到剪贴板！\n\n⚠️ 安全提醒：请妥善使用复制的密码&#39;);
    } catch (err) {
        alert(&#39;复制失败，请手动选择并复制密码。&#39;);
    }
    
document.body.removeChild(textArea);
}

// 显示包工详情模态框
function showSubcontractorDetail(inputElement) {
    const subcontractor = inputElement.value.trim();
    const originalSubcontractor = inputElement.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
    const placeholder = inputElement.placeholder;
    
    // 如果包工被隐藏（显示为***），检查权限
    if (subcontractor === &#39;***&#39;) {
        if (!isUnlocked &amp;&amp; !isContractorMode) {
            alert(&#39;此包工信息已隐藏，请先登录查看&#39;);
            return;
        }
    }
    
    // 获取实际包工值（如果被隐藏，使用原始值）
    const actualSubcontractor = subcontractor === &#39;***&#39; ? originalSubcontractor : subcontractor;
    
    // 获取对应的地址和安装日期信息用于上下文
    const row = inputElement.closest(&#39;tr&#39;);
    const addressInput = row.querySelector(&#39;.address-input&#39;);
    const installDateInput = row.querySelectorAll(&#39;input[type="text"]&#39;)[2];
    const addressValue = addressInput ? (addressInput.value === &#39;***&#39; ? addressInput.getAttribute(&#39;data-original-value&#39;) || &#39;&#39; : addressInput.value) : &#39;&#39;;
    const installDateValue = installDateInput ? installDateInput.value : &#39;&#39;;
    
    // 创建模态框
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-lg w-full max-h-96 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-accent" data-icon="heroicons:user-group" data-width="20"></span>
                    包工详情
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <!-- 项目信息（上下文） -->
            ${addressValue || installDateValue ? `
                <div class="bg-base-200 rounded-lg p-3 mb-4">
                    <div class="text-sm text-base-content/70 mb-2">项目信息：</div>
                    ${addressValue ? `<div class="text-sm break-words mb-1"><span class="font-medium">地址：</span>${addressValue}</div>` : &#39;&#39;}
                    ${installDateValue &amp;&amp; installDateValue !== &#39;***&#39; ? `<div class="text-sm"><span class="font-medium">安装日期：</span>${installDateValue}</div>` : &#39;&#39;}
                </div>
            ` : &#39;&#39;}
            
            <!-- 包工显示区域 -->
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="bg-accent/10 border border-accent/30 rounded-lg p-4">
                    <div class="text-sm text-base-content/70 mb-2">负责包工：</div>
                    <div id="subcontractorDisplay" class="text-xl font-semibold text-center py-3 px-2 bg-base-100 rounded-lg border-2 border-dashed border-accent/50 ${!actualSubcontractor ? &#39;text-base-content/50 italic&#39; : &#39;text-accent&#39;}" 
                         style="word-wrap: break-word; overflow-wrap: break-word;">
                        ${actualSubcontractor || &#39;暂无包工信息&#39;}
                    </div>
                </div>
                
                <!-- 包工统计信息 -->
                ${actualSubcontractor ? `
                    <div class="mt-4 bg-info/10 border border-info/30 rounded-lg p-3">
                        <div class="text-sm font-medium text-info mb-2">包工统计</div>
                        <div id="subcontractorStats" class="text-sm text-info">
                            正在统计 "${actualSubcontractor}" 的项目数量...
                        </div>
                    </div>
                ` : &#39;&#39;}
            </div>
            
            <!-- 编辑区域（仅解锁时显示） -->
            ${isUnlocked ? `
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text text-sm font-medium">选择或编辑包工：</span>
                    </label>
                    <div class="flex gap-2 mb-2">
                        <select id="subcontractorSelect" class="select select-bordered flex-1 text-sm" onchange="updateSubcontractorEditor()">
                            <option value="">选择现有包工</option>
                            ${contractorList.map(name => `<option value="${name}" ${name === actualSubcontractor ? &#39;selected&#39; : &#39;&#39;}>${name}</option>`).join(&#39;&#39;)}
                        </select>
                    </div>
                    <input id="subcontractorEditor" 
                           type="text" 
                           class="input input-bordered w-full text-sm" 
                           placeholder="${placeholder}"
                           value="${actualSubcontractor}"
                           maxlength="20" />
                    <div class="text-xs text-base-content/70 mt-2">
                        可以从下拉列表选择现有包工，或直接输入新的包工名字
                    </div>
                </div>
            ` : &#39;&#39;}
            
            <!-- 操作按钮 -->
            <div class="flex gap-2 flex-wrap">
                ${actualSubcontractor ? `
                    <button onclick="copySubcontractorToClipboard(&#39;${actualSubcontractor.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-accent flex-1 min-w-32">
                        <span class="iconify" data-icon="heroicons:clipboard" data-width="16"></span>
                        复制包工
                    </button>
                    <button onclick="filterBySubcontractor(&#39;${actualSubcontractor.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-info flex-1 min-w-32">
                        <span class="iconify" data-icon="heroicons:funnel" data-width="16"></span>
                        筛选此包工
                    </button>
                ` : &#39;&#39;}
                
                ${isUnlocked ? `
                    <button onclick="saveSubcontractorFromModal(this); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-success flex-1 min-w-32"
                            data-input-element="${getSubcontractorElementIndex(inputElement)}">
                        <span class="iconify" data-icon="heroicons:check" data-width="16"></span>
                        保存修改
                    </button>
                ` : &#39;&#39;}
                
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline min-w-24">
                    关闭
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 如果有包工信息，计算统计数据
    if (actualSubcontractor) {
        setTimeout(() => {
            calculateSubcontractorStats(actualSubcontractor);
        }, 100);
    }
    
    // 如果是解锁状态，聚焦到编辑框
    if (isUnlocked) {
        setTimeout(() => {
            const editor = document.getElementById(&#39;subcontractorEditor&#39;);
            if (editor) {
                editor.focus();
                editor.setSelectionRange(editor.value.length, editor.value.length);
            }
        }, 100);
    }
}

// 更新包工编辑器
function updateSubcontractorEditor() {
    const select = document.getElementById(&#39;subcontractorSelect&#39;);
    const editor = document.getElementById(&#39;subcontractorEditor&#39;);
    
    if (select &amp;&amp; editor) {
        if (select.value) {
            editor.value = select.value;
        }
    }
}

// 计算包工统计信息
function calculateSubcontractorStats(subcontractorName) {
    const statsElement = document.getElementById(&#39;subcontractorStats&#39;);
    if (!statsElement) return;
    
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    let totalProjects = 0;
    let completedProjects = 0;
    let pendingProjects = 0;
    
    tableRows.forEach(row => {
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        if (inputs.length >= 5) {
            const subcontractorInput = inputs[3];
            const designerInput = inputs[4];
            
            // 获取原始值或当前值
            const rowSubcontractor = subcontractorInput.getAttribute(&#39;data-original-value&#39;) || subcontractorInput.value;
            const designer = designerInput.getAttribute(&#39;data-original-value&#39;) || designerInput.value;
            
            if (rowSubcontractor === subcontractorName) {
                totalProjects++;
                if (designer &amp;&amp; designer.trim() &amp;&amp; designer !== &#39;***&#39;) {
                    completedProjects++;
                } else {
                    pendingProjects++;
                }
            }
        }
    });
    
    statsElement.innerHTML = `
        <div>总项目数：<span class="font-medium">${totalProjects}</span></div>
        <div>已完成：<span class="font-medium text-success">${completedProjects}</span></div>
        <div>进行中：<span class="font-medium text-warning">${pendingProjects}</span></div>
    `;
}

// 获取包工元素在表格中的索引
function getSubcontractorElementIndex(element) {
    const allSubcontractorInputs = document.querySelectorAll(&#39;.subcontractor-input&#39;);
    return Array.from(allSubcontractorInputs).indexOf(element);
}

// 从模态框保存包工
function saveSubcontractorFromModal(button) {
    const inputIndex = parseInt(button.getAttribute(&#39;data-input-element&#39;));
    const editor = document.getElementById(&#39;subcontractorEditor&#39;);
    const allSubcontractorInputs = document.querySelectorAll(&#39;.subcontractor-input&#39;);
    
    if (editor &amp;&amp; allSubcontractorInputs[inputIndex]) {
        const newSubcontractor = editor.value.trim();
        const targetInput = allSubcontractorInputs[inputIndex];
        
        // 更新输入框值和原始值属性
        targetInput.value = newSubcontractor;
        targetInput.setAttribute(&#39;data-original-value&#39;, newSubcontractor);
        
        // 高亮显示已更新的输入框
        targetInput.style.backgroundColor = &#39;rgba(59, 130, 246, 0.2)&#39;;
        setTimeout(() => {
            targetInput.style.backgroundColor = &#39;&#39;;
        }, 2000);
        
        // 如果在日历视图，更新日历数据
        if (currentView === &#39;calendar&#39;) {
            updateCalendarData();
        }
        
        alert(&#39;包工信息已更新&#39;);
    }
}

// 复制包工到剪贴板
function copySubcontractorToClipboard(subcontractor) {
    if (!subcontractor || subcontractor.trim() === &#39;&#39;) {
        alert(&#39;包工信息为空，无法复制&#39;);
        return;
    }
    
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(subcontractor).then(() => {
            alert(&#39;包工信息已复制到剪贴板！&#39;);
        }).catch(() => {
            fallbackCopySubcontractor(subcontractor);
        });
    } else {
        fallbackCopySubcontractor(subcontractor);
    }
}

// 备用包工复制方法
function fallbackCopySubcontractor(subcontractor) {
    const textArea = document.createElement(&#39;textarea&#39;);
    textArea.value = subcontractor;
    textArea.style.position = &#39;fixed&#39;;
    textArea.style.left = &#39;-999999px&#39;;
    textArea.style.top = &#39;-999999px&#39;;
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand(&#39;copy&#39;);
        alert(&#39;包工信息已复制到剪贴板！&#39;);
    } catch (err) {
        alert(&#39;复制失败，请手动选择并复制包工信息。&#39;);
    }
    
    document.body.removeChild(textArea);
}

// 按包工筛选
function filterBySubcontractor(subcontractorName) {
    const quickFilter = document.getElementById(&#39;quickFilter&#39;);
    if (quickFilter) {
        // 检查该包工是否在筛选选项中
        const option = Array.from(quickFilter.options).find(opt => opt.value === subcontractorName);
        if (option) {
            quickFilter.value = subcontractorName;
            applyQuickFilter();
            alert(`已筛选显示包工 "${subcontractorName}" 的所有项目`);
        } else {
            alert(`包工 "${subcontractorName}" 不在筛选选项中，请检查包工名单设置`);
        }
    }
}

// 显示收工详情模态框
function showDesignerDetail(inputElement) {
    const designer = inputElement.value.trim();
    const originalDesigner = inputElement.getAttribute(&#39;data-original-value&#39;) || &#39;&#39;;
    const placeholder = inputElement.placeholder;
    
    // 如果收工被隐藏（显示为***），检查权限
    if (designer === &#39;***&#39;) {
        if (!isUnlocked &amp;&amp; !isContractorMode) {
            alert(&#39;此收工信息已隐藏，请先登录查看&#39;);
            return;
        }
    }
    
    // 获取实际收工值（如果被隐藏，使用原始值）
    const actualDesigner = designer === &#39;***&#39; ? originalDesigner : designer;
    
    // 获取对应的地址、安装日期和包工信息用于上下文
    const row = inputElement.closest(&#39;tr&#39;);
    const addressInput = row.querySelector(&#39;.address-input&#39;);
    const installDateInput = row.querySelectorAll(&#39;input[type="text"]&#39;)[2];
    const subcontractorInput = row.querySelector(&#39;.subcontractor-input&#39;);
    const addressValue = addressInput ? (addressInput.value === &#39;***&#39; ? addressInput.getAttribute(&#39;data-original-value&#39;) || &#39;&#39; : addressInput.value) : &#39;&#39;;
    const installDateValue = installDateInput ? installDateInput.value : &#39;&#39;;
    const subcontractorValue = subcontractorInput ? (subcontractorInput.value === &#39;***&#39; ? subcontractorInput.getAttribute(&#39;data-original-value&#39;) || &#39;&#39; : subcontractorInput.value) : &#39;&#39;;
    
    // 创建模态框
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-lg w-full max-h-96 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-secondary" data-icon="heroicons:user" data-width="20"></span>
                    收工详情
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <!-- 项目信息（上下文） -->
            ${addressValue || installDateValue || subcontractorValue ? `
                <div class="bg-base-200 rounded-lg p-3 mb-4">
                    <div class="text-sm text-base-content/70 mb-2">项目信息：</div>
                    ${addressValue ? `<div class="text-sm break-words mb-1"><span class="font-medium">地址：</span>${addressValue}</div>` : &#39;&#39;}
                    ${installDateValue &amp;&amp; installDateValue !== &#39;***&#39; ? `<div class="text-sm mb-1"><span class="font-medium">安装日期：</span>${installDateValue}</div>` : &#39;&#39;}
                    ${subcontractorValue &amp;&amp; subcontractorValue !== &#39;***&#39; ? `<div class="text-sm"><span class="font-medium">包工：</span>${subcontractorValue}</div>` : &#39;&#39;}
                </div>
            ` : &#39;&#39;}
            
            <!-- 收工显示区域 -->
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="bg-secondary/10 border border-secondary/30 rounded-lg p-4">
                    <div class="text-sm text-base-content/70 mb-2">负责收工：</div>
                    <div id="designerDisplay" class="text-xl font-semibold text-center py-3 px-2 bg-base-100 rounded-lg border-2 border-dashed border-secondary/50 ${!actualDesigner ? &#39;text-base-content/50 italic&#39; : &#39;text-secondary&#39;}" 
                         style="word-wrap: break-word; overflow-wrap: break-word;">
                        ${actualDesigner || &#39;暂无收工信息&#39;}
                    </div>
                </div>
                
                <!-- 收工统计信息 -->
                ${actualDesigner ? `
                    <div class="mt-4 bg-info/10 border border-info/30 rounded-lg p-3">
                        <div class="text-sm font-medium text-info mb-2">收工统计</div>
                        <div id="designerStats" class="text-sm text-info">
                            正在统计 "${actualDesigner}" 的项目数量...
                        </div>
                    </div>
                ` : &#39;&#39;}
                
                <!-- 项目状态 -->
                <div class="mt-4 bg-success/10 border border-success/30 rounded-lg p-3">
                    <div class="text-sm font-medium text-success mb-2">项目状态</div>
                    <div class="text-sm text-success">
                        ${actualDesigner ? 
                            &#39;<div class="flex items-center gap-2"><span class="iconify text-success" data-icon="heroicons:check-circle" data-width="16"></span>项目已完成收工</div>&#39; : 
                            &#39;<div class="flex items-center gap-2"><span class="iconify text-warning" data-icon="heroicons:clock" data-width="16"></span>项目进行中，待收工</div>&#39;
                        }
                    </div>
                </div>
            </div>
            
            <!-- 编辑区域（仅解锁时显示） -->
            ${isUnlocked ? `
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text text-sm font-medium">编辑收工：</span>
                    </label>
                    <input id="designerEditor" 
                           type="text" 
                           class="input input-bordered w-full text-sm" 
                           placeholder="${placeholder}"
                           value="${actualDesigner}"
                           maxlength="20" />
                    <div class="text-xs text-base-content/70 mt-2">
                        输入负责收工的人员姓名
                    </div>
                </div>
            ` : &#39;&#39;}
            
            <!-- 操作按钮 -->
            <div class="flex gap-2 flex-wrap">
                ${actualDesigner ? `
                    <button onclick="copyDesignerToClipboard(&#39;${actualDesigner.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-secondary flex-1 min-w-32">
                        <span class="iconify" data-icon="heroicons:clipboard" data-width="16"></span>
                        复制收工
                    </button>
                    <button onclick="filterByDesigner(&#39;${actualDesigner.replace(/&#39;/g, "\\&#39;")}&#39;); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-info flex-1 min-w-32">
                        <span class="iconify" data-icon="heroicons:funnel" data-width="16"></span>
                        查看相关项目
                    </button>
                ` : &#39;&#39;}
                
                ${isUnlocked ? `
                    <button onclick="saveDesignerFromModal(this); this.closest(&#39;.fixed&#39;).remove();" 
                            class="btn btn-success flex-1 min-w-32"
                            data-input-element="${getDesignerElementIndex(inputElement)}">
                        <span class="iconify" data-icon="heroicons:check" data-width="16"></span>
                        保存修改
                    </button>
                ` : &#39;&#39;}
                
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline min-w-24">
                    关闭
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 如果有收工信息，计算统计数据
    if (actualDesigner) {
        setTimeout(() => {
            calculateDesignerStats(actualDesigner);
        }, 100);
    }
    
    // 如果是解锁状态，聚焦到编辑框
    if (isUnlocked) {
        setTimeout(() => {
            const editor = document.getElementById(&#39;designerEditor&#39;);
            if (editor) {
                editor.focus();
                editor.setSelectionRange(editor.value.length, editor.value.length);
            }
        }, 100);
    }
}

// 计算收工统计信息
function calculateDesignerStats(designerName) {
    const statsElement = document.getElementById(&#39;designerStats&#39;);
    if (!statsElement) return;
    
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    let totalProjects = 0;
    let recentProjects = 0;
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    tableRows.forEach(row => {
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        if (inputs.length >= 5) {
            const designerInput = inputs[4];
            const installDateInput = inputs[2];
            
            // 获取原始值或当前值
            const rowDesigner = designerInput.getAttribute(&#39;data-original-value&#39;) || designerInput.value;
            const installDate = installDateInput.getAttribute(&#39;data-original-value&#39;) || installDateInput.value;
            
            if (rowDesigner === designerName) {
                totalProjects++;
                
                // 检查是否为本月项目
                if (installDate &amp;&amp; installDate.trim() &amp;&amp; installDate !== &#39;***&#39;) {
                    const projectDate = parseDateString(installDate);
                    if (projectDate &amp;&amp; 
                        projectDate.getMonth() === currentMonth &amp;&amp; 
                        projectDate.getFullYear() === currentYear) {
                        recentProjects++;
                    }
                }
            }
        }
    });
    
    statsElement.innerHTML = `
        <div>总收工项目：<span class="font-medium">${totalProjects}</span></div>
        <div>本月收工：<span class="font-medium text-success">${recentProjects}</span></div>
        ${totalProjects > 0 ? `<div class="mt-2 text-xs">平均每月收工约 ${Math.ceil(totalProjects / 12)} 个项目</div>` : &#39;&#39;}
    `;
}

// 获取收工元素在表格中的索引
function getDesignerElementIndex(element) {
    const allDesignerInputs = document.querySelectorAll(&#39;.designer-input&#39;);
    return Array.from(allDesignerInputs).indexOf(element);
}

// 从模态框保存收工
function saveDesignerFromModal(button) {
    const inputIndex = parseInt(button.getAttribute(&#39;data-input-element&#39;));
    const editor = document.getElementById(&#39;designerEditor&#39;);
    const allDesignerInputs = document.querySelectorAll(&#39;.designer-input&#39;);
    
    if (editor &amp;&amp; allDesignerInputs[inputIndex]) {
        const newDesigner = editor.value.trim();
        const targetInput = allDesignerInputs[inputIndex];
        
        // 更新输入框值和原始值属性
        targetInput.value = newDesigner;
        targetInput.setAttribute(&#39;data-original-value&#39;, newDesigner);
        
        // 高亮显示已更新的输入框
        targetInput.style.backgroundColor = &#39;rgba(168, 85, 247, 0.2)&#39;;
        setTimeout(() => {
            targetInput.style.backgroundColor = &#39;&#39;;
        }, 2000);
        
        // 如果在日历视图，更新日历数据
        if (currentView === &#39;calendar&#39;) {
            updateCalendarData();
        }
        
        alert(&#39;收工信息已更新&#39;);
    }
}

// 复制收工到剪贴板
function copyDesignerToClipboard(designer) {
    if (!designer || designer.trim() === &#39;&#39;) {
        alert(&#39;收工信息为空，无法复制&#39;);
        return;
    }
    
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(designer).then(() => {
            alert(&#39;收工信息已复制到剪贴板！&#39;);
        }).catch(() => {
            fallbackCopyDesigner(designer);
        });
    } else {
        fallbackCopyDesigner(designer);
    }
}

// 备用收工复制方法
function fallbackCopyDesigner(designer) {
    const textArea = document.createElement(&#39;textarea&#39;);
    textArea.value = designer;
    textArea.style.position = &#39;fixed&#39;;
    textArea.style.left = &#39;-999999px&#39;;
    textArea.style.top = &#39;-999999px&#39;;
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand(&#39;copy&#39;);
        alert(&#39;收工信息已复制到剪贴板！&#39;);
    } catch (err) {
        alert(&#39;复制失败，请手动选择并复制收工信息。&#39;);
    }
    
    document.body.removeChild(textArea);
}

// 按收工筛选相关项目
function filterByDesigner(designerName) {
    // 显示该收工负责的所有项目
    const tableRows = document.querySelectorAll(&#39;.table tbody tr&#39;);
    let matchingProjects = [];
    
    tableRows.forEach((row, index) => {
        const inputs = row.querySelectorAll(&#39;input[type="text"]&#39;);
        if (inputs.length >= 5) {
            const designerInput = inputs[4];
            const addressInput = inputs[0];
            const installDateInput = inputs[2];
            
            // 获取原始值或当前值
            const rowDesigner = designerInput.getAttribute(&#39;data-original-value&#39;) || designerInput.value;
            const address = addressInput.getAttribute(&#39;data-original-value&#39;) || addressInput.value;
            const installDate = installDateInput.getAttribute(&#39;data-original-value&#39;) || installDateInput.value;
            
            if (rowDesigner === designerName) {
                matchingProjects.push({
                    index: index + 1,
                    address: address || &#39;未填写地址&#39;,
                    installDate: installDate || &#39;未填写日期&#39;
                });
            }
        }
    });
    
    if (matchingProjects.length === 0) {
        alert(`收工 "${designerName}" 暂无相关项目`);
        return;
    }
    
    // 创建项目列表模态框
    const modal = document.createElement(&#39;div&#39;);
    modal.className = &#39;fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4&#39;;
    modal.innerHTML = `
        <div class="bg-base-100 rounded-lg p-6 max-w-lg w-full max-h-96 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span class="iconify text-secondary" data-icon="heroicons:user" data-width="20"></span>
                    ${designerName} 的收工项目
                </h3>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-sm btn-circle">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            </div>
            
            <div class="bg-secondary/10 border border-secondary/30 rounded-lg p-4 mb-4">
                <div class="text-sm text-secondary">
                    找到 <span class="font-medium">${matchingProjects.length}</span> 个由 "${designerName}" 负责收工的项目
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="space-y-3">
                    ${matchingProjects.map(project => `
                        <div class="bg-base-200 rounded-lg p-3 border border-base-300">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-medium text-sm text-primary">项目 ${project.index}</div>
                                <div class="text-xs text-base-content/70">${project.installDate}</div>
                            </div>
                            <div class="text-sm break-words">${project.address}</div>
                        </div>
                    `).join(&#39;&#39;)}
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="copyDesignerProjectList(&#39;${designerName.replace(/&#39;/g, "\\&#39;")}&#39;, ${JSON.stringify(matchingProjects).replace(/"/g, &#39;&amp;quot;&#39;)}); this.closest(&#39;.fixed&#39;).remove();" 
                        class="btn btn-primary flex-1">
                    <span class="iconify" data-icon="heroicons:clipboard" data-width="16"></span>
                    复制项目列表
                </button>
                <button onclick="this.closest(&#39;.fixed&#39;).remove()" class="btn btn-outline">关闭</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// 复制收工项目列表
function copyDesignerProjectList(designerName, projects) {
    let projectText = `收工 "${designerName}" 的项目列表\n`;
    projectText += `统计时间：${new Date().toLocaleString(&#39;zh-CN&#39;)}\n`;
    projectText += `总项目数：${projects.length}\n`;
    projectText += `${&#39;=&#39;.repeat(30)}\n\n`;
    
    projects.forEach(project => {
        projectText += `项目 ${project.index}：\n`;
        projectText += `地址：${project.address}\n`;
        projectText += `安装日期：${project.installDate}\n`;
        projectText += `${&#39;-&#39;.repeat(20)}\n`;
    });
    
    projectText += `\nD WOODY HOME 专业安装服务管理系统`;
    
    if (navigator.clipboard &amp;&amp; navigator.clipboard.writeText) {
        navigator.clipboard.writeText(projectText).then(() => {
            alert(`收工 "${designerName}" 的项目列表已复制到剪贴板！`);
        }).catch(() => {
            fallbackCopyDesigner(projectText);
        });
    } else {
        fallbackCopyDesigner(projectText);
    }
}
</script>
  

<script>
    setTimeout(() => {
      Holder.run({
        domain: "placehold.co"
      })
    }, 100)
  </script></body></html>'></iframe>
                    </div>
                  </div>

                </body>
                </html>
            